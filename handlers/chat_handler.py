"""
–û–±—Ä–æ–±–Ω–∏–∫ —á–∞—Ç—É –∑ AI
"""
from aiogram import Router, F
from aiogram.types import Message
from database import db
from ollama_client import ollama
from knowledge_base import (
    get_knu_contacts,
    get_faculties_list,
    get_faculty_specialties,
    search_admission_2026_by_keyword,
    get_admission_2026_info,
)
from keyboards import (
    get_main_menu, get_specializations_keyboard, 
    get_back_keyboard, get_settings_keyboard,
    get_feedback_keyboard, get_reminders_management_keyboard,
    get_quick_actions_keyboard, get_faculties_keyboard
)
from services.response_service import ResponseService
from utils.message_parser import MessageParser
from handlers.utils import _agent_log, _format_admission_2026, _check_and_fix_forbidden_universities, _convert_markdown_to_html
from datetime import datetime
import asyncio
import logging
import json
import time
import re

logger = logging.getLogger(__name__)

router = Router()

# –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è —Å–µ—Ä–≤—ñ—Å—ñ–≤
response_service = ResponseService()
message_parser = MessageParser()


@router.message()
async def chat_handler(message: Message):
    """–û–±—Ä–æ–±–∫–∞ –∑–≤–∏—á–∞–π–Ω–∏—Ö –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å (—á–∞—Ç –∑ AI)"""
    user_message = message.text
    # region agent log
    _agent_log(
        hypothesis_id="H0",
        location="handlers/chat_handler.py:chat_handler:entry",
        message="chat entry",
        data={"user_message": (user_message or "")[:200]}
    )
    # endregion
    
    # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ —Ü–µ –Ω–µ –∫–æ–º–∞–Ω–¥–∞
    if not user_message or user_message.startswith("/"):
        return
    
    # –°–ø–∏—Å–æ–∫ –∫–Ω–æ–ø–æ–∫ –º–µ–Ω—é, —è–∫—ñ –Ω–µ –ø–æ–≤–∏–Ω–Ω—ñ –æ–±—Ä–æ–±–ª—è—Ç–∏—Å—è —è–∫ –ø–∏—Ç–∞–Ω–Ω—è
    menu_buttons = [
        # –ì–æ–ª–æ–≤–Ω–µ –º–µ–Ω—é
        "üìö –ü–æ—Ä–∞–¥–∏", "üìö –ü–æ—Ä–∞–¥–∏ —â–æ–¥–æ –≤—Å—Ç—É–ø—É",
        "üìÑ –î–æ–∫—É–º–µ–Ω—Ç–∏", "üìÑ –°–ø–∏—Å–æ–∫ –¥–æ–∫—É–º–µ–Ω—Ç—ñ–≤",
        "üìû –ö–æ–Ω—Ç–∞–∫—Ç–∏", "üìû –ö–æ–Ω—Ç–∞–∫—Ç–∏ –•–î–£",
        "‚è∞ –ù–∞–≥–∞–¥—É–≤–∞–Ω–Ω—è", "‚è∞ –ú–æ—ó –Ω–∞–≥–∞–¥—É–≤–∞–Ω–Ω—è",
        "üí¨ –ó–∞–¥–∞—Ç–∏ –ø–∏—Ç–∞–Ω–Ω—è",
        "üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞",
        "‚öôÔ∏è –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è",
        # –ù–∞–≤—ñ–≥–∞—Ü—ñ—è
        "‚¨ÖÔ∏è –ù–∞–∑–∞–¥",
        "üè† –ì–æ–ª–æ–≤–Ω–µ –º–µ–Ω—é",
        # –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è
        "üéØ –°–ø–µ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è", "üéØ –ó–º—ñ–Ω–∏—Ç–∏ —Å–ø–µ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—é",
        "üîî –ù–∞–≥–∞–¥—É–≤–∞–Ω–Ω—è", "üîî –£–≤—ñ–º–∫–Ω—É—Ç–∏/–≤–∏–º–∫–Ω—É—Ç–∏ –Ω–∞–≥–∞–¥—É–≤–∞–Ω–Ω—è",
        "üìú –Ü—Å—Ç–æ—Ä—ñ—è",
        # –ù–∞–≥–∞–¥—É–≤–∞–Ω–Ω—è
        "‚ûï –°—Ç–≤–æ—Ä–∏—Ç–∏", "‚ûï –°—Ç–≤–æ—Ä–∏—Ç–∏ –Ω–∞–≥–∞–¥—É–≤–∞–Ω–Ω—è",
        "üìã –°–ø–∏—Å–æ–∫", "üìã –ú–æ—ó –Ω–∞–≥–∞–¥—É–≤–∞–Ω–Ω—è",
        # –°–ø–µ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó
        "üíª IT", "üíª –Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ–π–Ω—ñ —Ç–µ—Ö–Ω–æ–ª–æ–≥—ñ—ó",
        "üè• –ú–µ–¥–∏—Ü–∏–Ω–∞",
        "‚öñÔ∏è –ü—Ä–∞–≤–æ",
        "üí∞ –ï–∫–æ–Ω–æ–º—ñ–∫–∞",
        "üéì –ü–µ–¥–∞–≥–æ–≥—ñ–∫–∞",
        "üî¨ –ü—Ä–∏—Ä–æ–¥–Ω–∏—á—ñ –Ω–∞—É–∫–∏",
        "üìù –Ü–Ω—à–∞", "üìù –Ü–Ω—à–∞ —Å–ø–µ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è",
        # –®–≤–∏–¥–∫—ñ –¥—ñ—ó
        "üí¨ –Ü–Ω—à–µ –ø–∏—Ç–∞–Ω–Ω—è"
    ]
    
    # –Ø–∫—â–æ —Ü–µ –∫–Ω–æ–ø–∫–∞ –º–µ–Ω—é, –Ω–µ –æ–±—Ä–æ–±–ª—è—î–º–æ —è–∫ –ø–∏—Ç–∞–Ω–Ω—è
    if user_message in menu_buttons:
        return
    
    # –û–±—Ä–æ–±–∫–∞ –ø—Ä–∏–≤—ñ—Ç–∞–Ω—å —Ç–∞ –ø—Ä–æ—Å—Ç–∏—Ö —Ñ—Ä–∞–∑
    greetings = ["–ø—Ä–∏–≤—ñ—Ç", "–≤—ñ—Ç–∞—é", "–¥–æ–±—Ä–∏–π –¥–µ–Ω—å", "–¥–æ–±—Ä–æ–≥–æ –¥–Ω—è", "–¥–æ–±—Ä–∏–π –≤–µ—á—ñ—Ä", 
                "–¥–æ–±—Ä–æ–≥–æ –≤–µ—á–æ—Ä–∞", "–¥–æ–±—Ä–æ–≥–æ —Ä–∞–Ω–∫—É", "–¥–æ–±—Ä–∏–π —Ä–∞–Ω–æ–∫", "hello", "hi"]
    
    # –û–±—Ä–æ–±–∫–∞ –ø–∏—Ç–∞–Ω—å –ø—Ä–æ —Å—Ç–∞–Ω —Å–ø—Ä–∞–≤
    how_are_you = ["—è–∫ —Å–ø—Ä–∞–≤–∏", "—è–∫ —Å–ø—Ä–∞–≤–∏?", "—è–∫ —Ç–∏", "—è–∫ –ø–æ–∂–∏–≤–∞—î—à", "—â–æ –Ω–æ–≤–æ–≥–æ"]
    
    # –û–±—Ä–æ–±–∫–∞ –µ–º–æ—Ü—ñ–π–Ω–∏—Ö –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å
    emotional_phrases = {
        "–ø–µ—Ä–µ–∂–∏–≤–∞—é": "–†–æ–∑—É–º—ñ—é, —â–æ –≤—Å—Ç—É–ø –º–æ–∂–µ –≤–∏–∫–ª–∏–∫–∞—Ç–∏ —Ö–≤–∏–ª—é–≤–∞–Ω–Ω—è üòî\n\n–ê–ª–µ –Ω–µ —Ö–≤–∏–ª—é–π—Å—è! –Ø –¥–æ–ø–æ–º–æ–∂—É —Ç–æ–±—ñ –∑ —É—Å—ñ–º –Ω–µ–æ–±—Ö—ñ–¥–Ω–∏–º. –ó–∞–¥–∞–π –ø–∏—Ç–∞–Ω–Ω—è –ø—Ä–æ –¥–æ–∫—É–º–µ–Ω—Ç–∏, —Å–ø–µ—Ü—ñ–∞–ª—å–Ω–æ—Å—Ç—ñ –∞–±–æ –≤—Å—Ç—É–ø–Ω—É –∫–∞–º–ø–∞–Ω—ñ—é - —Ä–∞–∑–æ–º –≤—Å–µ –∑—Ä–æ–±–∏–º–æ! üí™",
        "—Ö–≤–∏–ª—é—é—Å—å": "–†–æ–∑—É–º—ñ—é —Ç–≤–æ—î —Ö–≤–∏–ª—é–≤–∞–Ω–Ω—è üòå\n\n–í—Å—Ç—É–ø - —Ü–µ –≤–∞–∂–ª–∏–≤–∏–π –∫—Ä–æ–∫, –∞–ª–µ —Ç–∏ –Ω–µ –æ–¥–∏–Ω! –Ø –¥–æ–ø–æ–º–æ–∂—É –∑ —É—Å—ñ–º–∞ –ø–∏—Ç–∞–Ω–Ω—è–º–∏ –ø—Ä–æ –•–î–£. –©–æ —Ç–µ–±–µ –Ω–∞–π–±—ñ–ª—å—à–µ —Ö–≤–∏–ª—é—î? üìö",
        "—Å—Ç—Ä–∞—à–Ω–æ": "–†–æ–∑—É–º—ñ—é, —â–æ —Ü–µ –º–æ–∂–µ –±—É—Ç–∏ —Å—Ç—Ä–∞—à–Ω–æ üòü\n\n–ê–ª–µ –ø–∞–º'—è—Ç–∞–π - –±–∞–≥–∞—Ç–æ –∞–±—ñ—Ç—É—Ä—ñ—î–Ω—Ç—ñ–≤ –ø—Ä–æ—Ö–æ–¥—è—Ç—å —á–µ—Ä–µ–∑ —Ü–µ. –Ø –¥–æ–ø–æ–º–æ–∂—É —Ç–æ–±—ñ –ø—ñ–¥–≥–æ—Ç—É–≤–∞—Ç–∏—Å—è –¥–æ –≤—Å—Ç—É–ø—É –¥–æ –•–î–£. –ó —á–æ–≥–æ –ø–æ—á–Ω–µ–º–æ? üí™",
        "–Ω–µ—Ä–≤—É—é": "–†–æ–∑—É–º—ñ—é —Ç–≤–æ—é –Ω–µ—Ä–≤–æ–∑–Ω—ñ—Å—Ç—å üò∞\n\n–î–∞–≤–∞–π —Ä–∞–∑–æ–º —Ä–æ–∑–±–µ—Ä–µ–º–æ—Å—è –∑ —É—Å—ñ–º –Ω–µ–æ–±—Ö—ñ–¥–Ω–∏–º –¥–ª—è –≤—Å—Ç—É–ø—É –¥–æ –•–î–£. –ó–∞–¥–∞–π –ø–∏—Ç–∞–Ω–Ω—è - —è –¥–æ–ø–æ–º–æ–∂—É! üìù",
        "—Å—É–º–Ω–æ": "–†–æ–∑—É–º—ñ—é üòî\n\n–Ø–∫—â–æ —Ö–æ—á–µ—à –ø–æ–≥–æ–≤–æ—Ä–∏—Ç–∏ –ø—Ä–æ –≤—Å—Ç—É–ø –¥–æ –•–î–£ –∞–±–æ –º–∞—î—à –ø–∏—Ç–∞–Ω–Ω—è - —è —Ç—É—Ç, —â–æ–± –¥–æ–ø–æ–º–æ–≥—Ç–∏! üíô",
        "–¥–æ–±—Ä–µ": "–ß—É–¥–æ–≤–æ! üòä\n\n–†–∞–¥–∏–π, —â–æ —É —Ç–µ–±–µ –≤—Å–µ –¥–æ–±—Ä–µ. –ß–∏–º –º–æ–∂—É –¥–æ–ø–æ–º–æ–≥—Ç–∏ –∑ –≤—Å—Ç—É–ø–æ–º –¥–æ –•–î–£? üìö",
        "–ø–æ–≥–∞–Ω–æ": "–®–∫–æ–¥–∞, —â–æ —É —Ç–µ–±–µ –ø–æ–≥–∞–Ω–æ üòî\n\n–Ø–∫—â–æ —Ö–æ—á–µ—à –ø–æ–≥–æ–≤–æ—Ä–∏—Ç–∏ –ø—Ä–æ –≤—Å—Ç—É–ø –¥–æ –•–î–£ –∞–±–æ –º–∞—î—à –ø–∏—Ç–∞–Ω–Ω—è - —è —Ç—É—Ç, —â–æ–± –¥–æ–ø–æ–º–æ–≥—Ç–∏! üíô",
    }
    
    user_lower = user_message.lower().strip()
    
    # –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ø—Ä–∏–≤—ñ—Ç–∞–Ω—å
    if any(greeting in user_lower for greeting in greetings):
        await message.answer(
            "–ü—Ä–∏–≤—ñ—Ç! üëã\n\n–ß–∏–º –º–æ–∂—É –¥–æ–ø–æ–º–æ–≥—Ç–∏ –∑ –≤—Å—Ç—É–ø–æ–º –¥–æ –•–î–£? "
            "–ú–æ–∂—É –≤—ñ–¥–ø–æ–≤—ñ—Å—Ç–∏ –Ω–∞ –ø–∏—Ç–∞–Ω–Ω—è –ø—Ä–æ –¥–æ–∫—É–º–µ–Ω—Ç–∏, —Å–ø–µ—Ü—ñ–∞–ª—å–Ω–æ—Å—Ç—ñ, –≤—Å—Ç—É–ø–Ω—É –∫–∞–º–ø–∞–Ω—ñ—é —Ç–∞ —ñ–Ω—à–µ.",
            reply_markup=get_main_menu()
        )
        return
    
    # –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ø–∏—Ç–∞–Ω—å –ø—Ä–æ —Å—Ç–∞–Ω —Å–ø—Ä–∞–≤
    if any(phrase in user_lower for phrase in how_are_you):
        await message.answer(
            "–î—è–∫—É—é, –≤—Å–µ –¥–æ–±—Ä–µ! üòä\n\n–ì–æ—Ç–æ–≤–∏–π –¥–æ–ø–æ–º–æ–≥—Ç–∏ —Ç–æ–±—ñ –∑ –≤—Å—Ç—É–ø–æ–º –¥–æ –•–î–£. "
            "–ó–∞–¥–∞–π –ø–∏—Ç–∞–Ω–Ω—è –ø—Ä–æ –¥–æ–∫—É–º–µ–Ω—Ç–∏, —Å–ø–µ—Ü—ñ–∞–ª—å–Ω–æ—Å—Ç—ñ, –≤—Å—Ç—É–ø–Ω—É –∫–∞–º–ø–∞–Ω—ñ—é –∞–±–æ —ñ–Ω—à–µ! üìö",
            reply_markup=get_main_menu()
        )
        return
    
    # –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –µ–º–æ—Ü—ñ–π–Ω–∏—Ö –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å
    for emotion, response in emotional_phrases.items():
        if emotion in user_lower:
            await message.answer(response, reply_markup=get_main_menu())
            return
    
    # –í–°–Ü –ø–∏—Ç–∞–Ω–Ω—è –æ–±—Ä–æ–±–ª—è—é—Ç—å—Å—è —á–µ—Ä–µ–∑ OLLAMA - –≤–æ–Ω–∞ —Å–∞–º–∞ —Ä–æ–∑–ø—ñ–∑–Ω–∞—î –≥–∞–ª—É–∑—ñ —Ç–∞ —Ñ–æ—Ä–º—É—î –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ
    # –ñ–æ–¥–Ω–æ—ó –∂–æ—Ä—Å—Ç–∫–æ—ó –ª–æ–≥—ñ–∫–∏ —Ä–æ–∑–ø—ñ–∑–Ω–∞–≤–∞–Ω–Ω—è - OLLAMA –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î –ø–æ–∫—Ä–∞—â–µ–Ω–∏–π –ø—Ä–æ–º–ø—Ç –¥–ª—è —Å–∞–º–æ—Å—Ç—ñ–π–Ω–æ–≥–æ —Ä–æ–∑–ø—ñ–∑–Ω–∞–≤–∞–Ω–Ω—è
    
    # –û—Ç—Ä–∏–º—É—î–º–æ —Ç–µ–∫—Å—Ç –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è (—è–∫—â–æ —â–µ –Ω–µ –≤–∏–∑–Ω–∞—á–µ–Ω–æ)
    if not user_message:
        user_message = message.text or ""
    user_message_lower = user_message.lower()
    
    # –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞ –ø–∏—Ç–∞–Ω–Ω—è –ø—Ä–æ –¥–æ–∫—É–º–µ–Ω—Ç–∏ - —è–∫—â–æ —Ç–∞–∫, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –ø—Ä–∞–≤–∏–ª—å–Ω–∏–π —Å–ø–∏—Å–æ–∫
    # –£–Ω–∏–∫–∞—î–º–æ —Ö–∏–±–Ω–∏—Ö —Å–ø—Ä–∞—Ü—å–æ–≤—É–≤–∞–Ω—å –Ω–∞ —Å–ª–æ–≤–æ "–ø–æ–¥–∞—á–∞" –±–µ–∑ –∑–≥–∞–¥–∫–∏ –¥–æ–∫—É–º–µ–Ω—Ç—ñ–≤
    document_keywords = [
        '–¥–æ–∫—É–º–µ–Ω—Ç', '–¥–æ–∫—É–º–µ–Ω—Ç–∏', '—è–∫—ñ –¥–æ–∫—É–º–µ–Ω—Ç–∏', '—Å–ø–∏—Å–æ–∫ –¥–æ–∫—É–º–µ–Ω—Ç—ñ–≤',
        '–ø–æ—Ç—Ä—ñ–±–Ω—ñ –¥–æ–∫—É–º–µ–Ω—Ç–∏', '—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ –¥–ª—è –≤—Å—Ç—É–ø—É'
    ]
    is_document_question = any(word in user_message_lower for word in document_keywords)
    
    if is_document_question:
        # –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –ø—Ä–∞–≤–∏–ª—å–Ω–∏–π —Å–ø–∏—Å–æ–∫ –¥–æ–∫—É–º–µ–Ω—Ç—ñ–≤ –∑ –±–∞–∑–∏ –∑–Ω–∞–Ω—å
        from knowledge_base import get_documents_text
        response = get_documents_text()
        # –ö–æ–Ω–≤–µ—Ä—Ç—É—î–º–æ markdown –≤ HTML
        response = _convert_markdown_to_html(response)
        
        # –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –≤ —ñ—Å—Ç–æ—Ä—ñ—é
        message_history_id = await db.save_message_history(message.from_user.id, user_message, response)
        
        # Inline-–∫–Ω–æ–ø–∫–∞ –¥–ª—è –∑–≤—ñ—Ç—É –ø—Ä–æ –ø–æ–º–∏–ª–∫—É
        reply_markup = get_feedback_keyboard(message_history_id) if message_history_id else None
        
        # –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ –≤—ñ–¥–ø–æ–≤—ñ–¥—å
        await message.answer(
            f"üí¨ –í—ñ–¥–ø–æ–≤—ñ–¥—å:\n\n{response}",
            reply_markup=reply_markup,
            parse_mode="HTML"
        )
        return

    # –°–ø–µ—Ü—ñ–∞–ª—å–Ω–∞ –æ–±—Ä–æ–±–∫–∞ –¥–ª—è –ø—Ä–∞–≤–∞: –æ–¥—Ä–∞–∑—É –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î–º–æ, —â–æ–± —É–Ω–∏–∫–Ω—É—Ç–∏ OLLAMA-–≥–∞–ª—é—Ü–∏–Ω–∞—Ü—ñ–π (121 —Ç–æ—â–æ)
    law_keywords = ['–ø—Ä–∞–≤–æ', '–ø—Ä–∞–≤–∞', '—é—Ä–∏–¥', '—é—Ä–∏—Å–ø—Ä—É–¥', 'law']
    if any(k in user_message_lower for k in law_keywords):
        from tuition_helper import find_tuition_info
        law_text = (
            "<b>‚öñÔ∏è –°–ø–µ—Ü—ñ–∞–ª—å–Ω—ñ—Å—Ç—å –ü—Ä–∞–≤–æ (D8)</b>\n\n"
            "‚Ä¢ –†—ñ–≤–Ω—ñ: –±–∞–∫–∞–ª–∞–≤—Ä, –º–∞–≥—ñ—Å—Ç—Ä\n"
            "‚Ä¢ –§–æ—Ä–º–∞: –¥–µ–Ω–Ω–∞ / –∑–∞–æ—á–Ω–∞\n"
            "‚Ä¢ –§–∞–∫—É–ª—å—Ç–µ—Ç –±—ñ–∑–Ω–µ—Å—É —ñ –ø—Ä–∞–≤–∞\n"
        )
        tuition = find_tuition_info(specialty_name="–ø—Ä–∞–≤–æ")
        if tuition and "–Ω–µ–º–∞—î –¥–∞–Ω–∏—Ö" not in tuition.lower():
            law_text += "\n" + tuition
        law_text += (
            "\n\nüìû –ü—Ä–∏–π–º–∞–ª—å–Ω–∞ –∫–æ–º—ñ—Å—ñ—è: +380 552 494375, +38 095 59 29 149, +38 096 61 30 516\n"
            "üìç –º. –•–µ—Ä—Å–æ–Ω, –≤—É–ª. –£–Ω—ñ–≤–µ—Ä—Å–∏—Ç–µ—Ç—Å—å–∫–∞, 27"
        )
        message_history_id = await db.save_message_history(message.from_user.id, user_message, law_text)
        await message.answer(
            law_text,
            reply_markup=get_feedback_keyboard(message_history_id),
            parse_mode="HTML"
        )
        return

    # –®–í–ò–î–ö–ê –û–ë–†–û–ë–ö–ê –ü–ò–¢–ê–ù–¨ –ü–†–û –í–ê–†–¢–Ü–°–¢–¨ (–±–µ–∑ OLLAMA) ‚Äî –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–∞ –≤–∏—â–µ, —â–æ–± –Ω–µ –ø–µ—Ä–µ—Ö–æ–ø–ª—é–≤–∞–≤ –±–ª–æ–∫ —Ñ–∞–∫—É–ª—å—Ç–µ—Ç—ñ–≤
    # –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞ –ø–∏—Ç–∞–Ω–Ω—è –ø—Ä–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É –≥–∞–ª—É–∑—å ‚Üí –æ–¥—Ä–∞–∑—É –ø–æ–∫–∞–∑—É—î–º–æ –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–∏–π —Ñ–∞–∫—É–ª—å—Ç–µ—Ç
    def detect_faculty_by_keywords(text: str) -> str | None:
        keyword_map = [
            # –ë—ñ–∑–Ω–µ—Å —ñ –ø—Ä–∞–≤–æ
            ([
                "–±—ñ–∑–Ω–µ—Å", "–±—ñ–∑–Ω–µ—Å—É", "–µ–∫–æ–Ω–æ–º", "–ø—Ä–∞–≤–æ", "–ø—Ä–∞–≤–∞", "—é—Ä–∏–¥", "—é—Ä–∏—Å–ø—Ä—É–¥", "—é—Ä–∏—Å—Ç", "–∞–¥–≤–æ–∫–∞—Ç",
                "–º–µ–Ω–µ–¥–∂", "—Ñ—ñ–Ω–∞–Ω—Å", "–±–∞–Ω–∫—ñ–≤—Å—å", "—Å—Ç—Ä–∞—Ö—É–≤–∞–Ω", "–ø—ñ–¥–ø—Ä–∏—î–º–Ω–∏—Ü", "–∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä—É–≤–∞–Ω", "–º–∞—Ä–∫–µ—Ç–∏–Ω–≥"
            ], "faculty_7"),
            # –Ü–¢ / –ø—Ä–æ–≥—Ä–∞–º—É–≤–∞–Ω–Ω—è
            ([
                "—ñ—Ç", "–∞–π—Ç—ñ", "–∞–π—Ç–∏", "–ø—Ä–æ–≥—Ä–∞–º—É–≤", "–ø—Ä–æ–≥—Ä–∞–º–Ω", "–ø—Ä–æ–≥—Ä–∞–º—ñ—Å—Ç", "–∫–æ–º–ø'—é—Ç", "–∫–æ–º–ø—é—Ç",
                "—ñ–Ω—Ñ–æ—Ä–º–∞—Ç", "—Å–∏—Å–∞–¥–º—ñ–Ω", "data", "–¥–∞—Ç–∞", "—à—Ç—É—á–Ω–∏–π —ñ–Ω—Ç–µ–ª–µ–∫—Ç", "–º–∞—à–∏–Ω–Ω–µ –Ω–∞–≤—á–∞–Ω–Ω—è",
                "f2", "f3", "f6", "121"
            ], "faculty_8"),
            # –ú–µ–¥–∏—Ü–∏–Ω–∞ / –∑–¥–æ—Ä–æ–≤'—è
            ([
                "–º–µ–¥–∏—Ü", "–º–µ–¥–∏—á–Ω", "–º–µ–¥—Ñ–∞–∫", "—Ñ–∞—Ä–º–∞—Ü", "—Ç–µ—Ä–∞–ø", "—Ä–µ–∞–±—ñ–ª—ñ—Ç", "–µ—Ä–≥–æ—Ç–µ—Ä–∞–ø", "–∑–¥–æ—Ä–æ–≤",
                "—Ñ—ñ–∑–∏—á–Ω–∞ —Ç–µ—Ä–∞–ø", "–µ—Ä–≥–æ", "–º–µ–¥–∏—Ü–∏–Ω–∞", "–º–µ–¥–∏–∫"
            ], "faculty_3"),
            # –ü—Ä–∏—Ä–æ–¥–Ω–∏—á—ñ
            ([
                "–±—ñ–æ–ª–æ–≥", "–±—ñ–æ", "–µ–∫–æ–ª–æ–≥", "–≥–µ–æ–≥—Ä–∞—Ñ", "–≥–µ–æ", "—Ö—ñ–º", "—Ñ—ñ–∑–∏–∫", "–ø—Ä–∏—Ä–æ–¥–Ω–∏—á", "–∞—Å—Ç—Ä–æ–Ω", "–Ω–∞—É–∫–∏ –ø—Ä–æ –∑–µ–º–ª—é"
            ], "faculty_4"),
            # –°–ø–æ—Ä—Ç
            ([
                "—Å–ø–æ—Ä—Ç", "—Å–ø–æ—Ä—Ç–∏–≤", "—Ñ—ñ–∑–∫—É–ª—å—Ç", "—Ñ—ñ–∑ –≤–∏—Ö", "—Ñ—ñ–∑–∏—á–Ω–∞ –∫—É–ª—å—Ç—É—Ä–∞", "—Ñ–∫", "–æ–ª—ñ–º–ø"
            ], "faculty_5"),
            # –ü–µ–¥–∞–≥–æ–≥—ñ–∫–∞ / –æ—Å–≤—ñ—Ç–∞
            ([
                "–ø–µ–¥–∞–≥–æ–≥", "–¥–æ—à–∫—ñ–ª—å", "–ø–æ—á–∞—Ç–∫–æ–≤", "–ª–æ–≥–æ–ø–µ–¥", "–æ–ª—ñ–≥–æ—Ñ—Ä–µ–Ω", "—Å–µ—Ä–µ–¥–Ω—è –æ—Å–≤—ñ—Ç–∞", "–≤—á–∏—Ç–µ–ª—å",
                "—É—á–∏—Ç–µ–ª—å", "–æ—Å–≤—ñ—Ç–∞", "–º–µ—Ç–æ–¥–∏–∫–∞", "–ø–µ–¥—Ñ–∞–∫"
            ], "faculty_6"),
            # –ü—Å–∏—Ö–æ–ª–æ–≥—ñ—è / —Å–æ—Ü—ñ–∞–ª—å–Ω—ñ
            ([
                "–ø—Å–∏—Ö–æ–ª–æ–≥", "—Å–æ—Ü—ñ–æ–ª–æ–≥", "—ñ—Å—Ç–æ—Ä", "—Å–æ—Ü", "—Å—É—Å–ø—ñ–ª—å–Ω", "—Å–æ—Ü—ñ–∞–ª—å–Ω–∞ —Ä–æ–±–æ—Ç–∞", "–∞—Ä—Ö–µ–æ–ª–æ–≥", "–ø—Å–∏—Ö–æ–ª–æ–≥—ñ—è"
            ], "faculty_2"),
            # –§—ñ–ª–æ–ª–æ–≥—ñ—è / –º–∏—Å—Ç–µ—Ü—Ç–≤–∞ / –∂—É—Ä–Ω–∞–ª—ñ—Å—Ç–∏–∫–∞
            ([
                "—Ñ—ñ–ª–æ–ª–æ–≥", "—Ñ—ñ–ª—Ñ–∞–∫", "–∂—É—Ä–Ω–∞–ª—ñ—Å—Ç", "–∂—É—Ä—Ñ–∞–∫", "–º–∏—Å—Ç–µ—Ü—Ç", "–∫—É–ª—å—Ç—É—Ä–æ–ª", "–º—É–∑–∏—á", "—Ö–æ—Ä–µ–æ–≥—Ä–∞—Ñ",
                "–æ–±—Ä–∞–∑–æ—Ç–≤–æ—Ä", "–≥–µ—Ä–º–∞–Ω—Å—å–∫", "–º–æ–≤", "—ñ–Ω–æ–∑–µ–º–Ω—ñ –º–æ–≤–∏", "–ø–µ—Ä–µ–∫–ª–∞–¥", "–º–æ–≤–æ–∑–Ω–∞–≤", "–ª—ñ—Ç–µ—Ä–∞—Ç—É—Ä"
            ], "faculty_1"),
        ]
        for keywords, faculty_id in keyword_map:
            if any(k in text for k in keywords):
                return faculty_id
        return None

    faculty_id_match = detect_faculty_by_keywords(user_message_lower)
    if faculty_id_match:
        from knowledge_base import get_faculty_specialties
        specialties = get_faculty_specialties(faculty_id_match)

        message_history_id = await db.save_message_history(message.from_user.id, user_message, specialties)

        await message.answer(
            specialties,
            reply_markup=get_feedback_keyboard(message_history_id),
            parse_mode="HTML"
        )
        return

    # –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞ –ø–∏—Ç–∞–Ω–Ω—è –ø—Ä–æ —Ñ–∞–∫—É–ª—å—Ç–µ—Ç–∏ - –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î–º–æ –æ–¥—Ä–∞–∑—É –∑ –∫–ª–∞–≤—ñ–∞—Ç—É—Ä–æ—é
    is_faculty_question = any(word in user_message_lower for word in [
        '—Ñ–∞–∫—É–ª—å—Ç–µ—Ç', '—Ñ–∞–∫—É–ª—å—Ç–µ—Ç–∏', '—è–∫—ñ —î —Ñ–∞–∫—É–ª—å—Ç–µ—Ç–∏', '—Å–ø–∏—Å–æ–∫ —Ñ–∞–∫—É–ª—å—Ç–µ—Ç—ñ–≤'
    ])

    if is_faculty_question:
        from knowledge_base import get_faculties_list
        faculties = get_faculties_list()
        faculties_text_lines = ["üìö –§–∞–∫—É–ª—å—Ç–µ—Ç–∏ –•–î–£:"]
        faculties_text_lines.extend([f"‚Ä¢ {item['name']}" for item in faculties])
        faculties_text_lines.append("–û–±–µ—Ä–∏ —Ñ–∞–∫—É–ª—å—Ç–µ—Ç, —â–æ–± –ø–æ–±–∞—á–∏—Ç–∏ —Å–ø–µ—Ü—ñ–∞–ª—å–Ω–æ—Å—Ç—ñ üéì")
        faculties_text = "\n".join(faculties_text_lines)

        # –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –≤ —ñ—Å—Ç–æ—Ä—ñ—é —ñ –æ—Ç—Ä–∏–º—É—î–º–æ id
        message_history_id = await db.save_message_history(message.from_user.id, user_message, faculties_text)

        # –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ –∑ inline-–∫–ª–∞–≤—ñ–∞—Ç—É—Ä–æ—é —Ñ–∞–∫—É–ª—å—Ç–µ—Ç—ñ–≤ + –∫–Ω–æ–ø–∫–æ—é –∑–≤—ñ—Ç—É
        await message.answer(
            faculties_text,
            reply_markup=get_faculties_keyboard(report_id=message_history_id)
        )
        return
    
    # –®–í–ò–î–ö–ê –û–ë–†–û–ë–ö–ê –ü–ò–¢–ê–ù–¨ –ü–†–û –í–ê–†–¢–Ü–°–¢–¨ (–±–µ–∑ OLLAMA)
    tuition_keywords = ['–≤–∞—Ä—Ç—ñ—Å—Ç—å', '—Ü—ñ–Ω–∞', '—Å–∫—ñ–ª—å–∫–∏ –∫–æ—à—Ç—É—î', '–æ–ø–ª–∞—Ç–∞', '–∫–æ—à—Ç—É—î –Ω–∞–≤—á–∞–Ω–Ω—è', '—Ç–∞—Ä–∏—Ñ–∏', '—Å–∫—ñ–ª—å–∫–∏ –∫–æ—à—Ç—É—î –Ω–∞–≤—á–∞–Ω–Ω—è']
    if any(k in user_message_lower for k in tuition_keywords):
        from tuition_helper import find_tuition_info, extract_specialty_from_message
        
        specialty_name, specialty_code = extract_specialty_from_message(user_message)
        
        # –Ø–∫—â–æ –Ω–µ –∑–Ω–∞–π—à–ª–∏ —É –ø–æ—Ç–æ—á–Ω–æ–º—É –ø–∏—Ç–∞–Ω–Ω—ñ ‚Äî –ø—Ä–æ–±—É—î–º–æ –∑ –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ—Ö
        if not specialty_name and not specialty_code:
            context_prev = await db.get_recent_messages(message.from_user.id, limit=3)
            if context_prev is None:
                context_prev = []
            for ctx in context_prev:
                prev_user = (ctx["user_message"] or "")
                sn, sc = extract_specialty_from_message(prev_user)
                if sn or sc:
                    specialty_name, specialty_code = sn, sc
                    break
        
        # –ù–æ—Ä–º–∞–ª—ñ–∑—É—î–º–æ —Å–ø–µ—Ü—ñ–∞–ª—å–Ω—ñ—Å—Ç—å (–¥–æ–¥–∞—î–º–æ –ø–æ—à–∏—Ä–µ–Ω—ñ –≤—ñ–¥–º—ñ–Ω–∫–∏)
        if specialty_name and specialty_name.lower() == "—Å–æ—Ü—ñ–æ–ª–æ–≥—ñ—è":
            specialty_name = "—Å–æ—Ü—ñ–æ–ª–æ–≥—ñ—è"
        if specialty_name and specialty_name.lower() == "–ø—Ä–∞–≤–æ":
            specialty_name = "–ø—Ä–∞–≤–æ"
        
        if specialty_name or specialty_code:
            tuition_info = find_tuition_info(specialty_name=specialty_name, specialty_code=specialty_code)
            if tuition_info and "–Ω–µ–º–∞—î –¥–∞–Ω–∏—Ö" not in tuition_info.lower():
                response = f"üí∞ <b>–í–∞—Ä—Ç—ñ—Å—Ç—å –Ω–∞–≤—á–∞–Ω–Ω—è</b>\n\n{tuition_info}\n\nüìû –ü—Ä–∏–π–º–∞–ª—å–Ω–∞ –∫–æ–º—ñ—Å—ñ—è: +380 552 494375, +38 095 59 29 149, +38 096 61 30 516"
            else:
                response = ("–ù–∞ –∂–∞–ª—å, –Ω–µ –∑–Ω–∞–π—à–æ–≤ —Ç–æ—á–Ω—É –≤–∞—Ä—Ç—ñ—Å—Ç—å –¥–ª—è —Ü—ñ—î—ó —Å–ø–µ—Ü—ñ–∞–ª—å–Ω–æ—Å—Ç—ñ.\n"
                            "–£—Ç–æ—á–Ω–∏ –≤ –ø—Ä–∏–π–º–∞–ª—å–Ω—ñ–π –∫–æ–º—ñ—Å—ñ—ó –•–î–£: +380 552 494375, +38 095 59 29 149, +38 096 61 30 516.")
        else:
            response = ("–ù–∞–∑–≤–∏ —Å–ø–µ—Ü—ñ–∞–ª—å–Ω—ñ—Å—Ç—å –∞–±–æ —ó—ó –∫–æ–¥ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, 121, F2, F3), "
                        "—â–æ–± –ø–æ–∫–∞–∑–∞—Ç–∏ —Ç–æ—á–Ω—É –≤–∞—Ä—Ç—ñ—Å—Ç—å –Ω–∞–≤—á–∞–Ω–Ω—è. –î–ª—è –¥–æ–≤—ñ–¥–∫–∏: +380 552 494375.")
        
        message_history_id = await db.save_message_history(message.from_user.id, user_message, response)
        await message.answer(
            response,
            reply_markup=get_feedback_keyboard(message_history_id),
            parse_mode="HTML"
        )
        return

    # –ü–æ–∫–∞–∑—É—î–º–æ —ñ–Ω–¥–∏–∫–∞—Ç–æ—Ä –Ω–∞–±–æ—Ä—É
    bot_message = await message.answer("ü§î –î—É–º–∞—é...")
    
    try:
        # –û—Ç—Ä–∏–º—É—î–º–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ—Ö –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å
        context = await db.get_recent_messages(message.from_user.id, limit=3)
        # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç –Ω–µ None —Ç–∞ –Ω–µ –ø–æ—Ä–æ–∂–Ω—ñ–π
        if context is None:
            context = []
        context_list = [
            {"user_message": msg["user_message"], "bot_response": msg["bot_response"]}
            for msg in context
        ]
        
        # –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞ –ø–∏—Ç–∞–Ω–Ω—è –ø—Ä–æ –≤—Å—Ç—É–ø - –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ —Å–ø–µ—Ü—ñ–∞–ª—å–Ω—É –æ–±—Ä–æ–±–∫—É
        admission_keywords = [
            "–ø—Ä–∞–≤–∏–ª–∞ –≤—Å—Ç—É–ø—É", "–≤—Å—Ç—É–ø 2026", "–≤—Å—Ç—É–ø–Ω–∞ –∫–∞–º–ø–∞–Ω—ñ—è 2026",
            "–ø–æ—Ä—è–¥–æ–∫ –≤—Å—Ç—É–ø—É", "–ø—Ä–∞–≤–∏–ª–∞ –ø—Ä–∏–π–æ–º—É", "–ø—Ä–∞–≤–∏–ª–∞ –ø—Ä–∏–π–æ–º—É 2026",
            "–∫–∞–º–ø–∞–Ω—ñ—è 2026", "–Ω–º—Ç", "—Ç—Ä–∞—î–∫—Ç–æ—Ä—ñ—ó –≤—Å—Ç—É–ø—É"
        ]
        is_admission_question = any(kw in user_message_lower for kw in admission_keywords)
        
        # –ì–µ–Ω–µ—Ä—É—î–º–æ –≤—ñ–¥–ø–æ–≤—ñ–¥—å —á–µ—Ä–µ–∑ OLLAMA
        # region agent log
        _agent_log(
            hypothesis_id="H0",
            location="handlers/chat_handler.py:chat_handler:before_generate",
            message="calling generate_response",
            data={"user_message": user_message[:200], "context_count": len(context_list)}
        )
        # endregion
        response = await ollama.generate_response(user_message, context_list)
        
        # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ –æ—Ç—Ä–∏–º–∞–ª–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥—å
        if not response or len(response.strip()) == 0:
            # –Ø–∫—â–æ —Ü–µ –ø–∏—Ç–∞–Ω–Ω—è –ø—Ä–æ –≤—Å—Ç—É–ø - –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ fallback
            if is_admission_question:
                from knowledge_base import get_admission_2026_info
                info = get_admission_2026_info()
                if info:
                    response = _format_admission_2026(info)
                else:
                    response = "–í–∏–±–∞—á, –Ω–µ –≤–¥–∞–ª–æ—Å—è –æ—Ç—Ä–∏–º–∞—Ç–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥—å. –°–ø—Ä–æ–±—É–π –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª—é–≤–∞—Ç–∏ –ø–∏—Ç–∞–Ω–Ω—è –∞–±–æ –∑–≤–µ—Ä–Ω–∏—Å—è –¥–æ –ø—Ä–∏–π–º–∞–ª—å–Ω–æ—ó –∫–æ–º—ñ—Å—ñ—ó –•–î–£ –∑–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–æ–º +380 552 494375."
            else:
                response = "–í–∏–±–∞—á, –Ω–µ –≤–¥–∞–ª–æ—Å—è –æ—Ç—Ä–∏–º–∞—Ç–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥—å. –°–ø—Ä–æ–±—É–π –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª—é–≤–∞—Ç–∏ –ø–∏—Ç–∞–Ω–Ω—è –∞–±–æ –∑–≤–µ—Ä–Ω–∏—Å—è –¥–æ –ø—Ä–∏–π–º–∞–ª—å–Ω–æ—ó –∫–æ–º—ñ—Å—ñ—ó –•–î–£ –∑–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–æ–º +380 552 494375."
        
        # –î–æ–¥–∞—Ç–∫–æ–≤–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –¥–ª—è –ø–∏—Ç–∞–Ω—å –ø—Ä–æ –≤—Å—Ç—É–ø
        if is_admission_question and ("–Ω–µ –≤–¥–∞–ª–æ—Å—è" in response.lower() or len(response.strip()) < 50):
            from knowledge_base import get_admission_2026_info
            info = get_admission_2026_info()
            if info:
                response = _format_admission_2026(info)
        
        # –û–±–º–µ–∂—É—î–º–æ –¥–æ–≤–∂–∏–Ω—É –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è (Telegram –º–∞—î –ª—ñ–º—ñ—Ç 4096 —Å–∏–º–≤–æ–ª—ñ–≤)
        MAX_MESSAGE_LENGTH = 4000  # –ó–∞–ª–∏—à–∞—î–º–æ –º—ñ—Å—Ü–µ –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–∞ —Ç–∞ —ñ–Ω—à–∏—Ö —Ç–µ–∫—Å—Ç—ñ–≤
        
        # –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –ø–æ–≤–Ω—É –≤—ñ–¥–ø–æ–≤—ñ–¥—å –≤ —ñ—Å—Ç–æ—Ä—ñ—é —Ç–∞ –æ—Ç—Ä–∏–º—É—î–º–æ ID
        full_response = response
        message_history_id = await db.save_message_history(message.from_user.id, user_message, full_response)
        
        # –Ø–∫—â–æ –≤—ñ–¥–ø–æ–≤—ñ–¥—å –∑–∞–Ω–∞–¥—Ç–æ –¥–æ–≤–≥–∞, –æ–±—Ä—ñ–∑–∞—î–º–æ —ó—ó
        if len(response) > MAX_MESSAGE_LENGTH:
            response = response[:MAX_MESSAGE_LENGTH] + "\n\n... (–ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –æ–±—Ä—ñ–∑–∞–Ω–æ, –∑–∞–¥–∞–π —É—Ç–æ—á–Ω—é—é—á–µ –ø–∏—Ç–∞–Ω–Ω—è)"
        
        # –û–±—Ä–æ–±–∫–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ —á–µ—Ä–µ–∑ ResponseService (–≤–∞–ª—ñ–¥–∞—Ü—ñ—è, —Ñ–æ—Ä–º–∞—Ç—É–≤–∞–Ω–Ω—è, –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è)
        response, is_valid = response_service.process_response(response, user_message)
        
        # –Ø–∫—â–æ –≤—ñ–¥–ø–æ–≤—ñ–¥—å –Ω–µ –≤–∞–ª—ñ–¥–Ω–∞ - –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ —Ä–µ–∑–µ—Ä–≤–Ω—É –≤—ñ–¥–ø–æ–≤—ñ–¥—å
        if not is_valid:
            response = response_service._get_fallback_response(user_message)

        # –§—ñ–ª—å—Ç—Ä—É—î–º–æ —Ç–µ—Ö–Ω—ñ—á–Ω—ñ —Ñ—Ä–∞–∑–∏ —Ç–∞ –ø–æ–º–∏–ª–∫–∏
        # OLLAMA —Å–∞–º–∞ –ø–µ—Ä–µ–≤—ñ—Ä—è—î –æ—Ä—Ñ–æ–≥—Ä–∞—Ñ—ñ—é —á–µ—Ä–µ–∑ –ø—Ä–æ–º–ø—Ç
        
        # –°–ü–ï–¶–Ü–ê–õ–¨–ù–ê –û–ë–†–û–ë–ö–ê: –ü–∏—Ç–∞–Ω–Ω—è –ø—Ä–æ –≤–∞—Ä—Ç—ñ—Å—Ç—å –Ω–∞–≤—á–∞–Ω–Ω—è
        # –í–ê–ñ–õ–ò–í–û: –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –¢–Ü–õ–¨–ö–ò –ø–∏—Ç–∞–Ω–Ω—è, —è–∫—ñ —è–≤–Ω–æ –ø—Ä–æ –≤–∞—Ä—Ç—ñ—Å—Ç—å
        # –ù–µ —Ç—Ä–∏–≥–µ—Ä–∏–º–æ –Ω–∞ –ø—Ä–æ—Å—Ç–æ "—Å–ø–µ—Ü—ñ–∞–ª—å–Ω—ñ—Å—Ç—å" –±–µ–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç—É –≤–∞—Ä—Ç–æ—Å—Ç—ñ
        user_message_lower = user_message.lower()
        # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ —î –∫–æ–¥ —Å–ø–µ—Ü—ñ–∞–ª—å–Ω–æ—Å—Ç—ñ (121, F6, A4.11, –ê4.11 —Ç–æ—â–æ) - —Ü–µ —Ç–µ–∂ –ø–∏—Ç–∞–Ω–Ω—è –ø—Ä–æ –≤–∞—Ä—Ç—ñ—Å—Ç—å
        # –†–æ–∑—à–∏—Ä–µ–Ω–∏–π —Å–ø–∏—Å–æ–∫ –∫–æ–¥—ñ–≤ —Ç–∞ –≤–∞—Ä—ñ–∞–Ω—Ç—ñ–≤ –ø–∏—Ç–∞–Ω—å - —Ä–æ–∑–ø—ñ–∑–Ω–∞—î–º–æ –ë–£–î–¨-–Ø–ö–Ü –∫–æ–¥–∏
        has_specialty_code = bool(re.search(
            r'\b(121|f6|f2|f3|–∫–æ–¥\s+\d{3}|–∫–æ–¥\s+[a-z]\d+|–∫–æ–¥\s+[a-z]\d+\.\d+|–∫–æ–¥\s+[–∞-—è]\d+\.\d+|—Å–ø–µ—Ü—ñ–∞–ª—å–Ω—ñ—Å—Ç—å\s+\d{3}|—Å–ø–µ—Ü—ñ–∞–ª—å–Ω—ñ—Å—Ç—å\s+[a-z]\d+|—Å–ø–µ—Ü—ñ–∞–ª—å–Ω—ñ—Å—Ç—å\s+[a-z]\d+\.\d+|—Å–ø–µ—Ü—ñ–∞–ª—å–Ω—ñ—Å—Ç—å\s+[–∞-—è]\d+\.\d+|–Ω–∞\s+\d{3}|–Ω–∞\s+[a-z]\d+|–Ω–∞\s+[a-z]\d+\.\d+|–Ω–∞\s+[–∞-—è]\d+\.\d+|\d{3}|[a-z]\d+|[a-z]\d+\.\d+|[–∞-—è]\d+\.\d+)\b',
            user_message_lower,
            re.IGNORECASE
        ))
        # –î–æ–¥–∞—Ç–∫–æ–≤–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞: —á–∏ —Ü–µ –¥—ñ–π—Å–Ω–æ –∫–æ–¥ (–Ω–µ —Ä—ñ–∫, –Ω–µ —Ç–µ–ª–µ—Ñ–æ–Ω —Ç–æ—â–æ)
        if has_specialty_code:
            # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ —î 3-–∑–Ω–∞—á–Ω–µ —á–∏—Å–ª–æ, —è–∫–µ –Ω–µ —î —Ä–æ–∫–æ–º
            year_match = re.search(r'\b(20\d{2})\b', user_message_lower)
            if year_match:
                # –Ø–∫—â–æ —î —Ä—ñ–∫, –ø–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ —î —ñ–Ω—à—ñ 3-–∑–Ω–∞—á–Ω—ñ –∫–æ–¥–∏
                other_codes = re.findall(r'\b(\d{3})\b', user_message_lower)
                if len(other_codes) == 1 and other_codes[0].startswith('20'):
                    # –Ø–∫—â–æ —Ç—ñ–ª—å–∫–∏ —Ä—ñ–∫ - –Ω–µ –≤–≤–∞–∂–∞—î–º–æ —Ü–µ –∫–æ–¥–æ–º —Å–ø–µ—Ü—ñ–∞–ª—å–Ω–æ—Å—Ç—ñ
                    has_specialty_code = False
        # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —Ñ—Ä–∞–∑–∏ —Ç–∏–ø—É "–ê –ù–ê 121?", "–ê –ù–ê F6?" (–ø—Ä–æ–¥–æ–≤–∂–µ–Ω–Ω—è –ø–æ–ø–µ—Ä–µ–¥–Ω—å–æ–≥–æ –ø–∏—Ç–∞–Ω–Ω—è –ø—Ä–æ –≤–∞—Ä—Ç—ñ—Å—Ç—å)
        is_continuation_question = bool(re.search(
            r'^(–∞|–∞ –Ω–∞|–∞ —â–æ–¥–æ|–∞ –ø—Ä–æ|–∞ –ø–æ)\s+',
            user_message_lower
        )) and has_specialty_code
        # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ —î –∫–æ–¥ —É –∫–æ–Ω—Ç–µ–∫—Å—Ç—ñ –≤–∞—Ä—Ç–æ—Å—Ç—ñ (–±—É–¥—å-—è–∫–∏–π 3-–∑–Ω–∞—á–Ω–∏–π, –∑ –ª—ñ—Ç–µ—Ä–æ—é –∞–±–æ –∑ –≥–∞–ª—É–∑–∑—é)
        has_code_with_tuition = bool(re.search(
            r'(–≤–∞—Ä—Ç—ñ—Å—Ç—å|—Ü—ñ–Ω–∞|–∫–æ—à—Ç—É—î|–æ–ø–ª–∞—Ç–∞).*?(\d{3}|[a-z]\d+|[a-z]\d+\.\d+|[–∞-—è]\d+\.\d+)',
            user_message_lower,
            re.IGNORECASE
        ))
        is_tuition_question = (
            any(word in user_message_lower for word in ['–≤–∞—Ä—Ç—ñ—Å—Ç—å', '—Ü—ñ–Ω–∞', '—Å–∫—ñ–ª—å–∫–∏ –∫–æ—à—Ç—É—î', '–æ–ø–ª–∞—Ç–∞', '–∫–æ—à—Ç—É—î –Ω–∞–≤—á–∞–Ω–Ω—è']) or
            ('—Å–ø–µ—Ü—ñ–∞–ª—å–Ω—ñ—Å—Ç—å' in user_message_lower and any(word in user_message_lower for word in ['–≤–∞—Ä—Ç—ñ—Å—Ç—å', '—Ü—ñ–Ω–∞', '–∫–æ—à—Ç—É—î', '–æ–ø–ª–∞—Ç–∞'])) or
            has_specialty_code or  # –Ø–∫—â–æ —î –∫–æ–¥ —Å–ø–µ—Ü—ñ–∞–ª—å–Ω–æ—Å—Ç—ñ - —Ü–µ –ø–∏—Ç–∞–Ω–Ω—è –ø—Ä–æ –≤–∞—Ä—Ç—ñ—Å—Ç—å
            is_continuation_question or  # –Ø–∫—â–æ —Ü–µ –ø—Ä–æ–¥–æ–≤–∂–µ–Ω–Ω—è –ø–∏—Ç–∞–Ω–Ω—è –∑ –∫–æ–¥–æ–º —Å–ø–µ—Ü—ñ–∞–ª—å–Ω–æ—Å—Ç—ñ
            has_code_with_tuition  # –Ø–∫—â–æ –∫–æ–¥ –∑–≥–∞–¥–∞–Ω–æ —Ä–∞–∑–æ–º –∑—ñ —Å–ª–æ–≤–∞–º–∏ –ø—Ä–æ –≤–∞—Ä—Ç—ñ—Å—Ç—å
        )
        
        # –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏–π –ø–æ—à—É–∫ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó –ø—Ä–æ –≤–∞—Ä—Ç—ñ—Å—Ç—å –¥–ª—è –±—É–¥—å-—è–∫–æ—ó —Å–ø–µ—Ü—ñ–∞–ª—å–Ω–æ—Å—Ç—ñ
        if is_tuition_question:
            from tuition_helper import find_tuition_info, extract_specialty_from_message
            
            # –í–∏—Ç—è–≥—É—î–º–æ –Ω–∞–∑–≤—É —Å–ø–µ—Ü—ñ–∞–ª—å–Ω–æ—Å—Ç—ñ —Ç–∞ –∫–æ–¥ –∑ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
            specialty_name, specialty_code = extract_specialty_from_message(user_message)
            
            # –°–ø—Ä–æ–±–∞ –≤–∏–∑–Ω–∞—á–∏—Ç–∏ —Å–ø–µ—Ü—ñ–∞–ª—å–Ω—ñ—Å—Ç—å/—Ñ–∞–∫—É–ª—å—Ç–µ—Ç —ñ–∑ –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ—Ö –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å, —è–∫—â–æ –∑–∞—Ä–∞–∑ –Ω–µ –≤–∫–∞–∑–∞–Ω–æ
            def detect_faculty_by_keywords(text: str) -> str | None:
                keyword_map = [
                    # –ë—ñ–∑–Ω–µ—Å —ñ –ø—Ä–∞–≤–æ
                    (["–±—ñ–∑–Ω–µ—Å", "–µ–∫–æ–Ω–æ–º", "–ø—Ä–∞–≤–æ", "—é—Ä–∏—Å–ø—Ä—É–¥", "–º–µ–Ω–µ–¥–∂", "—Ñ—ñ–Ω–∞–Ω—Å", "–±–∞–Ω–∫—ñ–≤—Å—å", "—Å—Ç—Ä–∞—Ö—É–≤–∞–Ω", "–ø—ñ–¥–ø—Ä–∏—î–º–Ω–∏—Ü", "–∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä—É–≤–∞–Ω"], "faculty_7"),
                    # –Ü–¢ / –ø—Ä–æ–≥—Ä–∞–º—É–≤–∞–Ω–Ω—è
                    (["—ñ—Ç", "–ø—Ä–æ–≥—Ä–∞–º—É–≤", "–ø—Ä–æ–≥—Ä–∞–º–Ω", "–∫–æ–º–ø'—é—Ç", "–∫–æ–º–ø—é—Ç", "—ñ–Ω—Ñ–æ—Ä–º–∞—Ç", "f2", "f3", "f6", "121"], "faculty_8"),
                    # –ú–µ–¥–∏—Ü–∏–Ω–∞ / –∑–¥–æ—Ä–æ–≤'—è
                    (["–º–µ–¥–∏—Ü", "–º–µ–¥–∏—á–Ω", "—Ñ–∞—Ä–º–∞—Ü", "—Ç–µ—Ä–∞–ø", "—Ä–µ–∞–±—ñ–ª—ñ—Ç", "–µ—Ä–≥–æ—Ç–µ—Ä–∞–ø"], "faculty_3"),
                    # –ü—Ä–∏—Ä–æ–¥–Ω–∏—á—ñ
                    (["–±—ñ–æ–ª–æ–≥", "–µ–∫–æ–ª–æ–≥", "–≥–µ–æ–≥—Ä–∞—Ñ", "—Ö—ñ–º", "—Ñ—ñ–∑–∏–∫", "–ø—Ä–∏—Ä–æ–¥–Ω–∏—á"], "faculty_4"),
                    # –°–ø–æ—Ä—Ç
                    (["—Å–ø–æ—Ä—Ç", "—Ñ—ñ–∑–∫—É–ª—å—Ç", "—Ñ—ñ–∑ –≤–∏—Ö", "—Ñ—ñ–∑–∏—á–Ω–∞ –∫—É–ª—å—Ç—É—Ä–∞"], "faculty_5"),
                    # –ü–µ–¥–∞–≥–æ–≥—ñ–∫–∞ / –æ—Å–≤—ñ—Ç–∞
                    (["–ø–µ–¥–∞–≥–æ–≥", "–¥–æ—à–∫—ñ–ª—å", "–ø–æ—á–∞—Ç–∫–æ–≤", "–ª–æ–≥–æ–ø–µ–¥", "–æ–ª—ñ–≥–æ—Ñ—Ä–µ–Ω", "—Å–µ—Ä–µ–¥–Ω—è –æ—Å–≤—ñ—Ç–∞", "–≤—á–∏—Ç–µ–ª—å"], "faculty_6"),
                    # –ü—Å–∏—Ö–æ–ª–æ–≥—ñ—è / —Å–æ—Ü—ñ–∞–ª—å–Ω—ñ
                    (["–ø—Å–∏—Ö–æ–ª–æ–≥", "—Å–æ—Ü—ñ–æ–ª–æ–≥", "—ñ—Å—Ç–æ—Ä", "—Å–æ—Ü", "—Å—É—Å–ø—ñ–ª—å–Ω"], "faculty_2"),
                    # –§—ñ–ª–æ–ª–æ–≥—ñ—è / –º–∏—Å—Ç–µ—Ü—Ç–≤–∞ / –∂—É—Ä–Ω–∞–ª—ñ—Å—Ç–∏–∫–∞
                    (["—Ñ—ñ–ª–æ–ª–æ–≥", "–∂—É—Ä–Ω–∞–ª—ñ—Å—Ç", "–º–∏—Å—Ç–µ—Ü—Ç", "–∫—É–ª—å—Ç—É—Ä–æ–ª", "–º—É–∑–∏—á", "—Ö–æ—Ä–µ–æ–≥—Ä–∞—Ñ", "–æ–±—Ä–∞–∑–æ—Ç–≤–æ—Ä", "–≥–µ—Ä–º–∞–Ω—Å—å–∫", "–º–æ–≤"], "faculty_1"),
                ]
                for keywords, faculty_id in keyword_map:
                    if any(k in text for k in keywords):
                        return faculty_id
                return None

            faculty_id_match = None
            if (not specialty_name) and (not specialty_code) and context_list:
                for ctx in context_list:
                    prev_user = (ctx.get("user_message") or "").lower()
                    prev_sn, prev_sc = extract_specialty_from_message(prev_user)
                    if prev_sn or prev_sc:
                        specialty_name = prev_sn
                        specialty_code = prev_sc
                        break
                    fid = detect_faculty_by_keywords(prev_user)
                    if fid:
                        faculty_id_match = fid
                        break

            # –Ø–∫—â–æ –∑–Ω–∞–π–¥–µ–Ω–æ –∫–æ–¥, –∞–ª–µ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ –Ω–∞–∑–≤—É - –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –∫–æ–¥ –¥–ª—è –ø–æ—à—É–∫—É
            if specialty_code and not specialty_name:
                # –ö–æ–¥ –≤–∂–µ –±—É–¥–µ –∫–æ–Ω–≤–µ—Ä—Ç–æ–≤–∞–Ω–æ –≤ –Ω–∞–∑–≤—É –≤ find_tuition_info
                pass
            
            # –Ø–∫—â–æ –≤—ñ–¥–ø–æ–≤—ñ–¥—å –ø–æ—Ä–æ–∂–Ω—è, –Ω–µ–∫–æ—Ä–µ–∫—Ç–Ω–∞ –∞–±–æ –Ω–µ –º—ñ—Å—Ç–∏—Ç—å —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó –ø—Ä–æ –≤–∞—Ä—Ç—ñ—Å—Ç—å
            # –ê–ë–û —è–∫—â–æ –≤—ñ–¥–ø–æ–≤—ñ–¥—å –º—ñ—Å—Ç–∏—Ç—å —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –ø—Ä–æ —ñ–Ω—à—É —Å–ø–µ—Ü—ñ–∞–ª—å–Ω—ñ—Å—Ç—å
            response_lower = response.lower() if response else ""
            has_tuition_info = any(word in response_lower for word in ['–≥—Ä–Ω', '–≥—Ä–∏–≤–µ–Ω—å', '–º—ñ—Å—è—Ü—å', '—Å–µ–º–µ—Å—Ç—Ä', '—Ä—ñ–∫'])
            
            # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥—å –º—ñ—Å—Ç–∏—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—É —Å–ø–µ—Ü—ñ–∞–ª—å–Ω—ñ—Å—Ç—å
            correct_specialty_in_response = False
            if specialty_name:
                # –°—Ç–≤–æ—Ä—é—î–º–æ —Å–ª–æ–≤–Ω–∏–∫ –∫–ª—é—á–æ–≤–∏—Ö —Å–ª—ñ–≤ –¥–ª—è –∫–æ–∂–Ω–æ—ó —Å–ø–µ—Ü—ñ–∞–ª—å–Ω–æ—Å—Ç—ñ
                from tuition_helper import extract_specialty_from_message
                
                # –û—Ç—Ä–∏–º—É—î–º–æ –∫–ª—é—á–æ–≤—ñ —Å–ª–æ–≤–∞ –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –∑ –ø–æ–≤–Ω–æ–≥–æ —Å–ø–∏—Å–∫—É
                specialty_check_keywords = {
                    "–ø—Å–∏—Ö–æ–ª–æ–≥—ñ—è": ["–ø—Å–∏—Ö–æ–ª–æ–≥", "–ø—Å–∏—Ö–æ–ª–æ–≥—ñ—è"],
                    "—ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ–π–Ω—ñ —Å–∏—Å—Ç–µ–º–∏ —Ç–∞ —Ç–µ—Ö–Ω–æ–ª–æ–≥—ñ—ó": ["—ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ–π–Ω—ñ —Å–∏—Å—Ç–µ–º–∏", "—ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ–π–Ω—ñ —Ç–µ—Ö–Ω–æ–ª–æ–≥—ñ—ó"],
                    "—ñ–Ω–∂–µ–Ω–µ—Ä—ñ—è –ø—Ä–æ–≥—Ä–∞–º–Ω–æ–≥–æ –∑–∞–±–µ–∑–ø–µ—á–µ–Ω–Ω—è": ["—ñ–Ω–∂–µ–Ω–µ—Ä—ñ—è –ø—Ä–æ–≥—Ä–∞–º–Ω–æ–≥–æ", "–ø—Ä–æ–≥—Ä–∞–º–Ω–µ –∑–∞–±–µ–∑–ø–µ—á–µ–Ω–Ω—è"],
                    "–∫–æ–º–ø'—é—Ç–µ—Ä–Ω—ñ –Ω–∞—É–∫–∏": ["–∫–æ–º–ø'—é—Ç–µ—Ä–Ω—ñ –Ω–∞—É–∫–∏"],
                    "–ø—Ä–∞–≤–æ": ["–ø—Ä–∞–≤–æ", "—é—Ä–∏—Å–ø—Ä—É–¥–µ–Ω—Ü—ñ—è"],
                    "–µ–∫–æ–Ω–æ–º—ñ–∫–∞": ["–µ–∫–æ–Ω–æ–º—ñ–∫–∞"],
                    "–º–µ–Ω–µ–¥–∂–º–µ–Ω—Ç": ["–º–µ–Ω–µ–¥–∂–º–µ–Ω—Ç"],
                    "–∂—É—Ä–Ω–∞–ª—ñ—Å—Ç–∏–∫–∞": ["–∂—É—Ä–Ω–∞–ª—ñ—Å—Ç–∏–∫–∞"],
                    "–º–µ–¥–∏—Ü–∏–Ω–∞": ["–º–µ–¥–∏—Ü–∏–Ω–∞", "–º–µ–¥–∏–∫"],
                    "—Ñ–∞—Ä–º–∞—Ü—ñ—è": ["—Ñ–∞—Ä–º–∞—Ü—ñ—è"],
                    "—Ç—É—Ä–∏–∑–º —Ç–∞ —Ä–µ–∫—Ä–µ–∞—Ü—ñ—è": ["—Ç—É—Ä–∏–∑–º"],
                    "–≥–æ—Ç–µ–ª—å–Ω–æ-—Ä–µ—Å—Ç–æ—Ä–∞–Ω–Ω–∞ —Å–ø—Ä–∞–≤–∞": ["–≥–æ—Ç–µ–ª—å–Ω–æ-—Ä–µ—Å—Ç–æ—Ä–∞–Ω–Ω–∞", "–≥–æ—Ç–µ–ª—å"],
                    "–≥–µ–æ–≥—Ä–∞—Ñ—ñ—è —Ç–∞ —Ä–µ–≥—ñ–æ–Ω–∞–ª—å–Ω—ñ —Å—Ç—É–¥—ñ—ó": ["–≥–µ–æ–≥—Ä–∞—Ñ—ñ—è"],
                    "—Å–æ—Ü—ñ–æ–ª–æ–≥—ñ—è": ["—Å–æ—Ü—ñ–æ–ª–æ–≥—ñ—è"],
                    "—Ñ—ñ–∑–∏—á–Ω–∞ —Ç–µ—Ä–∞–ø—ñ—è": ["—Ñ—ñ–∑–∏—á–Ω–∞ —Ç–µ—Ä–∞–ø—ñ—è"],
                    "—Ñ—ñ–∑–∏—á–Ω–∞ —Ä–µ–∞–±—ñ–ª—ñ—Ç–∞—Ü—ñ—è": ["—Ñ—ñ–∑–∏—á–Ω–∞ —Ä–µ–∞–±—ñ–ª—ñ—Ç–∞—Ü—ñ—è"],
                    "–±—ñ–æ–ª–æ–≥—ñ—è —Ç–∞ –±—ñ–æ—Ö—ñ–º—ñ—è": ["–±—ñ–æ–ª–æ–≥—ñ—è", "–±—ñ–æ—Ö—ñ–º—ñ—è"],
                    "–µ–∫–æ–ª–æ–≥—ñ—è": ["–µ–∫–æ–ª–æ–≥—ñ—è"],
                    "—Ö—ñ–º—ñ—è": ["—Ö—ñ–º—ñ—è"],
                    "—Ñ—ñ–∑–∏–∫–∞ —Ç–∞ –∞—Å—Ç—Ä–æ–Ω–æ–º—ñ—è": ["—Ñ—ñ–∑–∏–∫–∞", "–∞—Å—Ç—Ä–æ–Ω–æ–º—ñ—è"],
                    "–¥–æ—à–∫—ñ–ª—å–Ω–∞ –æ—Å–≤—ñ—Ç–∞": ["–¥–æ—à–∫—ñ–ª—å–Ω–∞ –æ—Å–≤—ñ—Ç–∞"],
                    "–ø–æ—á–∞—Ç–∫–æ–≤–∞ –æ—Å–≤—ñ—Ç–∞": ["–ø–æ—á–∞—Ç–∫–æ–≤–∞ –æ—Å–≤—ñ—Ç–∞"],
                    "–ª–æ–≥–æ–ø–µ–¥—ñ—è": ["–ª–æ–≥–æ–ø–µ–¥—ñ—è"],
                    "–æ–±—Ä–∞–∑–æ—Ç–≤–æ—Ä—á–µ –º–∏—Å—Ç–µ—Ü—Ç–≤–æ": ["–æ–±—Ä–∞–∑–æ—Ç–≤–æ—Ä—á–µ –º–∏—Å—Ç–µ—Ü—Ç–≤–æ"],
                    "–º—É–∑–∏—á–Ω–µ –º–∏—Å—Ç–µ—Ü—Ç–≤–æ": ["–º—É–∑–∏—á–Ω–µ –º–∏—Å—Ç–µ—Ü—Ç–≤–æ"],
                    "—Ö–æ—Ä–µ–æ–≥—Ä–∞—Ñ—ñ—è": ["—Ö–æ—Ä–µ–æ–≥—Ä–∞—Ñ—ñ—è"],
                    "–∫—É–ª—å—Ç—É—Ä–æ–ª–æ–≥—ñ—è": ["–∫—É–ª—å—Ç—É—Ä–æ–ª–æ–≥—ñ—è"],
                    "—ñ—Å—Ç–æ—Ä—ñ—è —Ç–∞ –∞—Ä—Ö–µ–æ–ª–æ–≥—ñ—è": ["—ñ—Å—Ç–æ—Ä—ñ—è", "–∞—Ä—Ö–µ–æ–ª–æ–≥—ñ—è"],
                    "—Ñ—ñ–ª–æ–ª–æ–≥—ñ—è": ["—Ñ—ñ–ª–æ–ª–æ–≥—ñ—è"],
                    "—Ñ—ñ–Ω–∞–Ω—Å–∏, –±–∞–Ω–∫—ñ–≤—Å—å–∫–∞ —Å–ø—Ä–∞–≤–∞ —Ç–∞ —Å—Ç—Ä–∞—Ö—É–≤–∞–Ω–Ω—è": ["—Ñ—ñ–Ω–∞–Ω—Å–∏", "–±–∞–Ω–∫—ñ–≤—Å—å–∫–∞"],
                    "–ø—É–±–ª—ñ—á–Ω–µ —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è —Ç–∞ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä—É–≤–∞–Ω–Ω—è": ["–ø—É–±–ª—ñ—á–Ω–µ —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è"],
                    "–ø—ñ–¥–ø—Ä–∏—î–º–Ω–∏—Ü—Ç–≤–æ —Ç–∞ —Ç–æ—Ä–≥—ñ–≤–ª—è": ["–ø—ñ–¥–ø—Ä–∏—î–º–Ω–∏—Ü—Ç–≤–æ"],
                    "—Å–æ—Ü—ñ–∞–ª—å–Ω–∞ —Ä–æ–±–æ—Ç–∞ —Ç–∞ –∫–æ–Ω—Å—É–ª—å—Ç—É–≤–∞–Ω–Ω—è": ["—Å–æ—Ü—ñ–∞–ª—å–Ω–∞ —Ä–æ–±–æ—Ç–∞"],
                    "—Ñ—ñ–∑–∏—á–Ω–∞ –∫—É–ª—å—Ç—É—Ä–∞ —ñ —Å–ø–æ—Ä—Ç": ["—Ñ—ñ–∑–∏—á–Ω–∞ –∫—É–ª—å—Ç—É—Ä–∞"],
                }
                
                # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥—å –º—ñ—Å—Ç–∏—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—É —Å–ø–µ—Ü—ñ–∞–ª—å–Ω—ñ—Å—Ç—å
                if specialty_name.lower() in specialty_check_keywords:
                    correct_specialty_in_response = any(
                        keyword in response_lower 
                        for keyword in specialty_check_keywords[specialty_name.lower()]
                    )
                else:
                    # –Ø–∫—â–æ —Å–ø–µ—Ü—ñ–∞–ª—å–Ω—ñ—Å—Ç—å –Ω–µ –≤ —Å–ø–∏—Å–∫—É, –ø–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∞—Å—Ç–∫–æ–≤–∏–π –∑–±—ñ–≥
                    specialty_name_lower = specialty_name.lower()
                    correct_specialty_in_response = specialty_name_lower in response_lower or any(
                        word in response_lower 
                        for word in specialty_name_lower.split() 
                        if len(word) > 4
                    )
                
                # –î–û–î–ê–¢–ö–û–í–ê –ü–ï–†–ï–í–Ü–†–ö–ê: —á–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥—å –º—ñ—Å—Ç–∏—Ç—å —ñ–Ω—à—ñ —Å–ø–µ—Ü—ñ–∞–ª—å–Ω–æ—Å—Ç—ñ (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ñ)
                # –Ø–∫—â–æ –∑–Ω–∞–π–¥–µ–Ω–æ —ñ–Ω—à—É —Å–ø–µ—Ü—ñ–∞–ª—å–Ω—ñ—Å—Ç—å - —Ü–µ –ø–æ–º–∏–ª–∫–∞
                other_specialties_found = False
                for other_spec, other_keywords in specialty_check_keywords.items():
                    if other_spec != specialty_name.lower():
                        if any(keyword in response_lower for keyword in other_keywords):
                            # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ —Ü–µ –Ω–µ —á–∞—Å—Ç–∏–Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—ó —Å–ø–µ—Ü—ñ–∞–ª—å–Ω–æ—Å—Ç—ñ
                            if not any(keyword in response_lower for keyword in specialty_check_keywords.get(specialty_name.lower(), [])):
                                other_specialties_found = True
                                break
                
                # –Ø–∫—â–æ –∑–Ω–∞–π–¥–µ–Ω–æ —ñ–Ω—à—É —Å–ø–µ—Ü—ñ–∞–ª—å–Ω—ñ—Å—Ç—å - –≤–≤–∞–∂–∞—î–º–æ –≤—ñ–¥–ø–æ–≤—ñ–¥—å –Ω–µ–∫–æ—Ä–µ–∫—Ç–Ω–æ—é
                if other_specialties_found:
                    correct_specialty_in_response = False

            # –Ø–∫—â–æ —Å–ø–µ—Ü—ñ–∞–ª—å–Ω—ñ—Å—Ç—å –Ω–µ –≤–∏–∑–Ω–∞—á–µ–Ω–∞, –∞–ª–µ —î —Ñ–∞–∫—É–ª—å—Ç–µ—Ç –∑ –ø–æ–ø–µ—Ä–µ–¥–Ω—å–æ–≥–æ –∑–∞–ø–∏—Ç—É ‚Äî –ø–æ–∫–∞–∑—É—î–º–æ –≤–∞—Ä—Ç—ñ—Å—Ç—å —É—Å—ñ—Ö —Å–ø–µ—Ü. —Ñ–∞–∫—É–ª—å—Ç–µ—Ç—É
            if (not specialty_name and not specialty_code) and faculty_id_match:
                faculty_specialties_map = {
                    "faculty_7": [  # –ë—ñ–∑–Ω–µ—Å —ñ –ø—Ä–∞–≤–æ
                        "–µ–∫–æ–Ω–æ–º—ñ–∫–∞", "–º–µ–Ω–µ–¥–∂–º–µ–Ω—Ç", "—Ñ—ñ–Ω–∞–Ω—Å–∏, –±–∞–Ω–∫—ñ–≤—Å—å–∫–∞ —Å–ø—Ä–∞–≤–∞ —Ç–∞ —Å—Ç—Ä–∞—Ö—É–≤–∞–Ω–Ω—è",
                        "–ø—ñ–¥–ø—Ä–∏—î–º–Ω–∏—Ü—Ç–≤–æ —Ç–∞ —Ç–æ—Ä–≥—ñ–≤–ª—è", "–ø—Ä–∞–≤–æ", "–ø—É–±–ª—ñ—á–Ω–µ —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è —Ç–∞ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä—É–≤–∞–Ω–Ω—è",
                        "—Ç—É—Ä–∏–∑–º —Ç–∞ —Ä–µ–∫—Ä–µ–∞—Ü—ñ—è", "–≥–æ—Ç–µ–ª—å–Ω–æ-—Ä–µ—Å—Ç–æ—Ä–∞–Ω–Ω–∞ —Å–ø—Ä–∞–≤–∞"
                    ],
                    "faculty_8": [  # –Ü–¢
                        "—ñ–Ω–∂–µ–Ω–µ—Ä—ñ—è –ø—Ä–æ–≥—Ä–∞–º–Ω–æ–≥–æ –∑–∞–±–µ–∑–ø–µ—á–µ–Ω–Ω—è", "–∫–æ–º–ø'—é—Ç–µ—Ä–Ω—ñ –Ω–∞—É–∫–∏", "—ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ–π–Ω—ñ —Å–∏—Å—Ç–µ–º–∏ —Ç–∞ —Ç–µ—Ö–Ω–æ–ª–æ–≥—ñ—ó"
                    ],
                    "faculty_3": [  # –ú–µ–¥–∏—Ü–∏–Ω–∞/–∑–¥–æ—Ä–æ–≤'—è
                        "—Ñ—ñ–∑–∏—á–Ω–∞ —Ç–µ—Ä–∞–ø—ñ—è, –µ—Ä–≥–æ—Ç–µ—Ä–∞–ø—ñ—è", "—Å–æ—Ü—ñ–∞–ª—å–Ω–∞ —Ä–æ–±–æ—Ç–∞ —Ç–∞ –∫–æ–Ω—Å—É–ª—å—Ç—É–≤–∞–Ω–Ω—è",
                        "–º–µ–¥–∏—Ü–∏–Ω–∞", "—Ñ—ñ–∑–∏—á–Ω–∞ —Ä–µ–∞–±—ñ–ª—ñ—Ç–∞—Ü—ñ—è", "—Ñ–∞—Ä–º–∞—Ü—ñ—è"
                    ],
                    "faculty_4": [  # –ü—Ä–∏—Ä–æ–¥–Ω–∏—á—ñ
                        "–±—ñ–æ–ª–æ–≥—ñ—è —Ç–∞ –±—ñ–æ—Ö—ñ–º—ñ—è", "–µ–∫–æ–ª–æ–≥—ñ—è", "–≥–µ–æ–≥—Ä–∞—Ñ—ñ—è —Ç–∞ —Ä–µ–≥—ñ–æ–Ω–∞–ª—å–Ω—ñ —Å—Ç—É–¥—ñ—ó",
                        "—Ö—ñ–º—ñ—è", "—Ñ—ñ–∑–∏–∫–∞ —Ç–∞ –∞—Å—Ç—Ä–æ–Ω–æ–º—ñ—è"
                    ],
                    "faculty_5": [  # –°–ø–æ—Ä—Ç
                        "—Ñ—ñ–∑–∏—á–Ω–∞ –∫—É–ª—å—Ç—É—Ä–∞ —ñ —Å–ø–æ—Ä—Ç"
                    ],
                    "faculty_6": [  # –ü–µ–¥–∞–≥–æ–≥—ñ–∫–∞ / –æ—Å–≤—ñ—Ç–∞
                        "–¥–æ—à–∫—ñ–ª—å–Ω–∞ –æ—Å–≤—ñ—Ç–∞", "–ø–æ—á–∞—Ç–∫–æ–≤–∞ –æ—Å–≤—ñ—Ç–∞", "—Å–ø–µ—Ü—ñ–∞–ª—å–Ω–∞ –æ—Å–≤—ñ—Ç–∞",
                        "—Å–µ—Ä–µ–¥–Ω—è –æ—Å–≤—ñ—Ç–∞ (—ñ—Å—Ç–æ—Ä—ñ—è)", "—Å–µ—Ä–µ–¥–Ω—è –æ—Å–≤—ñ—Ç–∞ (–±—ñ–æ–ª–æ–≥—ñ—è)",
                        "—Å–µ—Ä–µ–¥–Ω—è –æ—Å–≤—ñ—Ç–∞ (–≥–µ–æ–≥—Ä–∞—Ñ—ñ—è)", "—Å–µ—Ä–µ–¥–Ω—è –æ—Å–≤—ñ—Ç–∞ (—Ö—ñ–º—ñ—è)",
                        "—Å–µ—Ä–µ–¥–Ω—è –æ—Å–≤—ñ—Ç–∞ (—É–∫—Ä–∞—ó–Ω—Å—å–∫–∞ –º–æ–≤–∞ —ñ –ª—ñ—Ç–µ—Ä–∞—Ç—É—Ä–∞)",
                        "—Å–µ—Ä–µ–¥–Ω—è –æ—Å–≤—ñ—Ç–∞ (–∞–Ω–≥–ª—ñ–π—Å—å–∫–∞ –º–æ–≤–∞)", "—Å–µ—Ä–µ–¥–Ω—è –æ—Å–≤—ñ—Ç–∞ (–Ω—ñ–º–µ—Ü—å–∫–∞ –º–æ–≤–∞)",
                        "—Å–µ—Ä–µ–¥–Ω—è –æ—Å–≤—ñ—Ç–∞ (—ñ—Å–ø–∞–Ω—Å—å–∫–∞ –º–æ–≤–∞)", "—Å–µ—Ä–µ–¥–Ω—è –æ—Å–≤—ñ—Ç–∞ (–º–∞—Ç–µ–º–∞—Ç–∏–∫–∞)",
                        "—Å–µ—Ä–µ–¥–Ω—è –æ—Å–≤—ñ—Ç–∞ (—Ñ—ñ–∑–∏–∫–∞ —Ç–∞ –∞—Å—Ç—Ä–æ–Ω–æ–º—ñ—è)", "—Å–µ—Ä–µ–¥–Ω—è –æ—Å–≤—ñ—Ç–∞ (—ñ–Ω—Ñ–æ—Ä–º–∞—Ç–∏–∫–∞)",
                        "—Ñ—ñ–∑–∏—á–Ω–∞ –∫—É–ª—å—Ç—É—Ä–∞ —ñ —Å–ø–æ—Ä—Ç"
                    ],
                    "faculty_2": [  # –ü—Å–∏—Ö–æ–ª–æ–≥—ñ—è / —Å–æ—Ü
                        "–ø—Å–∏—Ö–æ–ª–æ–≥—ñ—è", "—Å–æ—Ü—ñ–æ–ª–æ–≥—ñ—è", "—ñ—Å—Ç–æ—Ä—ñ—è —Ç–∞ –∞—Ä—Ö–µ–æ–ª–æ–≥—ñ—è", "–∂—É—Ä–Ω–∞–ª—ñ—Å—Ç–∏–∫–∞"
                    ],
                    "faculty_1": [  # –§—ñ–ª–æ–ª–æ–≥—ñ—è / –º–∏—Å—Ç–µ—Ü—Ç–≤–∞
                        "—Ñ—ñ–ª–æ–ª–æ–≥—ñ—è", "–∂—É—Ä–Ω–∞–ª—ñ—Å—Ç–∏–∫–∞", "–∫—É–ª—å—Ç—É—Ä–æ–ª–æ–≥—ñ—è —Ç–∞ –º—É–∑–µ—î–∑–Ω–∞–≤—Å—Ç–≤–æ",
                        "—Ö–æ—Ä–µ–æ–≥—Ä–∞—Ñ—ñ—è", "–º—É–∑–∏—á–Ω–µ –º–∏—Å—Ç–µ—Ü—Ç–≤–æ", "–æ–±—Ä–∞–∑–æ—Ç–≤–æ—Ä—á–µ –º–∏—Å—Ç–µ—Ü—Ç–≤–æ"
                    ],
                }
                specs = faculty_specialties_map.get(faculty_id_match, [])
                tuition_blocks = []
                for spec in specs:
                    info = find_tuition_info(specialty_name=spec)
                    if info and "–Ω–µ–º–∞—î –¥–∞–Ω–∏—Ö" not in info.lower():
                        tuition_blocks.append(info)
                if tuition_blocks:
                    response = "\n\n".join(tuition_blocks)
                    has_tuition_info = True
                    correct_specialty_in_response = True
            
            # –ó–∞–º—ñ–Ω—é—î–º–æ –≤—ñ–¥–ø–æ–≤—ñ–¥—å –¢–Ü–õ–¨–ö–ò —è–∫—â–æ —Ü–µ –ø–∏—Ç–∞–Ω–Ω—è –ø—Ä–æ –≤–∞—Ä—Ç—ñ—Å—Ç—å:
            # 1. –í—ñ–¥–ø–æ–≤—ñ–¥—å –ø–æ—Ä–æ–∂–Ω—è –∞–±–æ –Ω–µ–∫–æ—Ä–µ–∫—Ç–Ω–∞
            # 2. –í—ñ–¥–ø–æ–≤—ñ–¥—å –Ω–µ –º—ñ—Å—Ç–∏—Ç—å —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó –ø—Ä–æ –≤–∞—Ä—Ç—ñ—Å—Ç—å
            # 3. –í—ñ–¥–ø–æ–≤—ñ–¥—å –º—ñ—Å—Ç–∏—Ç—å —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –ø—Ä–æ —ñ–Ω—à—É —Å–ø–µ—Ü—ñ–∞–ª—å–Ω—ñ—Å—Ç—å (—è–∫—â–æ –±—É–ª–∞ –≤–∏–∑–Ω–∞—á–µ–Ω–∞ —Å–ø–µ—Ü—ñ–∞–ª—å–Ω—ñ—Å—Ç—å)
            # OLLAMA —Å–∞–º–∞ —Ä–æ–∑–ø—ñ–∑–Ω–∞—î —Ç–∞ —Ñ—ñ–ª—å—Ç—Ä—É—î —ñ–Ω—à—ñ —É–Ω—ñ–≤–µ—Ä—Å–∏—Ç–µ—Ç–∏ —á–µ—Ä–µ–∑ –ø—Ä–æ–º–ø—Ç
            should_replace = False
            
            if not response or len(response.strip()) < 50 or '–Ω–µ –≤–¥–∞–ª–æ—Å—è' in response_lower:
                # –í—ñ–¥–ø–æ–≤—ñ–¥—å –ø–æ—Ä–æ–∂–Ω—è –∞–±–æ –Ω–µ–∫–æ—Ä–µ–∫—Ç–Ω–∞ - –∑–∞–º—ñ–Ω—é—î–º–æ
                should_replace = True
            elif not has_tuition_info:
                # –í—ñ–¥–ø–æ–≤—ñ–¥—å –Ω–µ –º—ñ—Å—Ç–∏—Ç—å —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó –ø—Ä–æ –≤–∞—Ä—Ç—ñ—Å—Ç—å - –∑–∞–º—ñ–Ω—é—î–º–æ
                should_replace = True
            elif specialty_name and not correct_specialty_in_response:
                # –í—ñ–¥–ø–æ–≤—ñ–¥—å –ø—Ä–æ —ñ–Ω—à—É —Å–ø–µ—Ü—ñ–∞–ª—å–Ω—ñ—Å—Ç—å - –∑–∞–º—ñ–Ω—é—î–º–æ –¢–Ü–õ–¨–ö–ò —è–∫—â–æ —Ü–µ –ø–∏—Ç–∞–Ω–Ω—è –ø—Ä–æ –≤–∞—Ä—Ç—ñ—Å—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ—ó —Å–ø–µ—Ü—ñ–∞–ª—å–Ω–æ—Å—Ç—ñ
                should_replace = True
            
            if should_replace:
                # –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∑–Ω–∞—Ö–æ–¥–∏–º–æ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –ø—Ä–æ –≤–∞—Ä—Ç—ñ—Å—Ç—å
                tuition_info = find_tuition_info(specialty_name, specialty_code)
                if tuition_info:
                    response = tuition_info
        
        # –ö–†–û–ö 2: –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞ –Ω–µ–∑—Ä–æ–∑—É–º—ñ–ª—ñ —Ç–µ–∫—Å—Ç–∏ (–ª–∞—Ç–∏–Ω–∏—Ü—è + –∫–∏—Ä–∏–ª–∏—Ü—è, –Ω–µ–∑—Ä–æ–∑—É–º—ñ–ª—ñ —Å–ª–æ–≤–∞)
        # –Ø–∫—â–æ –≤—ñ–¥–ø–æ–≤—ñ–¥—å –º—ñ—Å—Ç–∏—Ç—å –±–∞–≥–∞—Ç–æ –Ω–µ–∑—Ä–æ–∑—É–º—ñ–ª–∏—Ö —Å–∏–º–≤–æ–ª—ñ–≤ –∞–±–æ —Å–ª—ñ–≤ - –∑–∞–º—ñ–Ω—é—î–º–æ –Ω–∞ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É –≤—ñ–¥–ø–æ–≤—ñ–¥—å
        unclear_patterns = [
            r'[A-Z]{3,}[–ê-–Ø–∞-—è]|[–ê-–Ø–∞-—è][A-Z]{3,}',
            r'–óAZNALAGIDDO|–û–¢–ü–û–í–ò–î–ò|–ö–†–ï–î–ò–¢–ï–õ–Ø–û–ú|–ï–ù–¢–†–ï–ó–ê|–ü–†–Ø–ú–£ –í–Ü–î–ü–û–í–Ü–î–ï–ô',
            r'–í–∏—Ç—Ä–∞–Ω–Ω—è –¥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞',
            r'–ü—ñ—à—ñ—Ç—å –∑–∞',
            r'–ü–æ–ø–æ–≤–Ω—ñ—Ç—å—Ç–µ—Å—å',
            r'–í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ —ñ–Ω—Ç–µ—Ä–Ω–µ—Ç',
            r'–ö—Ä–∞—â–∏–π —à–ª—è—Ö –¥–æ —É—Å–ø—ñ—Ö—É',
            r'–ó–±–µ—Ä–µ–∂—ñ—Ç—å —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é',
            r'–ü–æ–ø–æ–≤–Ω—ñ—Ç—å—Ç–µ—Å—å —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—î—é'
        ]
        
        has_unclear_text = any(re.search(pattern, response, re.IGNORECASE) for pattern in unclear_patterns)
        
        if has_unclear_text:
            # –Ø–∫—â–æ –ø–∏—Ç–∞–Ω–Ω—è –ø—Ä–æ –¥–æ–∫—É–º–µ–Ω—Ç–∏ - –¥–∞—î–º–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É –≤—ñ–¥–ø–æ–≤—ñ–¥—å
            if any(word in user_message.lower() for word in ['–¥–æ–∫—É–º–µ–Ω—Ç', '–ø–æ–¥–∞—Ç–∏', '–ø–æ–¥–∞—á–∞', '—è–∫ –ø–æ–¥–∞—Ç–∏']):
                response = """–î–ª—è –ø–æ–¥–∞—á—ñ –¥–æ–∫—É–º–µ–Ω—Ç—ñ–≤ –¥–æ –•–î–£ –ø–æ—Ç—Ä—ñ–±–Ω–æ:

‚Ä¢ –ó–∞—è–≤–∞ (–∑–∞ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ—é —Ñ–æ—Ä–º–æ—é –•–î–£)
‚Ä¢ –î–æ–∫—É–º–µ–Ω—Ç –ø—Ä–æ –æ—Å–≤—ñ—Ç—É (–æ—Ä–∏–≥—ñ–Ω–∞–ª –∞–±–æ –∫–æ–ø—ñ—è)
‚Ä¢ –î–æ–¥–∞—Ç–æ–∫ –¥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞ –ø—Ä–æ –æ—Å–≤—ñ—Ç—É
‚Ä¢ –§–æ—Ç–æ 3x4 (4 —à—Ç.)
‚Ä¢ –ö–æ–ø—ñ—è –ø–∞—Å–ø–æ—Ä—Ç–∞ (1-2 —Å—Ç–æ—Ä—ñ–Ω–∫–∏)
‚Ä¢ –ö–æ–ø—ñ—è —ñ–¥–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ–π–Ω–æ–≥–æ –∫–æ–¥—É
‚Ä¢ –ú–µ–¥–∏—á–Ω–∞ –¥–æ–≤—ñ–¥–∫–∞ (—Ñ–æ—Ä–º–∞ 086-–æ)
‚Ä¢ –†–µ–∑—É–ª—å—Ç–∞—Ç–∏ –ó–ù–û (—Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç)
‚Ä¢ –î–æ–∫—É–º–µ–Ω—Ç–∏ –ø—Ä–æ –æ—Å–æ–±–ª–∏–≤—ñ –ø—Ä–∞–≤–∞ (—è–∫—â–æ —î)

–î–æ–∫—É–º–µ–Ω—Ç–∏ –ø–æ–¥–∞—é—Ç—å—Å—è –∑–≥—ñ–¥–Ω–æ –∑ –≥—Ä–∞—Ñ—ñ–∫–æ–º –ú–û–ù –£–∫—Ä–∞—ó–Ω–∏. –î–ª—è —É—Ç–æ—á–Ω–µ–Ω–Ω—è –¥–µ—Ç–∞–ª–µ–π –∑–≤–µ—Ä–Ω–∏—Å—è –¥–æ –ø—Ä–∏–π–º–∞–ª—å–Ω–æ—ó –∫–æ–º—ñ—Å—ñ—ó –•–î–£:
üìû +380 552 494375, +38 095 59 29 149, +38 096 61 30 516"""
            else:
                response = "–í–∏–±–∞—á, –Ω–µ –≤–¥–∞–ª–æ—Å—è —Å—Ñ–æ—Ä–º—É–≤–∞—Ç–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥—å. –ü–µ—Ä–µ—Ñ–æ—Ä–º—É–ª—é–π, –±—É–¥—å –ª–∞—Å–∫–∞, –ø–∏—Ç–∞–Ω–Ω—è –∞–±–æ –∑–≤–µ—Ä–Ω–∏—Å—è –¥–æ –ø—Ä–∏–π–º–∞–ª—å–Ω–æ—ó –∫–æ–º—ñ—Å—ñ—ó –•–î–£ –∑–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–æ–º +380 552 494375."
        
        # –í–∏–¥–∞–ª—è—î–º–æ —Ç–µ—Ö–Ω—ñ—á–Ω—ñ —Ñ—Ä–∞–∑–∏
        response = re.sub(r'–ü—Ä–∞—Ü—é—î–º–æ –Ω–∞–¥ –≤—ñ–¥–ø–æ–≤—ñ–¥—è–º–∏.*?—Ñ–æ—Ä–º–∞—Ç—É:', '', response, flags=re.DOTALL)
        response = re.sub(r'–Ø–∫—â–æ –±–∞–∂—î—à –¥–æ–¥–∞–≤–∞—Ç–∏.*?—Ñ–æ—Ä–º–∞—Ç—É:', '', response, flags=re.DOTALL)
        response = re.sub(r'vui—á—ñ—Ç—å—Å—è.*?—Ñ–æ—Ä–º–∞—Ç—É:', '', response, flags=re.DOTALL)
        response = re.sub(r'–¢–µ–∫—Å—Ç –¥–ª—è –≤—ñ–¥–ø–æ–≤—ñ–¥–µ–π.*?–≤—ñ–¥–ø–æ–≤—ñ–¥–µ–π\.', '', response, flags=re.DOTALL)
        response = re.sub(r'–í —Ä–∞–∑—ñ –Ω–µ–æ–±—Ö—ñ–¥–Ω–æ—Å—Ç—ñ.*?–≤—ñ–¥–ø–æ–≤—ñ–¥–µ–π\.', '', response, flags=re.DOTALL)
        response = re.sub(r'–∑–∞–ø–æ–≤–Ω—é–π—Ç–µ –ø–æ–ª–µ.*?–≤—ñ–¥–ø–æ–≤—ñ–¥–µ–π\.', '', response, flags=re.DOTALL)
        
        # –í–∏–¥–∞–ª—è—î–º–æ –Ω–µ–∑—Ä–æ–∑—É–º—ñ–ª—ñ —Ñ—Ä–∞–∑–∏ (–±–µ–∑ –¥—É–±–ª—å–æ–≤–∞–Ω–∏—Ö)
        unclear_phrases = [
            (r'–óAZNALAGIDDO[^.]*\.', ''),
            (r'–û–¢–ü–û–í–ò–î–ò[^.]*\.', ''),
            (r'–ö–†–ï–î–ò–¢–ï–õ–Ø–û–ú[^.]*\.', ''),
            (r'–ï–ù–¢–†–ï–ó–ê[^.]*\.', ''),
            (r'–ü–†–Ø–ú–£ –í–Ü–î–ü–û–í–Ü–î–ï–ô[^.]*\.', ''),
            (r'–í—ñ—Ç–∞—é –í–∞—Å –¥–æ –∑–≤–∏—á–∞–π[^.]*\.', ''),
            (r'–∑–≤–∏—á–∞–π–Ω–æ–≥–æ –∑–≤–µ—Ä–Ω–µ–Ω—å—è[^.]*\.', ''),
            (r'–í–∏—Ç—Ä–∞–Ω–Ω—è –¥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞[^.]*\.', ''),
            (r'–ü—ñ—à—ñ—Ç—å –∑–∞ –ó–ù–û[^.]*\.', '–ü–æ–¥–∞–π—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç–∏ –Ω–∞ –ó–ù–û.'),
            (r'–ü–æ–ø–æ–≤–Ω—ñ—Ç—å—Ç–µ—Å—å[^.]*\.', '–û–∑–Ω–∞–π–æ–º—Ç–µ—Å—è.'),
            (r'–í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ —ñ–Ω—Ç–µ—Ä–Ω–µ—Ç[^.]*\.', ''),
            (r'–ö—Ä–∞—â–∏–π —à–ª—è—Ö –¥–æ —É—Å–ø—ñ—Ö—É[^.]*\.', ''),
            (r'–ó–±–µ—Ä–µ–∂—ñ—Ç—å —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é[^.]*\.', ''),
        ]
        for pattern, replacement in unclear_phrases:
            response = re.sub(pattern, replacement, response, flags=re.IGNORECASE)
        
        # –í–∏–¥–∞–ª—è—î–º–æ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ñ —Ñ—Ä–∞–∑–∏
        response = re.sub(r'–í–∏—Ç—Ä–∞–∂ –≤ —É–Ω—ñ–≤–µ—Ä—Å–∏—Ç–µ—Ç!', '', response, flags=re.IGNORECASE)
        response = re.sub(r'–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –í—ñ—Ç–∞–µ–º –≤–∞–º –¥–æ[^!]*!', '–í—ñ—Ç–∞—é!', response, flags=re.DOTALL)
        response = re.sub(r'–í—ñ—Ç–∞–µ–º –≤–∞–º –¥–æ[^!]*!', '–í—ñ—Ç–∞—é!', response, flags=re.DOTALL)
        
        # –í–∏–¥–∞–ª—è—î–º–æ —Ä–æ—Å—ñ–π—Å—å–∫—ñ —Ñ—Ä–∞–∑–∏
        response = re.sub(r'–ü–æ—á–µ–º—É –≤–∞–º –ø–æ—Ç—Ä—ñ–±–Ω–∞.*?\?', '', response, flags=re.IGNORECASE)
        response = re.sub(r'–í–æ—Ç —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –ø—Ä–æ –•–î–£:', '–û—Å—å —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ –•–î–£:', response, flags=re.IGNORECASE)
        response = re.sub(r'–í–æ—Ç —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é:', '–û—Å—å —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è:', response, flags=re.IGNORECASE)
        
        # –û—á–∏—â–∞—î–º–æ –≤—ñ–¥ –∑–∞–π–≤–∏—Ö –ø–æ—Ä–æ–∂–Ω—ñ—Ö —Ä—è–¥–∫—ñ–≤
        response = re.sub(r'\n{3,}', '\n\n', response)
        response = response.strip()
        
        # –ö–†–û–ö 3: –§–Ü–ù–ê–õ–¨–ù–ê –ü–ï–†–ï–í–Ü–†–ö–ê –ø–µ—Ä–µ–¥ –≤—ñ–¥–ø—Ä–∞–≤–∫–æ—é - —è–∫—â–æ –≤—ñ–¥–ø–æ–≤—ñ–¥—å –º—ñ—Å—Ç–∏—Ç—å –Ω–µ–∑—Ä–æ–∑—É–º—ñ–ª—ñ —Å–ª–æ–≤–∞ –∞–±–æ –∑–∞–Ω–∞–¥—Ç–æ –±–∞–≥–∞—Ç–æ –ø–æ–º–∏–ª–æ–∫ - –∑–∞–º—ñ–Ω—é—î–º–æ
        unclear_patterns_list = [
            r'[A-Z]{3,}[–ê-–Ø–∞-—è]|[–ê-–Ø–∞-—è][A-Z]{3,}',
            r'–óAZNALAGIDDO|–û–¢–ü–û–í–ò–î–ò|–ö–†–ï–î–ò–¢–ï–õ–Ø–û–ú|–ï–ù–¢–†–ï–ó–ê|–ü–†–Ø–ú–£ –í–Ü–î–ü–û–í–Ü–î–ï–ô',
            r'–∑–≤–∏—á–∞–π–Ω–æ–≥–æ –∑–≤–µ—Ä–Ω–µ–Ω—å—è',
            r'–í–∏—Ç—Ä–∞–Ω–Ω—è –¥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞',
            r'–ü—ñ—à—ñ—Ç—å –∑–∞',
            r'–ü–æ–ø–æ–≤–Ω—ñ—Ç—å—Ç–µ—Å—å',
            r'–í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ —ñ–Ω—Ç–µ—Ä–Ω–µ—Ç',
            r'–ö—Ä–∞—â–∏–π —à–ª—è—Ö –¥–æ —É—Å–ø—ñ—Ö—É',
            r'–ó–±–µ—Ä–µ–∂—ñ—Ç—å —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é',
            r'–ü–æ–ø–æ–≤–Ω—ñ—Ç—å—Ç–µ—Å—å —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—î—é'
        ]
        unclear_words_count = sum(len(re.findall(pattern, response, re.IGNORECASE)) for pattern in unclear_patterns_list)
        
        # –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞ –Ω–∞—è–≤–Ω—ñ—Å—Ç—å –∑–∞–±–æ—Ä–æ–Ω–µ–Ω–∏—Ö —Ñ—Ä–∞–∑
        forbidden_phrases = [
            '–í–∏—Ç—Ä–∞–Ω–Ω—è –¥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞',
            '–ü—ñ—à—ñ—Ç—å –∑–∞',
            '–ü–æ–ø–æ–≤–Ω—ñ—Ç—å—Ç–µ—Å—å',
            '–í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ —ñ–Ω—Ç–µ—Ä–Ω–µ—Ç',
            '–ö—Ä–∞—â–∏–π —à–ª—è—Ö –¥–æ —É—Å–ø—ñ—Ö—É',
            '–ó–±–µ—Ä–µ–∂—ñ—Ç—å —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é'
        ]
        
        for phrase in forbidden_phrases:
            if phrase.lower() in response.lower():
                unclear_words_count += 5
        
        # –Ø–∫—â–æ –∑–Ω–∞–π–¥–µ–Ω–æ –±–∞–≥–∞—Ç–æ –ø–æ–º–∏–ª–æ–∫ - –∑–∞–º—ñ–Ω—é—î–º–æ –Ω–∞ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É –≤—ñ–¥–ø–æ–≤—ñ–¥—å
        # –ê–õ–ï: –¥–ª—è –ø–∏—Ç–∞–Ω—å –ø—Ä–æ –≤–∞—Ä—Ç—ñ—Å—Ç—å - –Ω–µ –±–ª–æ–∫—É—î–º–æ, —è–∫—â–æ –≤—ñ–¥–ø–æ–≤—ñ–¥—å –º—ñ—Å—Ç–∏—Ç—å —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –ø—Ä–æ –≤–∞—Ä—Ç—ñ—Å—Ç—å
        # –ê–õ–ï: –¥–ª—è –∑–≤–∏—á–∞–π–Ω–∏—Ö –ø–∏—Ç–∞–Ω—å - –Ω–µ –∑–∞–º—ñ–Ω—é—î–º–æ, —è–∫—â–æ –≤—ñ–¥–ø–æ–≤—ñ–¥—å –Ω–µ –º—ñ—Å—Ç–∏—Ç—å –∫—Ä–∏—Ç–∏—á–Ω–∏—Ö –ø–æ–º–∏–ª–æ–∫
        if unclear_words_count > 0:
            # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥—å –ø—Ä–æ –≤–∞—Ä—Ç—ñ—Å—Ç—å –º—ñ—Å—Ç–∏—Ç—å –∫–æ—Ä–∏—Å–Ω—É —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é
            has_tuition_info = is_tuition_question and any(word in response.lower() for word in [
                '–≥—Ä–Ω', '–≥—Ä–∏–≤–µ–Ω—å', '–º—ñ—Å—è—Ü—å', '—Å–µ–º–µ—Å—Ç—Ä', '—Ä—ñ–∫', '–ø–µ—Ä—ñ–æ–¥', '–≤–∞—Ä—Ç—ñ—Å—Ç—å', '–Ω–∞–≤—á–∞–Ω–Ω—è'
            ])
            
            # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ —Ü–µ –ø–∏—Ç–∞–Ω–Ω—è –ø—Ä–æ –¥–æ–∫—É–º–µ–Ω—Ç–∏ (–ª–∏—à–µ —è–≤–Ω—ñ –∑–≥–∞–¥–∫–∏ –ø—Ä–æ –¥–æ–∫—É–º–µ–Ω—Ç–∏)
            is_document_question = any(word in user_message.lower() for word in [
                '–¥–æ–∫—É–º–µ–Ω—Ç', '–¥–æ–∫—É–º–µ–Ω—Ç–∏', '—è–∫—ñ –¥–æ–∫—É–º–µ–Ω—Ç–∏', '—Å–ø–∏—Å–æ–∫ –¥–æ–∫—É–º–µ–Ω—Ç—ñ–≤',
                '–ø–æ—Ç—Ä—ñ–±–Ω—ñ –¥–æ–∫—É–º–µ–Ω—Ç–∏', '—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ –¥–ª—è –≤—Å—Ç—É–ø—É'
            ])
            
            # –Ø–∫—â–æ —Ü–µ –ø–∏—Ç–∞–Ω–Ω—è –ø—Ä–æ –≤–∞—Ä—Ç—ñ—Å—Ç—å —ñ –≤—ñ–¥–ø–æ–≤—ñ–¥—å –º—ñ—Å—Ç–∏—Ç—å —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –ø—Ä–æ –≤–∞—Ä—Ç—ñ—Å—Ç—å - –Ω–µ –±–ª–æ–∫—É—î–º–æ
            if has_tuition_info:
                # –¢—ñ–ª—å–∫–∏ –≤–∏–¥–∞–ª—è—î–º–æ –Ω–µ–∑—Ä–æ–∑—É–º—ñ–ª—ñ —Å–ª–æ–≤–∞, –∞–ª–µ –Ω–µ –∑–∞–º—ñ–Ω—é—î–º–æ –≤—Å—é –≤—ñ–¥–ø–æ–≤—ñ–¥—å
                pass
            elif is_document_question:
                response = """–î–ª—è –ø–æ–¥–∞—á—ñ –¥–æ–∫—É–º–µ–Ω—Ç—ñ–≤ –¥–æ –•–î–£ –ø–æ—Ç—Ä—ñ–±–Ω–æ:

‚Ä¢ –ó–∞—è–≤–∞ (–∑–∞ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ—é —Ñ–æ—Ä–º–æ—é –•–î–£)
‚Ä¢ –î–æ–∫—É–º–µ–Ω—Ç –ø—Ä–æ –æ—Å–≤—ñ—Ç—É (–æ—Ä–∏–≥—ñ–Ω–∞–ª –∞–±–æ –∫–æ–ø—ñ—è)
‚Ä¢ –î–æ–¥–∞—Ç–æ–∫ –¥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞ –ø—Ä–æ –æ—Å–≤—ñ—Ç—É
‚Ä¢ –§–æ—Ç–æ 3x4 (4 —à—Ç.)
‚Ä¢ –ö–æ–ø—ñ—è –ø–∞—Å–ø–æ—Ä—Ç–∞ (1-2 —Å—Ç–æ—Ä—ñ–Ω–∫–∏)
‚Ä¢ –ö–æ–ø—ñ—è —ñ–¥–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ–π–Ω–æ–≥–æ –∫–æ–¥—É
‚Ä¢ –ú–µ–¥–∏—á–Ω–∞ –¥–æ–≤—ñ–¥–∫–∞ (—Ñ–æ—Ä–º–∞ 086-–æ)
‚Ä¢ –†–µ–∑—É–ª—å—Ç–∞—Ç–∏ –ó–ù–û (—Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç)
‚Ä¢ –î–æ–∫—É–º–µ–Ω—Ç–∏ –ø—Ä–æ –æ—Å–æ–±–ª–∏–≤—ñ –ø—Ä–∞–≤–∞ (—è–∫—â–æ —î)

–î–æ–∫—É–º–µ–Ω—Ç–∏ –ø–æ–¥–∞—é—Ç—å—Å—è –∑–≥—ñ–¥–Ω–æ –∑ –≥—Ä–∞—Ñ—ñ–∫–æ–º –ú–û–ù –£–∫—Ä–∞—ó–Ω–∏. –î–ª—è —É—Ç–æ—á–Ω–µ–Ω–Ω—è –¥–µ—Ç–∞–ª–µ–π –∑–≤–µ—Ä–Ω–∏—Å—è –¥–æ –ø—Ä–∏–π–º–∞–ª—å–Ω–æ—ó –∫–æ–º—ñ—Å—ñ—ó –•–î–£:
üìû +380 552 494375, +38 095 59 29 149, +38 096 61 30 516
üìç –º. –•–µ—Ä—Å–æ–Ω, –≤—É–ª. –£–Ω—ñ–≤–µ—Ä—Å–∏—Ç–µ—Ç—Å—å–∫–∞, 27"""
            # –î–ª—è —ñ–Ω—à–∏—Ö –ø–∏—Ç–∞–Ω—å - –∑–∞–º—ñ–Ω—é—î–º–æ –¢–Ü–õ–¨–ö–ò —è–∫—â–æ —î –∫—Ä–∏—Ç–∏—á–Ω—ñ –ø–æ–º–∏–ª–∫–∏ (–Ω–µ–∑—Ä–æ–∑—É–º—ñ–ª—ñ —Å–ª–æ–≤–∞)
            # –Ø–∫—â–æ –ø—Ä–æ—Å—Ç–æ —î –ø–æ–º–∏–ª–∫–∏, –∞–ª–µ –≤—ñ–¥–ø–æ–≤—ñ–¥—å –∑—Ä–æ–∑—É–º—ñ–ª–∞ - –Ω–µ –∑–∞–º—ñ–Ω—é—î–º–æ
            elif unclear_words_count >= 3:  # –¢—ñ–ª—å–∫–∏ —è–∫—â–æ –±–∞–≥–∞—Ç–æ –∫—Ä–∏—Ç–∏—á–Ω–∏—Ö –ø–æ–º–∏–ª–æ–∫
                response = "–í–∏–±–∞—á, –Ω–µ –≤–¥–∞–ª–æ—Å—è —Å—Ñ–æ—Ä–º—É–≤–∞—Ç–∏ –∫–æ—Ä–µ–∫—Ç–Ω—É –≤—ñ–¥–ø–æ–≤—ñ–¥—å. –ü–µ—Ä–µ—Ñ–æ—Ä–º—É–ª—é–π, –±—É–¥—å –ª–∞—Å–∫–∞, –ø–∏—Ç–∞–Ω–Ω—è –∞–±–æ –∑–≤–µ—Ä–Ω–∏—Å—è –¥–æ –ø—Ä–∏–π–º–∞–ª—å–Ω–æ—ó –∫–æ–º—ñ—Å—ñ—ó –•–î–£ –∑–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–æ–º +380 552 494375."
            # –Ø–∫—â–æ –ø–æ–º–∏–ª–æ–∫ –º–∞–ª–æ –∞–±–æ –Ω–µ–º–∞—î - –∑–∞–ª–∏—à–∞—î–º–æ –æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω—É –≤—ñ–¥–ø–æ–≤—ñ–¥—å –≤—ñ–¥ OLLAMA
        
        # –ö–†–û–ö 4: –§–Ü–ù–ê–õ–¨–ù–ê –ü–ï–†–ï–í–Ü–†–ö–ê –ü–ï–†–ï–î –í–Ü–î–ü–†–ê–í–ö–û–Æ
        # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —Ç—ñ–ª—å–∫–∏ –Ω–∞ –Ω–µ–∑—Ä–æ–∑—É–º—ñ–ª—ñ —Ç–µ—Ö–Ω—ñ—á–Ω—ñ —Ñ—Ä–∞–∑–∏
        # OLLAMA —Å–∞–º–∞ —Ä–æ–∑–ø—ñ–∑–Ω–∞—î —Ç–∞ —Ñ—ñ–ª—å—Ç—Ä—É—î —ñ–Ω—à—ñ —É–Ω—ñ–≤–µ—Ä—Å–∏—Ç–µ—Ç–∏ —á–µ—Ä–µ–∑ –ø—Ä–æ–º–ø—Ç
        final_check_patterns = [
            r'–í–∏—Ç—Ä–∞–Ω–Ω—è', r'–ü—ñ—à—ñ—Ç—å –∑–∞', r'–ü–æ–ø–æ–≤–Ω—ñ—Ç—å—Ç–µ—Å—å', r'–í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ —ñ–Ω—Ç–µ—Ä–Ω–µ—Ç',
            r'–ö—Ä–∞—â–∏–π —à–ª—è—Ö –¥–æ —É—Å–ø—ñ—Ö—É', r'–ó–±–µ—Ä–µ–∂—ñ—Ç—å —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é', r'–ü–æ–ø–æ–≤–Ω—ñ—Ç—å—Ç–µ—Å—å —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—î—é'
        ]
        
        has_final_errors = any(re.search(pattern, response, re.IGNORECASE) for pattern in final_check_patterns)
        
        
        # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ —Ü–µ –ø–∏—Ç–∞–Ω–Ω—è –ø—Ä–æ –¥–æ–∫—É–º–µ–Ω—Ç–∏
        is_document_question = any(word in user_message.lower() for word in [
            '–¥–æ–∫—É–º–µ–Ω—Ç', '–ø–æ–¥–∞—Ç–∏', '–ø–æ–¥–∞—á–∞', '—è–∫ –ø–æ–¥–∞—Ç–∏', '–¥–µ –ø–æ–¥–∞—Ç–∏', '–∫—É–¥–∏ –ø–æ–¥–∞—Ç–∏',
            '—è–∫—ñ –¥–æ–∫—É–º–µ–Ω—Ç–∏', '—Å–ø–∏—Å–æ–∫ –¥–æ–∫—É–º–µ–Ω—Ç—ñ–≤', '–ø–æ—Ç—Ä—ñ–±–Ω—ñ –¥–æ–∫—É–º–µ–Ω—Ç–∏'
        ])
        
        # –ó–∞–º—ñ–Ω—é—î–º–æ –≤—ñ–¥–ø–æ–≤—ñ–¥—å –¢–Ü–õ–¨–ö–ò —è–∫—â–æ —î –∫—Ä–∏—Ç–∏—á–Ω—ñ –ø–æ–º–∏–ª–∫–∏
        if has_final_errors:
            # –Ø–∫—â–æ –≤—Å–µ —â–µ —î –ø–æ–º–∏–ª–∫–∏ –∞–±–æ —ñ–Ω—à—ñ —É–Ω—ñ–≤–µ—Ä—Å–∏—Ç–µ—Ç–∏ - –∑–∞–º—ñ–Ω—é—î–º–æ –Ω–∞ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É –≤—ñ–¥–ø–æ–≤—ñ–¥—å
            if is_tuition_question:
                # –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∑–Ω–∞—Ö–æ–¥–∏–º–æ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –ø—Ä–æ –≤–∞—Ä—Ç—ñ—Å—Ç—å –¥–ª—è –±—É–¥—å-—è–∫–æ—ó —Å–ø–µ—Ü—ñ–∞–ª—å–Ω–æ—Å—Ç—ñ
                from tuition_helper import find_tuition_info, extract_specialty_from_message
                
                specialty_name, specialty_code = extract_specialty_from_message(user_message)
                tuition_info = find_tuition_info(specialty_name, specialty_code)
                
                if tuition_info:
                    response = tuition_info
                else:
                    # –Ø–∫—â–æ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É —Å–ø–µ—Ü—ñ–∞–ª—å–Ω—ñ—Å—Ç—å - –¥–∞—î–º–æ –∑–∞–≥–∞–ª—å–Ω—É —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é
                    response = """–í–∞—Ä—Ç—ñ—Å—Ç—å –Ω–∞–≤—á–∞–Ω–Ω—è –≤ –•–î–£ –∑–∞–ª–µ–∂–∏—Ç—å –≤—ñ–¥ —Å–ø–µ—Ü—ñ–∞–ª—å–Ω–æ—Å—Ç—ñ, —Ñ–æ—Ä–º–∏ –Ω–∞–≤—á–∞–Ω–Ω—è —Ç–∞ —Ä—ñ–≤–Ω—è –æ—Å–≤—ñ—Ç–∏.

<b>–û—Ä—ñ—î–Ω—Ç–æ–≤–Ω—ñ —Ç–∞—Ä–∏—Ñ–∏ 2025-2026:</b>

<b>–ë–∞–∫–∞–ª–∞–≤—Ä:</b>
‚Ä¢ –î–µ–Ω–Ω–∞ —Ñ–æ—Ä–º–∞: –≤—ñ–¥ 3500 –¥–æ 4605 –≥—Ä–Ω/–º—ñ—Å—è—Ü—å
‚Ä¢ –ó–∞–æ—á–Ω–∞ —Ñ–æ—Ä–º–∞: 3500 –≥—Ä–Ω/–º—ñ—Å—è—Ü—å

<b>–ú–∞–≥—ñ—Å—Ç—Ä:</b>
‚Ä¢ –î–µ–Ω–Ω–∞ —Ñ–æ—Ä–º–∞: –≤—ñ–¥ 4000 –¥–æ 5511.90 –≥—Ä–Ω/–º—ñ—Å—è—Ü—å
‚Ä¢ –ó–∞–æ—á–Ω–∞ —Ñ–æ—Ä–º–∞: 4000 –≥—Ä–Ω/–º—ñ—Å—è—Ü—å

–î–ª—è —É—Ç–æ—á–Ω–µ–Ω–Ω—è —Ç–æ—á–Ω–æ—ó –≤–∞—Ä—Ç–æ—Å—Ç—ñ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ—ó —Å–ø–µ—Ü—ñ–∞–ª—å–Ω–æ—Å—Ç—ñ –∑–≤–µ—Ä–Ω–∏—Å—è –¥–æ –ø—Ä–∏–π–º–∞–ª—å–Ω–æ—ó –∫–æ–º—ñ—Å—ñ—ó –•–î–£:
üìû +380 552 494375, +38 095 59 29 149, +38 096 61 30 516"""
            elif is_document_question:
                response = """–î–ª—è –ø–æ–¥–∞—á—ñ –¥–æ–∫—É–º–µ–Ω—Ç—ñ–≤ –¥–æ –•–î–£ –ø–æ—Ç—Ä—ñ–±–Ω–æ:

‚Ä¢ –ó–∞—è–≤–∞ (–∑–∞ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ—é —Ñ–æ—Ä–º–æ—é –•–î–£)
‚Ä¢ –î–æ–∫—É–º–µ–Ω—Ç –ø—Ä–æ –æ—Å–≤—ñ—Ç—É (–æ—Ä–∏–≥—ñ–Ω–∞–ª –∞–±–æ –∫–æ–ø—ñ—è)
‚Ä¢ –î–æ–¥–∞—Ç–æ–∫ –¥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞ –ø—Ä–æ –æ—Å–≤—ñ—Ç—É
‚Ä¢ –§–æ—Ç–æ 3x4 (4 —à—Ç.)
‚Ä¢ –ö–æ–ø—ñ—è –ø–∞—Å–ø–æ—Ä—Ç–∞ (1-2 —Å—Ç–æ—Ä—ñ–Ω–∫–∏)
‚Ä¢ –ö–æ–ø—ñ—è —ñ–¥–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ–π–Ω–æ–≥–æ –∫–æ–¥—É
‚Ä¢ –ú–µ–¥–∏—á–Ω–∞ –¥–æ–≤—ñ–¥–∫–∞ (—Ñ–æ—Ä–º–∞ 086-–æ)
‚Ä¢ –†–µ–∑—É–ª—å—Ç–∞—Ç–∏ –ó–ù–û (—Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç)
‚Ä¢ –î–æ–∫—É–º–µ–Ω—Ç–∏ –ø—Ä–æ –æ—Å–æ–±–ª–∏–≤—ñ –ø—Ä–∞–≤–∞ (—è–∫—â–æ —î)

–î–æ–∫—É–º–µ–Ω—Ç–∏ –ø–æ–¥–∞—é—Ç—å—Å—è –∑–≥—ñ–¥–Ω–æ –∑ –≥—Ä–∞—Ñ—ñ–∫–æ–º –ú–û–ù –£–∫—Ä–∞—ó–Ω–∏. –î–ª—è —É—Ç–æ—á–Ω–µ–Ω–Ω—è –¥–µ—Ç–∞–ª–µ–π –∑–≤–µ—Ä–Ω–∏—Å—è –¥–æ –ø—Ä–∏–π–º–∞–ª—å–Ω–æ—ó –∫–æ–º—ñ—Å—ñ—ó –•–î–£:
üìû +380 552 494375, +38 095 59 29 149, +38 096 61 30 516
üìç –º. –•–µ—Ä—Å–æ–Ω, –≤—É–ª. –£–Ω—ñ–≤–µ—Ä—Å–∏—Ç–µ—Ç—Å—å–∫–∞, 27"""
            # –î–ª—è —ñ–Ω—à–∏—Ö –ø–∏—Ç–∞–Ω—å (–Ω–µ –ø—Ä–æ –≤–∞—Ä—Ç—ñ—Å—Ç—å, –Ω–µ –ø—Ä–æ –¥–æ–∫—É–º–µ–Ω—Ç–∏) - –∑–∞–º—ñ–Ω—é—î–º–æ –¢–Ü–õ–¨–ö–ò —è–∫—â–æ —î –∫—Ä–∏—Ç–∏—á–Ω—ñ –ø–æ–º–∏–ª–∫–∏
            # –Ø–∫—â–æ –≤—ñ–¥–ø–æ–≤—ñ–¥—å –∑—Ä–æ–∑—É–º—ñ–ª–∞, –Ω–∞–≤—ñ—Ç—å –∑ –Ω–µ–≤–µ–ª–∏–∫–∏–º–∏ –ø–æ–º–∏–ª–∫–∞–º–∏ - –Ω–µ –∑–∞–º—ñ–Ω—é—î–º–æ
            elif has_final_errors:
                # –¢—ñ–ª—å–∫–∏ —è–∫—â–æ —î –∫—Ä–∏—Ç–∏—á–Ω—ñ –ø–æ–º–∏–ª–∫–∏ (–Ω–µ–∑—Ä–æ–∑—É–º—ñ–ª—ñ —Å–ª–æ–≤–∞, —ñ–Ω—à—ñ —É–Ω—ñ–≤–µ—Ä—Å–∏—Ç–µ—Ç–∏)
                response = "–í–∏–±–∞—á, –Ω–µ –≤–¥–∞–ª–æ—Å—è —Å—Ñ–æ—Ä–º—É–≤–∞—Ç–∏ –∫–æ—Ä–µ–∫—Ç–Ω—É –≤—ñ–¥–ø–æ–≤—ñ–¥—å. –ü–µ—Ä–µ—Ñ–æ—Ä–º—É–ª—é–π, –±—É–¥—å –ª–∞—Å–∫–∞, –ø–∏—Ç–∞–Ω–Ω—è –∞–±–æ –∑–≤–µ—Ä–Ω–∏—Å—è –¥–æ –ø—Ä–∏–π–º–∞–ª—å–Ω–æ—ó –∫–æ–º—ñ—Å—ñ—ó –•–î–£ –∑–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–æ–º +380 552 494375."
        
        # –ö–æ–Ω–≤–µ—Ä—Ç—É—î–º–æ markdown –≤ HTML —Ñ–æ—Ä–º–∞—Ç—É–≤–∞–Ω–Ω—è
        response = _convert_markdown_to_html(response)
        
        # –û—á–∏—â–∞—î–º–æ –≤—ñ–¥ –∑–∞–π–≤–∏—Ö –ø–æ—Ä–æ–∂–Ω—ñ—Ö —Ä—è–¥–∫—ñ–≤ –ø—ñ—Å–ª—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü—ñ—ó
        response = re.sub(r'\n{3,}', '\n\n', response)
        response = response.strip()
        
        # –í–∏–¥–∞–ª—è—î–º–æ –¥—É–±–ª—ñ–∫–∞—Ç–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ (—è–∫—â–æ OLLAMA –∑–≥–µ–Ω–µ—Ä—É–≤–∞–≤ –ø–æ–≤—Ç–æ—Ä–µ–Ω–Ω—è)
        # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥—å –º—ñ—Å—Ç–∏—Ç—å –æ–¥–Ω–∞–∫–æ–≤—ñ —Ä–µ—á–µ–Ω–Ω—è –∫—ñ–ª—å–∫–∞ —Ä–∞–∑—ñ–≤ –ø—ñ–¥—Ä—è–¥
        response_lines = response.split('\n')
        seen_lines = set()
        unique_lines = []
        for line in response_lines:
            line_stripped = line.strip()
            if line_stripped and line_stripped not in seen_lines:
                seen_lines.add(line_stripped)
                unique_lines.append(line)
            elif not line_stripped:
                # –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –ø–æ—Ä–æ–∂–Ω—ñ —Ä—è–¥–∫–∏ –¥–ª—è —Ñ–æ—Ä–º–∞—Ç—É–≤–∞–Ω–Ω—è
                unique_lines.append(line)
        response = '\n'.join(unique_lines)
        
        # –í–∏–¥–∞–ª—è—î–º–æ –ø–æ–≤—Ç–æ—Ä–µ–Ω–Ω—è —Ü—ñ–ª–∏—Ö –∞–±–∑–∞—Ü—ñ–≤ (—è–∫—â–æ –æ–¥–∏–Ω —ñ —Ç–æ–π —Å–∞–º–∏–π —Ç–µ–∫—Å—Ç –ø–æ–≤—Ç–æ—Ä—é—î—Ç—å—Å—è)
        paragraphs = response.split('\n\n')
        seen_paragraphs = set()
        unique_paragraphs = []
        for para in paragraphs:
            para_stripped = para.strip()
            if para_stripped and para_stripped not in seen_paragraphs:
                seen_paragraphs.add(para_stripped)
                unique_paragraphs.append(para)
        response = '\n\n'.join(unique_paragraphs)
        
        # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥—å OLLAMA –ø—Ä–æ —Ñ–∞–∫—É–ª—å—Ç–µ—Ç–∏/—Å–ø–µ—Ü—ñ–∞–ª—å–Ω–æ—Å—Ç—ñ - –¥–æ–¥–∞—î–º–æ –∫–ª–∞–≤—ñ–∞—Ç—É—Ä—É
        # OLLAMA —Å–∞–º–∞ —Ä–æ–∑–ø—ñ–∑–Ω–∞—î –ø–∏—Ç–∞–Ω–Ω—è –ø—Ä–æ —Å–ø–µ—Ü—ñ–∞–ª—å–Ω–æ—Å—Ç—ñ —á–µ—Ä–µ–∑ –ø—Ä–æ–º–ø—Ç —ñ –≤—ñ–¥–ø–æ–≤—ñ—Å—Ç—å –ø—Ä–æ —Ñ–∞–∫—É–ª—å—Ç–µ—Ç–∏
        response_lower = response.lower()
        is_faculties_response = any(keyword in response_lower for keyword in [
            "8 —Ñ–∞–∫—É–ª—å—Ç–µ—Ç—ñ–≤", "–æ–±–µ—Ä—ñ—Ç—å —Ñ–∞–∫—É–ª—å—Ç–µ—Ç", "—Ñ–∞–∫—É–ª—å—Ç–µ—Ç–∏ —Ö–¥—É", "—Ñ–∞–∫—É–ª—å—Ç–µ—Ç —É–∫—Ä–∞—ó–Ω—Å—å–∫–æ—ó",
            "—Ñ–∞–∫—É–ª—å—Ç–µ—Ç –ø—Å–∏—Ö–æ–ª–æ–≥—ñ—ó", "–º–µ–¥–∏—á–Ω–∏–π —Ñ–∞–∫—É–ª—å—Ç–µ—Ç", "—Ñ–∞–∫—É–ª—å—Ç–µ—Ç –±—ñ–æ–ª–æ–≥—ñ—ó",
            "—Ñ–∞–∫—É–ª—å—Ç–µ—Ç —Ñ—ñ–∑–∏—á–Ω–æ–≥–æ", "–ø–µ–¥–∞–≥–æ–≥—ñ—á–Ω–∏–π —Ñ–∞–∫—É–ª—å—Ç–µ—Ç", "—Ñ–∞–∫—É–ª—å—Ç–µ—Ç –±—ñ–∑–Ω–µ—Å—É",
            "—Ñ–∞–∫—É–ª—å—Ç–µ—Ç –∫–æ–º–ø'—é—Ç–µ—Ä–Ω–∏—Ö", "—î 8 —Ñ–∞–∫—É–ª—å—Ç–µ—Ç—ñ–≤", "–≤ —Ö–¥—É —î"
        ])
        
        # –§–æ—Ä–º—É—î–º–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∑ –ø—Ä–∞–≤–∏–ª—å–Ω–∏–º —Ñ–æ—Ä–º–∞—Ç—É–≤–∞–Ω–Ω—è–º (HTML)
        message_text = f"üí¨ <b>–í—ñ–¥–ø–æ–≤—ñ–¥—å:</b>\n\n{response}\n\nüí° –ú–æ–∂–µ—à –∑–∞–¥–∞—Ç–∏ —â–µ –ø–∏—Ç–∞–Ω–Ω—è –∞–±–æ –Ω–∞—Ç–∏—Å–Ω—É—Ç–∏ '‚¨ÖÔ∏è –ù–∞–∑–∞–¥' –¥–ª—è –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è –¥–æ –º–µ–Ω—é"
        
        # –Ø–∫—â–æ –≤—Å–µ —â–µ –∑–∞–Ω–∞–¥—Ç–æ –¥–æ–≤–≥–æ, –æ–±—Ä—ñ–∑–∞—î–º–æ —â–µ –±—ñ–ª—å—à–µ
        if len(message_text) > 4096:
            # –û–±—Ä—ñ–∑–∞—î–º–æ –≤—ñ–¥–ø–æ–≤—ñ–¥—å —Ç–∞–∫, —â–æ–± –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤–º—ñ—Å—Ç–∏–ª–æ—Å—è
            available_length = 4096 - len("üí¨ <b>–í—ñ–¥–ø–æ–≤—ñ–¥—å:</b>\n\n\nüí° –ú–æ–∂–µ—à –∑–∞–¥–∞—Ç–∏ —â–µ –ø–∏—Ç–∞–Ω–Ω—è –∞–±–æ –Ω–∞—Ç–∏—Å–Ω—É—Ç–∏ '‚¨ÖÔ∏è –ù–∞–∑–∞–¥' –¥–ª—è –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è –¥–æ –º–µ–Ω—é")
            response = response[:available_length] + "\n\n... (–ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –æ–±—Ä—ñ–∑–∞–Ω–æ)"
            message_text = f"üí¨ <b>–í—ñ–¥–ø–æ–≤—ñ–¥—å:</b>\n\n{response}\n\nüí° –ú–æ–∂–µ—à –∑–∞–¥–∞—Ç–∏ —â–µ –ø–∏—Ç–∞–Ω–Ω—è –∞–±–æ –Ω–∞—Ç–∏—Å–Ω—É—Ç–∏ '‚¨ÖÔ∏è –ù–∞–∑–∞–¥' –¥–ª—è –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è –¥–æ –º–µ–Ω—é"
        
        # –í–∏–∑–Ω–∞—á–∞—î–º–æ –∫–ª–∞–≤—ñ–∞—Ç—É—Ä—É: —è–∫—â–æ –≤—ñ–¥–ø–æ–≤—ñ–¥—å –ø—Ä–æ —Ñ–∞–∫—É–ª—å—Ç–µ—Ç–∏ - –¥–æ–¥–∞—î–º–æ –∫–ª–∞–≤—ñ–∞—Ç—É—Ä—É –≤–∏–±–æ—Ä—É —Ñ–∞–∫—É–ª—å—Ç–µ—Ç—É
        reply_markup = None
        if is_faculties_response:
            reply_markup = get_faculties_keyboard(report_id=message_history_id)
        elif message_history_id:
            reply_markup = get_feedback_keyboard(message_history_id)
        
        # –û–Ω–æ–≤–ª—é—î–º–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∑ inline –∫–Ω–æ–ø–∫–∞–º–∏ –¥–ª—è –æ—Ü—ñ–Ω–∫–∏ –∞–±–æ –≤–∏–±–æ—Ä—É —Ñ–∞–∫—É–ª—å—Ç–µ—Ç—É
        await bot_message.edit_text(
            message_text,
            reply_markup=reply_markup,
            parse_mode="HTML"
        )
    except Exception as e:
        # –õ–æ–≥—É—î–º–æ –ø–æ–º–∏–ª–∫—É –¥–ª—è –¥—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
        logger.error(f"–ü–æ–º–∏–ª–∫–∞ –≤ chat_handler: {e}", exc_info=True)
        
        # –î–ª—è –ø–æ–º–∏–ª–æ–∫ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ answer –∑–∞–º—ñ—Å—Ç—å edit_text
        try:
            await bot_message.delete()
        except:
            pass
        
        await message.answer(
            f"‚ùå –í–∏–±–∞—á, —Å—Ç–∞–ª–∞—Å—è –ø–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –æ–±—Ä–æ–±—Ü—ñ –ø–∏—Ç–∞–Ω–Ω—è.\n\n"
            f"–î–µ—Ç–∞–ª—ñ: {str(e)}\n\n"
            "–°–ø—Ä–æ–±—É–π —â–µ —Ä–∞–∑ –∞–±–æ –∑–≤–µ—Ä–Ω–∏—Å—è –¥–æ –ø—Ä–∏–π–º–∞–ª—å–Ω–æ—ó –∫–æ–º—ñ—Å—ñ—ó –•–î–£:\n"
            "üìû +380 552 494375",
            reply_markup=get_back_keyboard()
        )



