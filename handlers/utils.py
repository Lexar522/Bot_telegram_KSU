"""
–°–ø—ñ–ª—å–Ω—ñ —É—Ç–∏–ª—ñ—Ç–∏ –¥–ª—è –æ–±—Ä–æ–±–Ω–∏–∫—ñ–≤
"""
import os
import json
import time
import logging
from pathlib import Path

logger = logging.getLogger(__name__)

# region agent log helper (debug)
DEBUG_LOG_PATH = os.getenv(
    "DEBUG_LOG_PATH",
    str(Path(__file__).parent.parent / ".cursor" / "debug.log")
)

def _agent_log(hypothesis_id: str, location: str, message: str, data: dict):
    """–õ–æ–≥—É–≤–∞–Ω–Ω—è –¥–ª—è –¥–µ–±–∞–≥—É"""
    try:
        payload = {
            "sessionId": "debug-session",
            "runId": "run1",
            "hypothesisId": hypothesis_id,
            "location": location,
            "message": message,
            "data": data,
            "timestamp": int(time.time() * 1000),
        }
        os.makedirs(os.path.dirname(DEBUG_LOG_PATH), exist_ok=True)
        with open(DEBUG_LOG_PATH, "a", encoding="utf-8") as f:
            f.write(json.dumps(payload, ensure_ascii=False) + "\n")
    except Exception:
        pass
# endregion


def _format_admission_2026(info: dict) -> str:
    """–§–æ—Ä–º–∞—Ç—É—î —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–≤–∞–Ω—É —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –ø—Ä–æ –≤—Å—Ç—É–ø 2026 –≤ –∫–æ—Ä–æ—Ç–∫—É –≤—ñ–¥–ø–æ–≤—ñ–¥—å"""
    parts = []
    parts.append("üìò –ü—Ä–∞–≤–∏–ª–∞ –≤—Å—Ç—É–ø—É –¥–æ –•–î–£ —É 2026 —Ä–æ—Ü—ñ")
    if info.get("description"):
        parts.append(info["description"])

    nmt = info.get("nmt", {})
    if nmt:
        subjects = nmt.get("subjects", [])
        if subjects:
            parts.append("üß™ –ù–ú–¢: —Ç—Ä–∏ –ø—Ä–µ–¥–º–µ—Ç–∏ (1 –æ–±–æ–≤'—è–∑–∫–æ–≤–∏–π + 2 –Ω–∞ –≤–∏–±—ñ—Ä):")
            parts.extend([f" ‚Ä¢ {s}" for s in subjects])
        if nmt.get("valid_years"):
            years = ", ".join(str(y) for y in nmt["valid_years"])
            parts.append(f"üìÖ –†–µ–∑—É–ª—å—Ç–∞—Ç–∏ –ù–ú–¢ –≤—Ä–∞—Ö–æ–≤—É—é—Ç—å—Å—è –∑–∞ {years}")

    traj = info.get("trajectories", {})
    if traj:
        tparts = []
        for key, val in traj.items():
            if isinstance(val, str):
                tparts.append(f" ‚Ä¢ {val}")
        if tparts:
            parts.append("üéØ –¢—Ä–∞—î–∫—Ç–æ—Ä—ñ—ó –≤—Å—Ç—É–ø—É:")
            parts.extend(tparts)

    campaign = info.get("campaign", {})
    if campaign:
        if campaign.get("period"):
            parts.append(f"‚è∞ –ü–µ—Ä—ñ–æ–¥ –∫–∞–º–ø–∞–Ω—ñ—ó: {campaign['period']}")
        if campaign.get("important"):
            parts.append(f"‚ùó –í–∞–∂–ª–∏–≤–æ: {campaign['important']}")
        if campaign.get("advice"):
            parts.append(f"‚ÑπÔ∏è –ü–æ—Ä–∞–¥–∞: {campaign['advice']}")

    cabinet = info.get("electronic_cabinets", {})
    if cabinet:
        if cabinet.get("platform"):
            parts.append(f"üíª –ï-–∫–∞–±—ñ–Ω–µ—Ç: {cabinet['platform']}")
        if cabinet.get("note"):
            parts.append(f"üîê {cabinet['note']}")
        if cabinet.get("support"):
            parts.append(f"üÜò {cabinet['support']}")

    support = info.get("support", {})
    if support:
        if support.get("defenders"):
            parts.append(f"üéñÔ∏è –ó–∞—Ö–∏—Å–Ω–∏–∫–∏: {support['defenders']}")
        if support.get("tot"):
            parts.append(f"üè† –¢–û–¢: {support['tot']}")
        if support.get("contacts"):
            parts.append(f"‚òéÔ∏è –ö–æ–Ω—Ç–∞–∫—Ç–∏ –ø—ñ–¥—Ç—Ä–∏–º–∫–∏: {support['contacts']}")

    if info.get("important_note"):
        parts.append(f"üìå {info['important_note']}")

    parts.append("üìû –ü—Ä–∏–π–º–∞–ª—å–Ω–∞ –∫–æ–º—ñ—Å—ñ—è –•–î–£: +380 552 494375, +38 095 59 29 149, +38 096 61 30 516")
    return "\n".join(parts)


def _check_and_fix_forbidden_universities(response: str, user_message: str) -> str:
    """
    –ö–†–ò–¢–ò–ß–ù–û –í–ê–ñ–õ–ò–í–ê –§–£–ù–ö–¶–Ü–Ø: –ü–µ—Ä–µ–≤—ñ—Ä—è—î –≤—ñ–¥–ø–æ–≤—ñ–¥—å –Ω–∞ –∑–∞–±–æ—Ä–æ–Ω–µ–Ω—ñ —É–Ω—ñ–≤–µ—Ä—Å–∏—Ç–µ—Ç–∏
    –Ø–∫—â–æ –∑–Ω–∞–π–¥–µ–Ω–æ - –ê–í–¢–û–ú–ê–¢–ò–ß–ù–û –∑–∞–º—ñ–Ω—é—î –Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—É –≤—ñ–¥–ø–æ–≤—ñ–¥—å –∑ –±–∞–∑–∏ –∑–Ω–∞–Ω—å
    """
    import re
    response_lower = response.lower()
    user_message_lower = user_message.lower()
    
    # –í–°–Ü –∑–∞–±–æ—Ä–æ–Ω–µ–Ω—ñ —É–Ω—ñ–≤–µ—Ä—Å–∏—Ç–µ—Ç–∏ (–ø–æ–≤–Ω–∏–π —Å–ø–∏—Å–æ–∫!)
    forbidden_patterns = [
        r"—Ö–Ω—Ç—É[^.]*", r"—ñ–≤–∞–Ω–∞ —Å—ñ–∫–æ—Ä—Å—å–∫–æ–≥–æ[^.]*", r"—Å—ñ–∫–æ—Ä—Å—å–∫–æ–≥–æ[^.]*",
        r"—Ö–∞—Ä–∫—ñ–≤—Å—å–∫–∏–π[^.]*—É–Ω—ñ–≤–µ—Ä—Å–∏—Ç–µ—Ç[^.]*", r"\b—Ö–Ω—É\b", r"—Ö–∞—Ä–Ω—É[^.]*",
        r"–∫–∏—ó–≤—Å—å–∫–∏–π[^.]*—É–Ω—ñ–≤–µ—Ä—Å–∏—Ç–µ—Ç[^.]*", r"\b–∫–Ω—É\b", r"\b–∫–ø—ñ\b",
        r"–ª—å–≤—ñ–≤—Å—å–∫–∏–π[^.]*—É–Ω—ñ–≤–µ—Ä—Å–∏—Ç–µ—Ç[^.]*", r"–æ–¥–µ—Å—å–∫–∏–π[^.]*—É–Ω—ñ–≤–µ—Ä—Å–∏—Ç–µ—Ç[^.]*",
        r"–±—ñ–ª–æ—Å—Ç–æ–∫[^.]*", r"–º—ñ—Ü–∫–µ–≤–∏—á[^.]*", r"–ª–µ—Å—è –ø–æ–±–µ–¥–∏–º–æ–≤–∞[^.]*",
        r"–¥–Ω—ñ–ø—Ä–æ–≤—Å—å–∫–∏–π[^.]*—É–Ω—ñ–≤–µ—Ä—Å–∏—Ç–µ—Ç[^.]*", r"–∑–∞–ø–æ—Ä—ñ–∑—å–∫–∏–π[^.]*—É–Ω—ñ–≤–µ—Ä—Å–∏—Ç–µ—Ç[^.]*"
    ]
    
    # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ —î –∑–∞–±–æ—Ä–æ–Ω–µ–Ω—ñ —É–Ω—ñ–≤–µ—Ä—Å–∏—Ç–µ—Ç–∏
    has_forbidden = False
    for pattern in forbidden_patterns:
        if re.search(pattern, response_lower, re.IGNORECASE):
            has_forbidden = True
            break
    
    # –Ø–∫—â–æ –∑–Ω–∞–π–¥–µ–Ω–æ –∑–∞–±–æ—Ä–æ–Ω–µ–Ω—ñ —É–Ω—ñ–≤–µ—Ä—Å–∏—Ç–µ—Ç–∏ - –ó–ê–ú–Ü–ù–Æ–Ñ–ú–û –Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—É –≤—ñ–¥–ø–æ–≤—ñ–¥—å
    if has_forbidden:
        # –í–∏–∑–Ω–∞—á–∞—î–º–æ —Ç–∏–ø –ø–∏—Ç–∞–Ω–Ω—è –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ—ó –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ
        if any(word in user_message_lower for word in ["–ø—Ä–æ–≥—Ä–∞–º—É–≤–∞–Ω–Ω—è", "–ø—Ä–æ–≥—Ä–∞–º—ñ—Å—Ç", "—ñ—Ç", "—ñ–Ω—Ñ–æ—Ä–º–∞—Ç–∏–∫–∞", "–∫–æ–º–ø'—é—Ç–µ—Ä", "–ø—Ä–æ–≥—Ä–∞–º–Ω–µ", "121", "f6", "f2", "f3"]):
            return "–í –•–î–£ —î —Ç–∞–∫—ñ —Å–ø–µ—Ü—ñ–∞–ª—å–Ω–æ—Å—Ç—ñ –∑ –ø—Ä–æ–≥—Ä–∞–º—É–≤–∞–Ω–Ω—è —Ç–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ–π–Ω–∏—Ö —Ç–µ—Ö–Ω–æ–ª–æ–≥—ñ–π: –Ü–Ω–∂–µ–Ω–µ—Ä—ñ—è –ø—Ä–æ–≥—Ä–∞–º–Ω–æ–≥–æ –∑–∞–±–µ–∑–ø–µ—á–µ–Ω–Ω—è (F2), –ö–æ–º–ø'—é—Ç–µ—Ä–Ω—ñ –Ω–∞—É–∫–∏ (F3), –Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ–π–Ω—ñ —Å–∏—Å—Ç–µ–º–∏ —Ç–∞ —Ç–µ—Ö–Ω–æ–ª–æ–≥—ñ—ó (F6, –∫–æ–¥ 121). –î–µ—Ç–∞–ª—å–Ω—ñ—à–µ: +380 552 494375 üíª"
        
        elif any(word in user_message_lower for word in ["–º–µ–¥–∏—Ü–∏–Ω–∞", "–º–µ–¥–∏—á–Ω—ñ", "–ª—ñ–∫–∞—Ä", "—Ñ–∞—Ä–º–∞—Ü—ñ—è", "—Ä–µ–∞–±—ñ–ª—ñ—Ç–∞—Ü—ñ—è"]):
            return "–í –•–î–£ —î —Ç–∞–∫—ñ —Å–ø–µ—Ü—ñ–∞–ª—å–Ω–æ—Å—Ç—ñ –∑ –æ—Ö–æ—Ä–æ–Ω–∏ –∑–¥–æ—Ä–æ–≤'—è: –§—ñ–∑–∏—á–Ω–∞ —Ç–µ—Ä–∞–ø—ñ—è, –µ—Ä–≥–æ—Ç–µ—Ä–∞–ø—ñ—è (–±–∞–∫–∞–ª–∞–≤—Ä), –°–æ—Ü—ñ–∞–ª—å–Ω–∞ —Ä–æ–±–æ—Ç–∞ —Ç–∞ –∫–æ–Ω—Å—É–ª—å—Ç—É–≤–∞–Ω–Ω—è (–±–∞–∫–∞–ª–∞–≤—Ä), –ú–µ–¥–∏—Ü–∏–Ω–∞ (–º–∞–≥—ñ—Å—Ç—Ä), –§—ñ–∑–∏—á–Ω–∞ —Ä–µ–∞–±—ñ–ª—ñ—Ç–∞—Ü—ñ—è (–º–∞–≥—ñ—Å—Ç—Ä), –§–∞—Ä–º–∞—Ü—ñ—è (–º–∞–≥—ñ—Å—Ç—Ä). –î–µ—Ç–∞–ª—å–Ω—ñ—à–µ: +380 552 494375 üè•"
        
        elif any(word in user_message_lower for word in ["–æ—Å–≤—ñ—Ç–∞", "–ø–µ–¥–∞–≥–æ–≥—ñ–∫–∞", "–≤—á–∏—Ç–µ–ª—å", "–¥–æ—à–∫—ñ–ª—å–Ω–∞", "–ø–æ—á–∞—Ç–∫–æ–≤–∞"]):
            return "–í –•–î–£ —î —Ç–∞–∫—ñ —Å–ø–µ—Ü—ñ–∞–ª—å–Ω–æ—Å—Ç—ñ –∑ –æ—Å–≤—ñ—Ç–∏ —Ç–∞ –ø–µ–¥–∞–≥–æ–≥—ñ–∫–∏: –î–æ—à–∫—ñ–ª—å–Ω–∞ –æ—Å–≤—ñ—Ç–∞, –ü–æ—á–∞—Ç–∫–æ–≤–∞ –æ—Å–≤—ñ—Ç–∞, –°–ø–µ—Ü—ñ–∞–ª—å–Ω–∞ –æ—Å–≤—ñ—Ç–∞ (–õ–æ–≥–æ–ø–µ–¥—ñ—è, –û–ª—ñ–≥–æ—Ñ—Ä–µ–Ω–æ–ø–µ–¥–∞–≥–æ–≥—ñ–∫–∞), –°–µ—Ä–µ–¥–Ω—è –æ—Å–≤—ñ—Ç–∞ (—Ä—ñ–∑–Ω—ñ —Å–ø–µ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó), –§—ñ–∑–∏—á–Ω–∞ –∫—É–ª—å—Ç—É—Ä–∞ —ñ —Å–ø–æ—Ä—Ç. –î–µ—Ç–∞–ª—å–Ω—ñ—à–µ: +380 552 494375 üéì"
        
        elif any(word in user_message_lower for word in ["–ø—Ä–∞–≤–æ", "—é—Ä–∏—Å—Ç", "—é—Ä–∏—Å–ø—Ä—É–¥–µ–Ω—Ü—ñ—è"]):
            return "–í –•–î–£ —î —Å–ø–µ—Ü—ñ–∞–ª—å–Ω—ñ—Å—Ç—å –ü—Ä–∞–≤–æ (D8) –Ω–∞ —Ä—ñ–≤–Ω—è—Ö –±–∞–∫–∞–ª–∞–≤—Ä–∞ —Ç–∞ –º–∞–≥—ñ—Å—Ç—Ä–∞. –î–µ—Ç–∞–ª—å–Ω—ñ—à–µ: +380 552 494375 ‚öñÔ∏è"
        
        elif any(word in user_message_lower for word in ["–µ–∫–æ–Ω–æ–º—ñ–∫–∞", "–±—ñ–∑–Ω–µ—Å", "–º–µ–Ω–µ–¥–∂–º–µ–Ω—Ç", "—Ñ—ñ–Ω–∞–Ω—Å–∏"]):
            return "–í –•–î–£ —î —Ç–∞–∫—ñ —Å–ø–µ—Ü—ñ–∞–ª—å–Ω–æ—Å—Ç—ñ –∑ –±—ñ–∑–Ω–µ—Å—É —Ç–∞ –µ–∫–æ–Ω–æ–º—ñ–∫–∏: –ï–∫–æ–Ω–æ–º—ñ–∫–∞ (–°1.01), –ú–µ–Ω–µ–¥–∂–º–µ–Ω—Ç (D3), –§—ñ–Ω–∞–Ω—Å–∏, –±–∞–Ω–∫—ñ–≤—Å—å–∫–∞ —Å–ø—Ä–∞–≤–∞ —Ç–∞ —Å—Ç—Ä–∞—Ö—É–≤–∞–Ω–Ω—è (D2), –ü—ñ–¥–ø—Ä–∏—î–º–Ω–∏—Ü—Ç–≤–æ —Ç–∞ —Ç–æ—Ä–≥—ñ–≤–ª—è (D7). –î–µ—Ç–∞–ª—å–Ω—ñ—à–µ: +380 552 494375 üíº"
        
        elif any(word in user_message_lower for word in ["–ø—Å–∏—Ö–æ–ª–æ–≥—ñ—è", "–ø—Å–∏—Ö–æ–ª–æ–≥"]):
            return "–í –•–î–£ —î —Å–ø–µ—Ü—ñ–∞–ª—å–Ω—ñ—Å—Ç—å –ü—Å–∏—Ö–æ–ª–æ–≥—ñ—è (–°4) –Ω–∞ —Ä—ñ–≤–Ω—è—Ö –±–∞–∫–∞–ª–∞–≤—Ä–∞ —Ç–∞ –º–∞–≥—ñ—Å—Ç—Ä–∞. –î–µ—Ç–∞–ª—å–Ω—ñ—à–µ: +380 552 494375 üß†"
        
        elif any(word in user_message_lower for word in ["—Å–ø–µ—Ü—ñ–∞–ª—å–Ω–æ—Å—Ç—ñ", "—Å–ø–µ—Ü—ñ–∞–ª—å–Ω—ñ—Å—Ç—å", "—Ñ–∞–∫—É–ª—å—Ç–µ—Ç–∏", "—Ñ–∞–∫—É–ª—å—Ç–µ—Ç"]):
            # –ó–∞–≥–∞–ª—å–Ω–µ –ø–∏—Ç–∞–Ω–Ω—è –ø—Ä–æ —Å–ø–µ—Ü—ñ–∞–ª—å–Ω–æ—Å—Ç—ñ
            return "–í –•–î–£ —î 8 —Ñ–∞–∫—É–ª—å—Ç–µ—Ç—ñ–≤ –∑ —à–∏—Ä–æ–∫–∏–º —Å–ø–µ–∫—Ç—Ä–æ–º —Å–ø–µ—Ü—ñ–∞–ª—å–Ω–æ—Å—Ç–µ–π —É –≥–∞–ª—É–∑—è—Ö: –æ—Å–≤—ñ—Ç–∞ —Ç–∞ –ø–µ–¥–∞–≥–æ–≥—ñ–∫–∞, –∫—É–ª—å—Ç—É—Ä–∞ —Ç–∞ –º–∏—Å—Ç–µ—Ü—Ç–≤–æ, —Å–æ—Ü—ñ–∞–ª—å–Ω—ñ –Ω–∞—É–∫–∏, –±—ñ–∑–Ω–µ—Å —Ç–∞ –ø—Ä–∞–≤–æ, –ø—Ä–∏—Ä–æ–¥–Ω–∏—á—ñ –Ω–∞—É–∫–∏, —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ–π–Ω—ñ —Ç–µ—Ö–Ω–æ–ª–æ–≥—ñ—ó, –æ—Ö–æ—Ä–æ–Ω–∞ –∑–¥–æ—Ä–æ–≤'—è, —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç —Ç–∞ –ø–æ—Å–ª—É–≥–∏. –û–±–µ—Ä–∏ —Ñ–∞–∫—É–ª—å—Ç–µ—Ç –¥–ª—è –ø–µ—Ä–µ–≥–ª—è–¥—É —Å–ø–µ—Ü—ñ–∞–ª—å–Ω–æ—Å—Ç–µ–π üéì"
        
        else:
            # –ó–∞–≥–∞–ª—å–Ω–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—å —è–∫—â–æ –Ω–µ –≤–¥–∞–ª–æ—Å—è –≤–∏–∑–Ω–∞—á–∏—Ç–∏ —Ç–∏–ø
            return "–ù–∞ –∂–∞–ª—å, –Ω–µ –≤–¥–∞–ª–æ—Å—è —Å—Ñ–æ—Ä–º—É–≤–∞—Ç–∏ –∫–æ—Ä–µ–∫—Ç–Ω—É –≤—ñ–¥–ø–æ–≤—ñ–¥—å. –ó–≤–µ—Ä–Ω–∏—Å—è –¥–æ –ø—Ä–∏–π–º–∞–ª—å–Ω–æ—ó –∫–æ–º—ñ—Å—ñ—ó –•–î–£ –∑–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–æ–º +380 552 494375 –¥–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –∞–∫—Ç—É–∞–ª—å–Ω–æ—ó —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó."
    
    return response  # –Ø–∫—â–æ –≤—Å–µ –¥–æ–±—Ä–µ - –ø–æ–≤–µ—Ä—Ç–∞—î–º–æ –æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω—É –≤—ñ–¥–ø–æ–≤—ñ–¥—å


def _convert_markdown_to_html(text: str) -> str:
    """
    –ö–æ–Ω–≤–µ—Ä—Ç—É—î markdown —Ñ–æ—Ä–º–∞—Ç—É–≤–∞–Ω–Ω—è –≤ HTML –¥–ª—è Telegram
    
    Args:
        text: –¢–µ–∫—Å—Ç –∑ markdown —Ñ–æ—Ä–º–∞—Ç—É–≤–∞–Ω–Ω—è–º
    
    Returns:
        –¢–µ–∫—Å—Ç –∑ HTML —Ñ–æ—Ä–º–∞—Ç—É–≤–∞–Ω–Ω—è–º
    """
    import re
    
    if not text:
        return text
    
    # –°–ø–æ—á–∞—Ç–∫—É –æ–±—Ä–æ–±–ª—è—î–º–æ –º–∞—Ä–∫–µ—Ä–∏ —Å–ø–∏—Å–∫—É –Ω–∞ –ø–æ—á–∞—Ç–∫—É —Ä—è–¥–∫–∞ (—â–æ–± –Ω–µ –∫–æ–Ω—Ñ–ª—ñ–∫—Ç—É–≤–∞–ª–∏ –∑ —Ñ–æ—Ä–º–∞—Ç—É–≤–∞–Ω–Ω—è–º)
    text = re.sub(r'^\s*\*\s+', '‚Ä¢ ', text, flags=re.MULTILINE)
    text = re.sub(r'^\s*-\s+', '‚Ä¢ ', text, flags=re.MULTILINE)
    
    # –û–±—Ä–æ–±–ª—è—î–º–æ –∂–∏—Ä–Ω–∏–π —Ç–µ–∫—Å—Ç (**—Ç–µ–∫—Å—Ç**)
    # –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ non-greedy match –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –æ–±—Ä–æ–±–∫–∏ –≤–∫–ª–∞–¥–µ–Ω–∏—Ö —Ç–µ–≥—ñ–≤
    text = re.sub(r'\*\*([^*]+?)\*\*', r'<b>\1</b>', text)
    
    # –û–±—Ä–æ–±–ª—è—î–º–æ –∫—É—Ä—Å–∏–≤ (*—Ç–µ–∫—Å—Ç*), –∞–ª–µ —Ç—ñ–ª—å–∫–∏ —è–∫—â–æ —Ü–µ –Ω–µ –º–∞—Ä–∫–µ—Ä —Å–ø–∏—Å–∫—É
    # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —â–æ –∑—ñ—Ä–æ—á–∫–∞ –Ω–µ –Ω–∞ –ø–æ—á–∞—Ç–∫—É —Ä—è–¥–∫–∞ —ñ –Ω–µ —î —á–∞—Å—Ç–∏–Ω–æ—é **
    text = re.sub(r'(?<!\*)\*([^*\n\s][^*\n]*?[^*\n\s])\*(?!\*)', r'<i>\1</i>', text)
    
    # –í–∏–¥–∞–ª—è—î–º–æ –∑–∞–ª–∏—à–∫–æ–≤—ñ –æ–¥–∏–Ω–∞—Ä–Ω—ñ –∑—ñ—Ä–æ—á–∫–∏, —è–∫—ñ –Ω–µ —î —á–∞—Å—Ç–∏–Ω–æ—é —Ñ–æ—Ä–º–∞—Ç—É–≤–∞–Ω–Ω—è
    # (—è–∫—â–æ –≤–æ–Ω–∏ –Ω–µ –Ω–∞ –ø–æ—á–∞—Ç–∫—É —Ä—è–¥–∫–∞ —ñ –Ω–µ —î —á–∞—Å—Ç–∏–Ω–æ—é **)
    text = re.sub(r'(?<!\*)\*(?!\*)(?![*<b>i>])', '', text)
    
    # –í–∏–¥–∞–ª—è—î–º–æ –ø–æ–¥–≤—ñ–π–Ω—ñ –ø–æ—Ä–æ–∂–Ω—ñ —Ä—è–¥–∫–∏
    text = re.sub(r'\n{3,}', '\n\n', text)
    
    return text.strip()



