"""
–û–±—Ä–æ–±–Ω–∏–∫–∏ –∫–Ω–æ–ø–æ–∫ –º–µ–Ω—é
"""
from aiogram import Router, F
from aiogram.types import Message
from database import db
from knowledge_base import get_knu_contacts
from keyboards import (
    get_main_menu, get_back_keyboard, get_settings_keyboard,
    get_reminders_management_keyboard
)

router = Router()


@router.message(F.text.in_(["üìö –ü–æ—Ä–∞–¥–∏", "üìö –ü–æ—Ä–∞–¥–∏ —â–æ–¥–æ –≤—Å—Ç—É–ø—É"]))
async def get_advice_handler(message: Message):
    """–û–±—Ä–æ–±–∫–∞ –∑–∞–ø–∏—Ç—É –Ω–∞ –ø–æ—Ä–∞–¥–∏"""
    await message.answer("‚è≥ –§–æ—Ä–º—É—é –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ñ –ø–æ—Ä–∞–¥–∏ –¥–ª—è —Ç–µ–±–µ...")
    
    # –û—Ç—Ä–∏–º—É—î–º–æ —Å–ø–µ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—é –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
    user = await db.get_user(message.from_user.id)
    specialization = user.get("specialization") if user else None
    
    # –§–æ—Ä–º—É—î–º–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–≤–∞–Ω—É –≤—ñ–¥–ø–æ–≤—ñ–¥—å –≤—Ä—É—á–Ω—É
    response_text = "üìö <b>–ü–æ—Ä–∞–¥–∏ —â–æ–¥–æ –≤—Å—Ç—É–ø—É –¥–æ –•–î–£</b>\n\n"
    
    # 1. –ó–∞—è–≤–∞ –¥–ª—è –≤—Å—Ç—É–ø—É –¥–æ –•–î–£
    response_text += "<b>–ó–∞—è–≤–∞ –¥–ª—è –≤—Å—Ç—É–ø—É –¥–æ –•–î–£</b>\n\n"
    response_text += "–î–ª—è –ø–æ–¥–∞—á—ñ –∑–∞—è–≤–∏ –ø–æ—Ç—Ä—ñ–±–Ω—ñ —Ç–∞–∫—ñ –¥–æ–∫—É–º–µ–Ω—Ç–∏:\n"
    response_text += "‚Ä¢ –ó–∞—è–≤–∞ (–∑–∞ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ—é —Ñ–æ—Ä–º–æ—é –•–î–£)\n"
    response_text += "‚Ä¢ –î–æ–∫—É–º–µ–Ω—Ç –ø—Ä–æ –æ—Å–≤—ñ—Ç—É (–æ—Ä–∏–≥—ñ–Ω–∞–ª –∞–±–æ –∫–æ–ø—ñ—è)\n"
    response_text += "‚Ä¢ –î–æ–¥–∞—Ç–æ–∫ –¥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞ –ø—Ä–æ –æ—Å–≤—ñ—Ç—É\n"
    response_text += "‚Ä¢ –§–æ—Ç–æ 3x4 (4 —à—Ç.)\n"
    response_text += "‚Ä¢ –ö–æ–ø—ñ—è –ø–∞—Å–ø–æ—Ä—Ç–∞ (1-2 —Å—Ç–æ—Ä—ñ–Ω–∫–∏)\n"
    response_text += "‚Ä¢ –ö–æ–ø—ñ—è —ñ–¥–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ–π–Ω–æ–≥–æ –∫–æ–¥—É\n"
    response_text += "‚Ä¢ –ú–µ–¥–∏—á–Ω–∞ –¥–æ–≤—ñ–¥–∫–∞ (—Ñ–æ—Ä–º–∞ 086-–æ)\n"
    response_text += "‚Ä¢ –†–µ–∑—É–ª—å—Ç–∞—Ç–∏ –ó–ù–û (—Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç)\n"
    response_text += "‚Ä¢ –î–æ–∫—É–º–µ–Ω—Ç–∏ –ø—Ä–æ –æ—Å–æ–±–ª–∏–≤—ñ –ø—Ä–∞–≤–∞ (—è–∫—â–æ —î)\n\n"
    response_text += "<i>–í–∞–∂–ª–∏–≤–æ:</i> –ü–µ—Ä–µ–≤—ñ—Ä –∞–∫—Ç—É–∞–ª—å–Ω–∏–π —Å–ø–∏—Å–æ–∫ –Ω–∞ –æ—Ñ—ñ—Ü—ñ–π–Ω–æ–º—É —Å–∞–π—Ç—ñ –•–î–£ –∞–±–æ –∑–≤–µ—Ä–Ω–∏—Å—è –¥–æ –ø—Ä–∏–π–º–∞–ª—å–Ω–æ—ó –∫–æ–º—ñ—Å—ñ—ó.\n\n"
    
    # 2. –í–∞–∂–ª–∏–≤—ñ –¥–∞—Ç–∏ –¥–ª—è –≤—Å—Ç—É–ø—É
    response_text += "<b>–í–∞–∂–ª–∏–≤—ñ –¥–∞—Ç–∏ –¥–ª—è –≤—Å—Ç—É–ø—É</b>\n\n"
    response_text += "‚Ä¢ –ü–æ–¥–∞—á–∞ –¥–æ–∫—É–º–µ–Ω—Ç—ñ–≤: –∑–≥—ñ–¥–Ω–æ –∑ –≥—Ä–∞—Ñ—ñ–∫–æ–º –ú–û–ù –£–∫—Ä–∞—ó–Ω–∏\n"
    response_text += "‚Ä¢ –ö–æ–Ω–∫—É—Ä—Å–Ω–∏–π –≤—ñ–¥–±—ñ—Ä: –ø—ñ—Å–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è –ø–æ–¥–∞—á—ñ –¥–æ–∫—É–º–µ–Ω—Ç—ñ–≤\n"
    response_text += "‚Ä¢ –í–∞—Ä—Ç—ñ—Å—Ç—å –Ω–∞–≤—á–∞–Ω–Ω—è 2025-2026 –Ω–∞–≤—á–∞–ª—å–Ω–æ–≥–æ —Ä–æ–∫—É: —É—Ç–æ—á–Ω—é–π –≤ –ø—Ä–∏–π–º–∞–ª—å–Ω—ñ–π –∫–æ–º—ñ—Å—ñ—ó\n"
    response_text += "‚Ä¢ –î–µ–¥–ª–∞–π–Ω: –ø–µ—Ä–µ–¥–±–∞—á–∞—î—Ç—å—Å—è –ø—ñ–¥ —á–∞—Å –ø–æ–¥–∞—á—ñ –∑–∞—è–≤–∫–∏\n\n"
    
    # 3. –ö–æ–Ω—Ç–∞–∫—Ç–∏ –ø—Ä–∏–π–º–∞–ª—å–Ω–æ—ó –∫–æ–º—ñ—Å—ñ—ó
    response_text += "<b>–ö–æ–Ω—Ç–∞–∫—Ç–∏ –ø—Ä–∏–π–º–∞–ª—å–Ω–æ—ó –∫–æ–º—ñ—Å—ñ—ó</b>\n\n"
    response_text += "‚Ä¢ –¢–µ–ª–µ—Ñ–æ–Ω: +380 552 494375\n"
    response_text += "‚Ä¢ –¢–µ–ª–µ—Ñ–æ–Ω: +38 095 59 29 149\n"
    response_text += "‚Ä¢ –¢–µ–ª–µ—Ñ–æ–Ω: +38 096 61 30 516\n"
    response_text += "‚Ä¢ –ê–¥—Ä–µ—Å–∞: –º. –•–µ—Ä—Å–æ–Ω, –≤—É–ª. –£–Ω—ñ–≤–µ—Ä—Å–∏—Ç–µ—Ç—Å—å–∫–∞, 27\n\n"
    
    # –î–æ–¥–∞—î–º–æ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –ø—Ä–æ —Ä—ñ–∫ –Ω–∞–≤—á–∞–Ω–Ω—è –¥–ª—è –≤–∞—Ä—Ç–æ—Å—Ç—ñ
    response_text += "<b>üìÖ –í–∞–∂–ª–∏–≤–æ:</b>\n"
    response_text += "‚Ä¢ –í–∞—Ä—Ç—ñ—Å—Ç—å –Ω–∞–≤—á–∞–Ω–Ω—è –≤–∫–∞–∑–∞–Ω–∞ –¥–ª—è <b>2025-2026 –Ω–∞–≤—á–∞–ª—å–Ω–æ–≥–æ —Ä–æ–∫—É</b>\n"
    response_text += "‚Ä¢ –î–ª—è —É—Ç–æ—á–Ω–µ–Ω–Ω—è –∞–∫—Ç—É–∞–ª—å–Ω–æ—ó –≤–∞—Ä—Ç–æ—Å—Ç—ñ –∑–≤–µ—Ä–Ω–∏—Å—è –¥–æ –ø—Ä–∏–π–º–∞–ª—å–Ω–æ—ó –∫–æ–º—ñ—Å—ñ—ó\n\n"
    
    # –Ø–∫—â–æ —Å–ø–µ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –Ω–µ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞, –ø—Ä–æ–ø–æ–Ω—É—î–º–æ —ó—ó –≤—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏
    if not specialization:
        response_text += "üí° <i>–ü–æ—Ä–∞–¥–∞:</i> –í—Å—Ç–∞–Ω–æ–≤–∏ —Å–≤–æ—é —Å–ø–µ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—é –≤ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è—Ö –¥–ª—è –±—ñ–ª—å—à –ø–µ—Ä—Å–æ–Ω–∞–ª—ñ–∑–æ–≤–∞–Ω–∏—Ö –ø–æ—Ä–∞–¥!"
    
    await message.answer(response_text, reply_markup=get_main_menu(), parse_mode="HTML")


@router.message(F.text.in_(["üìÑ –î–æ–∫—É–º–µ–Ω—Ç–∏", "üìÑ –°–ø–∏—Å–æ–∫ –¥–æ–∫—É–º–µ–Ω—Ç—ñ–≤"]))
async def get_documents_handler(message: Message):
    """–û–±—Ä–æ–±–∫–∞ –∑–∞–ø–∏—Ç—É –Ω–∞ —Å–ø–∏—Å–æ–∫ –¥–æ–∫—É–º–µ–Ω—Ç—ñ–≤"""
    documents_text = (
        "üìÑ <b>–°–ø–∏—Å–æ–∫ –Ω–µ–æ–±—Ö—ñ–¥–Ω–∏—Ö –¥–æ–∫—É–º–µ–Ω—Ç—ñ–≤ –¥–ª—è –≤—Å—Ç—É–ø—É –¥–æ –•–î–£:</b>\n\n"
        "1. üìù –ó–∞—è–≤–∞ (–∑–∞ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ—é —Ñ–æ—Ä–º–æ—é –•–î–£)\n"
        "2. üìú –î–æ–∫—É–º–µ–Ω—Ç –ø—Ä–æ –æ—Å–≤—ñ—Ç—É (–æ—Ä–∏–≥—ñ–Ω–∞–ª –∞–±–æ –∫–æ–ø—ñ—è)\n"
        "3. üìã –î–æ–¥–∞—Ç–æ–∫ –¥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞ –ø—Ä–æ –æ—Å–≤—ñ—Ç—É\n"
        "4. üì∏ –§–æ—Ç–æ 3x4 (4 —à—Ç.)\n"
        "5. üÜî –ö–æ–ø—ñ—è –ø–∞—Å–ø–æ—Ä—Ç–∞ (1-2 —Å—Ç–æ—Ä—ñ–Ω–∫–∏)\n"
        "6. üìÑ –ö–æ–ø—ñ—è —ñ–¥–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ–π–Ω–æ–≥–æ –∫–æ–¥—É\n"
        "7. üè• –ú–µ–¥–∏—á–Ω–∞ –¥–æ–≤—ñ–¥–∫–∞ (—Ñ–æ—Ä–º–∞ 086-–æ)\n"
        "8. üìä –†–µ–∑—É–ª—å—Ç–∞—Ç–∏ –ó–ù–û (—Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç)\n"
        "9. üìë –î–æ–∫—É–º–µ–Ω—Ç–∏ –ø—Ä–æ –æ—Å–æ–±–ª–∏–≤—ñ –ø—Ä–∞–≤–∞ (—è–∫—â–æ —î)\n\n"
        "üí° <i>–í–∞–∂–ª–∏–≤–æ:</i> –ü–µ—Ä–µ–≤—ñ—Ä –∞–∫—Ç—É–∞–ª—å–Ω–∏–π —Å–ø–∏—Å–æ–∫ –Ω–∞ –æ—Ñ—ñ—Ü—ñ–π–Ω–æ–º—É —Å–∞–π—Ç—ñ –•–î–£ –∞–±–æ –∑–≤–µ—Ä–Ω–∏—Å—è –¥–æ –ø—Ä–∏–π–º–∞–ª—å–Ω–æ—ó –∫–æ–º—ñ—Å—ñ—ó!"
    )
    
    await message.answer(documents_text, reply_markup=get_main_menu(), parse_mode="HTML")


@router.message(F.text.in_(["‚è∞ –ù–∞–≥–∞–¥—É–≤–∞–Ω–Ω—è", "‚è∞ –ú–æ—ó –Ω–∞–≥–∞–¥—É–≤–∞–Ω–Ω—è"]))
async def get_reminders_handler(message: Message):
    """–û–±—Ä–æ–±–∫–∞ –∑–∞–ø–∏—Ç—É –Ω–∞ –Ω–∞–≥–∞–¥—É–≤–∞–Ω–Ω—è"""
    from datetime import datetime
    
    reminders = await db.get_user_reminders(message.from_user.id)
    
    if not reminders:
        text = (
            "‚è∞ <b>–ú–æ—ó –Ω–∞–≥–∞–¥—É–≤–∞–Ω–Ω—è</b>\n\n"
            "–£ —Ç–µ–±–µ –ø–æ–∫–∏ –Ω–µ–º–∞—î –∞–∫—Ç–∏–≤–Ω–∏—Ö –Ω–∞–≥–∞–¥—É–≤–∞–Ω—å.\n\n"
            "üí° <i>–ü–æ—Ä–∞–¥–∞:</i> –°—Ç–≤–æ—Ä–∏ –Ω–∞–≥–∞–¥—É–≤–∞–Ω–Ω—è —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É –Ω–∏–∂—á–µ!"
        )
    else:
        text = "‚è∞ <b>–ú–æ—ó –Ω–∞–≥–∞–¥—É–≤–∞–Ω–Ω—è:</b>\n\n"
        for reminder in reminders:
            deadline_date = reminder['deadline_date']
            deadline_name = reminder['deadline_name']
            is_sent = "‚úÖ" if reminder['is_sent'] else "‚è≥"
            text += f"{is_sent} {deadline_name} - {deadline_date.strftime('%d.%m.%Y')}\n"
    
    await message.answer(text, reply_markup=get_reminders_management_keyboard(), parse_mode="HTML")


@router.message(F.text.in_(["üìû –ö–æ–Ω—Ç–∞–∫—Ç–∏", "üìû –ö–æ–Ω—Ç–∞–∫—Ç–∏ –•–î–£"]))
async def contacts_handler(message: Message):
    """–û–±—Ä–æ–±–∫–∞ –∑–∞–ø–∏—Ç—É –Ω–∞ –∫–æ–Ω—Ç–∞–∫—Ç–∏"""
    contacts = get_knu_contacts()
    await message.answer(contacts, reply_markup=get_main_menu())


@router.message(F.text.in_(["üí¨ –ó–∞–¥–∞—Ç–∏ –ø–∏—Ç–∞–Ω–Ω—è", "üí¨ –Ü–Ω—à–µ –ø–∏—Ç–∞–Ω–Ω—è"]))
async def ask_question_handler(message: Message):
    """–û–±—Ä–æ–±–∫–∞ –∑–∞–ø–∏—Ç—É –Ω–∞ –ø–∏—Ç–∞–Ω–Ω—è"""
    await message.answer(
        "üí¨ <b>–ó–∞–¥–∞–π —Å–≤–æ—î –ø–∏—Ç–∞–Ω–Ω—è –ø—Ä–æ –≤—Å—Ç—É–ø –¥–æ –•–î–£</b>\n\n"
        "–Ø –¥–æ–ø–æ–º–æ–∂—É –∑:\n"
        "‚Ä¢ –î–æ–∫—É–º–µ–Ω—Ç–∞–º–∏ –¥–ª—è –≤—Å—Ç—É–ø—É\n"
        "‚Ä¢ –°–ø–µ—Ü—ñ–∞–ª—å–Ω–æ—Å—Ç—è–º–∏ —Ç–∞ –≤–∞—Ä—Ç—ñ—Å—Ç—é –Ω–∞–≤—á–∞–Ω–Ω—è\n"
        "‚Ä¢ –í—Å—Ç—É–ø–Ω–æ—é –∫–∞–º–ø–∞–Ω—ñ—î—é\n"
        "‚Ä¢ –ü—ñ–¥–≥–æ—Ç–æ–≤–∫–æ—é –¥–æ –≤—Å—Ç—É–ø—É\n\n"
        "–ü—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏ —Å–≤–æ—î –ø–∏—Ç–∞–Ω–Ω—è üëá",
        reply_markup=get_back_keyboard(),
        parse_mode="HTML"
    )


@router.message(F.text == "‚¨ÖÔ∏è –ù–∞–∑–∞–¥")
async def back_handler(message: Message):
    """–û–±—Ä–æ–±–∫–∞ –∫–Ω–æ–ø–∫–∏ '–ù–∞–∑–∞–¥'"""
    await message.answer("–ü–æ–≤–µ—Ä—Ç–∞—î–º–æ—Å—å –¥–æ –≥–æ–ª–æ–≤–Ω–æ–≥–æ –º–µ–Ω—é üëá", reply_markup=get_main_menu())


@router.message(F.text == "üè† –ì–æ–ª–æ–≤–Ω–µ –º–µ–Ω—é")
async def main_menu_handler(message: Message):
    """–ü–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è –¥–æ –≥–æ–ª–æ–≤–Ω–æ–≥–æ –º–µ–Ω—é"""
    await message.answer(
        "üè† <b>–ì–æ–ª–æ–≤–Ω–µ –º–µ–Ω—é</b>\n\n"
        "–û–±–µ—Ä—ñ—Ç—å –æ–ø—Ü—ñ—é:",
        reply_markup=get_main_menu(),
        parse_mode="HTML"
    )



