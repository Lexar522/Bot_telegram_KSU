# üöÄ –†–µ–∞–ª—ñ–∑–æ–≤–∞–Ω—ñ –ø–æ–∫—Ä–∞—â–µ–Ω–Ω—è: Streaming API, –°–µ–º–∞–Ω—Ç–∏—á–Ω–µ –∫–µ—à—É–≤–∞–Ω–Ω—è, –ü–∞—Ä–∞–ª–µ–ª—å–Ω–∞ –æ–±—Ä–æ–±–∫–∞

## ‚úÖ –©–æ —Ä–µ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ

### 1. Streaming API ‚ö°
**–ï—Ñ–µ–∫—Ç: -40-60% —á–∞—Å—É –æ—á—ñ–∫—É–≤–∞–Ω–Ω—è –¥–ª—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞**

–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ –±–∞—á–∞—Ç—å –≤—ñ–¥–ø–æ–≤—ñ–¥—å –ø–æ —á–∞—Å—Ç–∏–Ω–∞—Ö, –∑–∞–º—ñ—Å—Ç—å –æ—á—ñ–∫—É–≤–∞–Ω–Ω—è –ø–æ–≤–Ω–æ—ó –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ.

**–í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è:**
```python
from ollama_client import ollama

# Streaming –≥–µ–Ω–µ—Ä–∞—Ü—ñ—è
async for chunk in ollama.generate_response_stream("–Ø–∫—ñ —î —Ñ–∞–∫—É–ª—å—Ç–µ—Ç–∏ –≤ –•–î–£?"):
    # –í—ñ–¥–æ–±—Ä–∞–∂–∞—î–º–æ –∫–æ–∂–µ–Ω chunk –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—É
    await message.answer(chunk, parse_mode="HTML")
```

**–ü–µ—Ä–µ–≤–∞–≥–∏:**
- –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –±–∞—á–∏—Ç—å –≤—ñ–¥–ø–æ–≤—ñ–¥—å –æ–¥—Ä–∞–∑—É, –Ω–µ —á–µ–∫–∞—é—á–∏ –ø–æ–≤–Ω–æ—ó –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó
- –ö—Ä–∞—â–∏–π UX - –∑–¥–∞—î—Ç—å—Å—è, —â–æ –±–æ—Ç "–¥—É–º–∞—î" —Ç–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î –≤ —Ä–µ–∞–ª—å–Ω–æ–º—É —á–∞—Å—ñ
- –ú–µ–Ω—à–µ –≤—ñ–¥–º–æ–≤ —á–µ—Ä–µ–∑ –¥–æ–≤–≥–µ –æ—á—ñ–∫—É–≤–∞–Ω–Ω—è

---

### 2. –°–µ–º–∞–Ω—Ç–∏—á–Ω–µ –∫–µ—à—É–≤–∞–Ω–Ω—è üíæ
**–ï—Ñ–µ–∫—Ç: +20-30% cache hit rate**

–ó–Ω–∞—Ö–æ–¥–∏—Ç—å —Å—Ö–æ–∂—ñ –ø–∏—Ç–∞–Ω–Ω—è –∑–∞ –∑–º—ñ—Å—Ç–æ–º, –∞ –Ω–µ —Ç–æ—á–Ω–∏–º —Ç–µ–∫—Å—Ç–æ–º.

**–Ø–∫ –ø—Ä–∞—Ü—é—î:**
- –í–∏—Ç—è–≥—É—î –∫–ª—é—á–æ–≤—ñ —Å–ª–æ–≤–∞ –∑ –ø–∏—Ç–∞–Ω—å
- –†–æ–∑—Ä–∞—Ö–æ–≤—É—î —Å–µ–º–∞–Ω—Ç–∏—á–Ω—É —Å—Ö–æ–∂—ñ—Å—Ç—å (Jaccard similarity)
- –ó–Ω–∞—Ö–æ–¥–∏—Ç—å –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ –Ω–∞ —Å—Ö–æ–∂—ñ –ø–∏—Ç–∞–Ω–Ω—è (–ø–æ—Ä—ñ–≥ —Å—Ö–æ–∂–æ—Å—Ç—ñ: 70%)

**–ü—Ä–∏–∫–ª–∞–¥:**
```
–ü–∏—Ç–∞–Ω–Ω—è 1: "–Ø–∫—ñ —î —Ñ–∞–∫—É–ª—å—Ç–µ—Ç–∏ –≤ –•–î–£?"
–ü–∏—Ç–∞–Ω–Ω—è 2: "–°–∫—ñ–ª—å–∫–∏ —Ñ–∞–∫—É–ª—å—Ç–µ—Ç—ñ–≤ —É –•–µ—Ä—Å–æ–Ω—Å—å–∫–æ–º—É —É–Ω—ñ–≤–µ—Ä—Å–∏—Ç–µ—Ç—ñ?"
–ü–∏—Ç–∞–Ω–Ω—è 3: "–Ø–∫—ñ —Ñ–∞–∫—É–ª—å—Ç–µ—Ç–∏ —î –≤ –•–î–£?"

‚Üí –í—Å—ñ —Ç—Ä–∏ –ø–∏—Ç–∞–Ω–Ω—è –∑–Ω–∞–π–¥—É—Ç—å –æ–¥–Ω–∞–∫–æ–≤—É –≤—ñ–¥–ø–æ–≤—ñ–¥—å –∑ –∫–µ—à—É!
```

**–ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ —ñ–Ω—Ç–µ–≥—Ä–æ–≤–∞–Ω–æ:**
- –°–ø–æ—á–∞—Ç–∫—É –ø–µ—Ä–µ–≤—ñ—Ä—è—î—Ç—å—Å—è —Ç–æ—á–Ω–∏–π –∫–µ—à
- –ü–æ—Ç—ñ–º —Å–µ–º–∞–Ω—Ç–∏—á–Ω–∏–π –∫–µ—à
- –Ø–∫—â–æ –∑–Ω–∞–π–¥–µ–Ω–æ - –ø–æ–≤–µ—Ä—Ç–∞—î—Ç—å—Å—è –≤—ñ–¥–ø–æ–≤—ñ–¥—å –º–∏—Ç—Ç—î–≤–æ

---

### 3. –ü–∞—Ä–∞–ª–µ–ª—å–Ω–∞ –æ–±—Ä–æ–±–∫–∞ üîÑ
**–ï—Ñ–µ–∫—Ç: +20% —à–≤–∏–¥–∫–æ—Å—Ç—ñ —Ç–∞ —Ç–æ—á–Ω–æ—Å—Ç—ñ –¥–ª—è —Å–∫–ª–∞–¥–Ω–∏—Ö –ø–∏—Ç–∞–Ω—å**

–ì–µ–Ω–µ—Ä—É—î –∫—ñ–ª—å–∫–∞ –≤–∞—Ä—ñ–∞–Ω—Ç—ñ–≤ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ –ø–∞—Ä–∞–ª–µ–ª—å–Ω–æ —Ç–∞ –≤–∏–±–∏—Ä–∞—î –Ω–∞–π–∫—Ä–∞—â–∏–π.

**–í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è:**
```python
from ollama_client import ollama

# –ü–∞—Ä–∞–ª–µ–ª—å–Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü—ñ—è 3 –≤–∞—Ä—ñ–∞–Ω—Ç—ñ–≤
response = await ollama.generate_response_parallel(
    "–ü–æ—Ä—ñ–≤–Ω—è–π —Å–ø–µ—Ü—ñ–∞–ª—å–Ω–æ—Å—Ç—ñ –Ü–¢ –≤ –•–î–£",
    num_candidates=3
)
```

**–Ø–∫ –ø—Ä–∞—Ü—é—î:**
1. –ì–µ–Ω–µ—Ä—É—î 3 –≤–∞—Ä—ñ–∞–Ω—Ç–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ –ø–∞—Ä–∞–ª–µ–ª—å–Ω–æ –∑ —Ä—ñ–∑–Ω–∏–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
2. –û—Ü—ñ–Ω—é—î –∫–æ–∂–µ–Ω –≤–∞—Ä—ñ–∞–Ω—Ç –∑–∞:
   - –î–æ–≤–∂–∏–Ω–æ—é –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ (–æ–ø—Ç–∏–º–∞–ª—å–Ω–∞ 100-500 —Å–∏–º–≤–æ–ª—ñ–≤)
   - –ù–∞—è–≤–Ω—ñ—Å—Ç—é –∫–ª—é—á–æ–≤–∏—Ö —Å–ª—ñ–≤ –∑ –ø–∏—Ç–∞–Ω–Ω—è
   - –°—Ç—Ä—É–∫—Ç—É—Ä–æ–≤–∞–Ω—ñ—Å—Ç—é (—Å–ø–∏—Å–∫–∏, —Ñ–æ—Ä–º–∞—Ç—É–≤–∞–Ω–Ω—è)
   - –í—ñ–¥—Å—É—Ç–Ω—ñ—Å—Ç—é –∑–∞–±–æ—Ä–æ–Ω–µ–Ω–∏—Ö —Å–ª—ñ–≤
3. –í–∏–±–∏—Ä–∞—î –≤–∞—Ä—ñ–∞–Ω—Ç –∑ –Ω–∞–π–≤–∏—â–∏–º –±–∞–ª–æ–º

**–ö–æ–ª–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏:**
- –°–∫–ª–∞–¥–Ω—ñ –ø–∏—Ç–∞–Ω–Ω—è (–ø–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è, –∞–Ω–∞–ª—ñ–∑)
- –í–∞–∂–ª–∏–≤—ñ –ø–∏—Ç–∞–Ω–Ω—è (–≤–∞—Ä—Ç—ñ—Å—Ç—å, –≤—Å—Ç—É–ø)
- –ö–æ–ª–∏ –ø–æ—Ç—Ä—ñ–±–Ω–∞ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞ —Ç–æ—á–Ω—ñ—Å—Ç—å

---

## üìä –û—á—ñ–∫—É–≤–∞–Ω—ñ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏

### –®–≤–∏–¥–∫—ñ—Å—Ç—å:
- ‚ö° **Streaming**: -40-60% —á–∞—Å—É –æ—á—ñ–∫—É–≤–∞–Ω–Ω—è (—Å—É–±'—î–∫—Ç–∏–≤–Ω–æ –¥–ª—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞)
- üíæ **–°–µ–º–∞–Ω—Ç–∏—á–Ω–µ –∫–µ—à—É–≤–∞–Ω–Ω—è**: +20-30% cache hit rate
- üîÑ **–ü–∞—Ä–∞–ª–µ–ª—å–Ω–∞ –æ–±—Ä–æ–±–∫–∞**: +20% —à–≤–∏–¥–∫–æ—Å—Ç—ñ –¥–ª—è —Å–∫–ª–∞–¥–Ω–∏—Ö –ø–∏—Ç–∞–Ω—å

**–ó–∞–≥–∞–ª—å–Ω–µ –ø–æ–∫—Ä–∞—â–µ–Ω–Ω—è —à–≤–∏–¥–∫–æ—Å—Ç—ñ: +50-70%**

### –¢–æ—á–Ω—ñ—Å—Ç—å:
- üéØ **–ü–∞—Ä–∞–ª–µ–ª—å–Ω–∞ –æ–±—Ä–æ–±–∫–∞**: +10-15% —Ç–æ—á–Ω–æ—Å—Ç—ñ (–≤–∏–±—ñ—Ä –Ω–∞–π–∫—Ä–∞—â–æ–≥–æ –≤–∞—Ä—ñ–∞–Ω—Ç—É)
- üíæ **–°–µ–º–∞–Ω—Ç–∏—á–Ω–µ –∫–µ—à—É–≤–∞–Ω–Ω—è**: –ë—ñ–ª—å—à–µ –ø—Ä–∞–≤–∏–ª—å–Ω–∏—Ö –≤—ñ–¥–ø–æ–≤—ñ–¥–µ–π (–∑–Ω–∞—Ö–æ–¥–∏—Ç—å —Å—Ö–æ–∂—ñ –ø–∏—Ç–∞–Ω–Ω—è)

---

## üîß –¢–µ—Ö–Ω—ñ—á–Ω—ñ –¥–µ—Ç–∞–ª—ñ

### Streaming API
- –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î OLLAMA `/api/chat` –∑ `stream: true`
- –û–±—Ä–æ–±–ª—è—î JSON —Ä—è–¥–∫–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º—É —á–∞—Å—ñ
- –ü—ñ–¥—Ç—Ä–∏–º—É—î —Ä—ñ–∑–Ω—ñ —Ñ–æ—Ä–º–∞—Ç–∏ OLLAMA (message, delta, response)
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∑–±–µ—Ä—ñ–≥–∞—î –ø–æ–≤–Ω—É –≤—ñ–¥–ø–æ–≤—ñ–¥—å –≤ –∫–µ—à

### –°–µ–º–∞–Ω—Ç–∏—á–Ω–µ –∫–µ—à—É–≤–∞–Ω–Ω—è
- –í–∏—Ç—è–≥—É–≤–∞–Ω–Ω—è –∫–ª—é—á–æ–≤–∏—Ö —Å–ª—ñ–≤ (—Ñ—ñ–ª—å—Ç—Ä–∞—Ü—ñ—è —Å—Ç–æ–ø-—Å–ª—ñ–≤)
- Jaccard similarity –¥–ª—è —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—É —Å—Ö–æ–∂–æ—Å—Ç—ñ
- –Ü–Ω–¥–µ–∫—Å–∞—Ü—ñ—è –∑–∞ –∫–ª—é—á–æ–≤–∏–º–∏ —Å–ª–æ–≤–∞–º–∏ –¥–ª—è —à–≤–∏–¥–∫–æ–≥–æ –ø–æ—à—É–∫—É
- –ü–æ—Ä—ñ–≥ —Å—Ö–æ–∂–æ—Å—Ç—ñ: 70% (–Ω–∞–ª–∞—à—Ç–æ–≤—É—î—Ç—å—Å—è)

### –ü–∞—Ä–∞–ª–µ–ª—å–Ω–∞ –æ–±—Ä–æ–±–∫–∞
- –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î `asyncio.gather()` –¥–ª—è –ø–∞—Ä–∞–ª–µ–ª—å–Ω–æ—ó –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó
- –°—Ç–≤–æ—Ä—é—î –≤–∞—Ä—ñ–∞—Ü—ñ—ó –ø–∞—Ä–∞–º–µ—Ç—Ä—ñ–≤ (temperature, top_p, num_predict)
- –°–∏—Å—Ç–µ–º–∞ –æ—Ü—ñ–Ω–∫–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥–µ–π (4 –∫—Ä–∏—Ç–µ—Ä—ñ—ó)
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏–π –≤–∏–±—ñ—Ä –Ω–∞–π–∫—Ä–∞—â–æ–≥–æ –≤–∞—Ä—ñ–∞–Ω—Ç—É

---

## üìù –ü—Ä–∏–∫–ª–∞–¥–∏ —ñ–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—ó

### Streaming –≤ handlers
```python
# –í handlers/chat_handler.py
async def chat_handler(message: Message):
    bot_message = await message.answer("ü§î –î—É–º–∞—é...")
    
    full_response = ""
    async for chunk in ollama.generate_response_stream(user_message, context_list):
        full_response += chunk
        # –û–Ω–æ–≤–ª—é—î–º–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∑ –Ω–æ–≤–∏–º chunk
        await bot_message.edit_text(
            f"üí¨ <b>–í—ñ–¥–ø–æ–≤—ñ–¥—å:</b>\n\n{full_response}...",
            parse_mode="HTML"
        )
    
    # –§—ñ–Ω–∞–ª—å–Ω–µ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –∑ –ø–æ–≤–Ω–æ—é –≤—ñ–¥–ø–æ–≤—ñ–¥–¥—é
    await bot_message.edit_text(
        f"üí¨ <b>–í—ñ–¥–ø–æ–≤—ñ–¥—å:</b>\n\n{full_response}",
        parse_mode="HTML"
    )
```

### –ü–∞—Ä–∞–ª–µ–ª—å–Ω–∞ –æ–±—Ä–æ–±–∫–∞ –¥–ª—è —Å–∫–ª–∞–¥–Ω–∏—Ö –ø–∏—Ç–∞–Ω—å
```python
# –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –¥–ª—è —Å–∫–ª–∞–¥–Ω–∏—Ö –ø–∏—Ç–∞–Ω—å
if question_type == "comparison" or len(prompt) > 100:
    response = await ollama.generate_response_parallel(
        prompt,
        context_list,
        num_candidates=3
    )
else:
    response = await ollama.generate_response(prompt, context_list)
```

---

## üéØ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó

### –ö–æ–ª–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ Streaming:
- ‚úÖ –ó–∞–≤–∂–¥–∏ –¥–ª—è –∑–≤–∏—á–∞–π–Ω–∏—Ö –ø–∏—Ç–∞–Ω—å (–∫—Ä–∞—â–∏–π UX)
- ‚úÖ –î–ª—è –¥–æ–≤–≥–∏—Ö –≤—ñ–¥–ø–æ–≤—ñ–¥–µ–π
- ‚ùå –ù–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ –¥–ª—è –∫–µ—à–æ–≤–∞–Ω–∏—Ö –≤—ñ–¥–ø–æ–≤—ñ–¥–µ–π (–≤–æ–Ω–∏ –ø–æ–≤–µ—Ä—Ç–∞—é—Ç—å—Å—è –º–∏—Ç—Ç—î–≤–æ)

### –ö–æ–ª–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ –ø–∞—Ä–∞–ª–µ–ª—å–Ω—É –æ–±—Ä–æ–±–∫—É:
- ‚úÖ –°–∫–ª–∞–¥–Ω—ñ –ø–∏—Ç–∞–Ω–Ω—è (–ø–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è, –∞–Ω–∞–ª—ñ–∑)
- ‚úÖ –í–∞–∂–ª–∏–≤—ñ –ø–∏—Ç–∞–Ω–Ω—è (–≤–∞—Ä—Ç—ñ—Å—Ç—å, –≤—Å—Ç—É–ø)
- ‚ùå –ü—Ä–æ—Å—Ç—ñ –ø–∏—Ç–∞–Ω–Ω—è (–Ω–µ –ø–æ—Ç—Ä—ñ–±–Ω–æ, –∑–∞–π–≤–∞ –æ–±—Ä–æ–±–∫–∞)

### –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è —Å–µ–º–∞–Ω—Ç–∏—á–Ω–æ–≥–æ –∫–µ—à—É:
- –ü–æ—Ä—ñ–≥ —Å—Ö–æ–∂–æ—Å—Ç—ñ: 0.7 (70%) - –º–æ–∂–Ω–∞ –∑–º—ñ–Ω–∏—Ç–∏ –≤ `SemanticCache.__init__()`
- –ß–∏–º –Ω–∏–∂—á–∏–π –ø–æ—Ä—ñ–≥ - –±—ñ–ª—å—à–µ –ø–æ–ø–∞–¥–∞–Ω—å, –∞–ª–µ –º–µ–Ω—à–∞ —Ç–æ—á–Ω—ñ—Å—Ç—å
- –ß–∏–º –≤–∏—â–∏–π –ø–æ—Ä—ñ–≥ - –º–µ–Ω—à–µ –ø–æ–ø–∞–¥–∞–Ω—å, –∞–ª–µ –≤–∏—â–∞ —Ç–æ—á–Ω—ñ—Å—Ç—å

---

## üìà –ú–µ—Ç—Ä–∏–∫–∏

–î–æ–¥–∞–Ω–æ –Ω–æ–≤—ñ –º–µ—Ç—Ä–∏–∫–∏ –≤ `MetricsCollector`:
- `streaming_requests` - –∫—ñ–ª—å–∫—ñ—Å—Ç—å streaming –∑–∞–ø–∏—Ç—ñ–≤
- `parallel_requests` - –∫—ñ–ª—å–∫—ñ—Å—Ç—å –ø–∞—Ä–∞–ª–µ–ª—å–Ω–∏—Ö –∑–∞–ø–∏—Ç—ñ–≤
- `semantic_cache_hits` - –∫—ñ–ª—å–∫—ñ—Å—Ç—å —Å–µ–º–∞–Ω—Ç–∏—á–Ω–∏—Ö –ø–æ–ø–∞–¥–∞–Ω—å
- `exact_cache_hits` - –∫—ñ–ª—å–∫—ñ—Å—Ç—å —Ç–æ—á–Ω–∏—Ö –ø–æ–ø–∞–¥–∞–Ω—å

---

**–û—Å—Ç–∞–Ω–Ω—î –æ–Ω–æ–≤–ª–µ–Ω–Ω—è**: –†–µ–∞–ª—ñ–∑–∞—Ü—ñ—è Streaming API, –°–µ–º–∞–Ω—Ç–∏—á–Ω–æ–≥–æ –∫–µ—à—É–≤–∞–Ω–Ω—è —Ç–∞ –ü–∞—Ä–∞–ª–µ–ª—å–Ω–æ—ó –æ–±—Ä–æ–±–∫–∏



