"""
–°–µ—Ä–≤—ñ—Å –¥–ª—è –æ–±—Ä–æ–±–∫–∏ —Ç–∞ —Ñ–æ—Ä–º—É–≤–∞–Ω–Ω—è –≤—ñ–¥–ø–æ–≤—ñ–¥–µ–π
"""
from typing import Tuple
from validators.response_validator import ResponseValidator, ValidationResult
from validators.content_validator import ContentValidator, ContentValidationResult
from utils.text_formatter import TextFormatter


class ResponseService:
    """–°–µ—Ä–≤—ñ—Å –¥–ª—è –æ–±—Ä–æ–±–∫–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥–µ–π"""
    
    def __init__(self):
        self.response_validator = ResponseValidator()
        self.content_validator = ContentValidator()
        self.text_formatter = TextFormatter()
    
    def process_response(
        self, 
        response: str, 
        user_message: str
    ) -> Tuple[str, bool]:
        """
        –û–±—Ä–æ–±–ª—è—î –≤—ñ–¥–ø–æ–≤—ñ–¥—å: –≤–∞–ª—ñ–¥—É—î, —Ñ–æ—Ä–º–∞—Ç—É—î —Ç–∞ –≤–∏–ø—Ä–∞–≤–ª—è—î –ø–æ–º–∏–ª–∫–∏
        
        Args:
            response: –í—ñ–¥–ø–æ–≤—ñ–¥—å –≤—ñ–¥ AI
            user_message: –û—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
            
        Returns:
            Tuple[str, bool]: (–æ–±—Ä–æ–±–ª–µ–Ω–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—å, —á–∏ –±—É–ª–∞ –≤–∞–ª—ñ–¥–Ω–∞)
        """
        # –û—á–∏—â–∞—î–º–æ –≤—ñ–¥–ø–æ–≤—ñ–¥—å
        response = response.strip()
        
        # –í–∞–ª—ñ–¥–∞—Ü—ñ—è –∫–æ–Ω—Ç–µ–Ω—Ç—É
        content_validation = self.content_validator.validate(response)
        if not content_validation.is_valid:
            # –Ø–∫—â–æ –≤—ñ–¥–ø–æ–≤—ñ–¥—å –ø–æ—Ä–æ–∂–Ω—è –∞–±–æ –∑–∞–Ω–∞–¥—Ç–æ –∫–æ—Ä–æ—Ç–∫–∞ - –ø–æ–≤–µ—Ä—Ç–∞—î–º–æ –ø–æ–º–∏–ª–∫—É
            if "–ø–æ—Ä–æ–∂–Ω—è" in content_validation.issues[0].lower():
                return self._get_fallback_response(user_message), False
        
        # –û–±–º–µ–∂—É—î–º–æ –¥–æ–≤–∂–∏–Ω—É
        if len(response) > ContentValidator.MAX_LENGTH:
            response = response[:ContentValidator.MAX_LENGTH] + "\n\n... (–≤—ñ–¥–ø–æ–≤—ñ–¥—å –æ–±—Ä—ñ–∑–∞–Ω–∞)"
        
        # –í–∞–ª—ñ–¥–∞—Ü—ñ—è –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ
        validation = self.response_validator.validate(response)
        
        if not validation.is_valid:
            # –Ø–∫—â–æ –∑–Ω–∞–π–¥–µ–Ω–æ –∑–∞–±–æ—Ä–æ–Ω–µ–Ω—ñ —É–Ω—ñ–≤–µ—Ä—Å–∏—Ç–µ—Ç–∏ - –∑–∞–º—ñ–Ω—é—î–º–æ –Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—É –≤—ñ–¥–ø–æ–≤—ñ–¥—å
            if "–∑–∞–±–æ—Ä–æ–Ω–µ–Ω–∏–π —É–Ω—ñ–≤–µ—Ä—Å–∏—Ç–µ—Ç" in validation.error_message.lower():
                return self._get_fallback_response(user_message), False
        
        # –§–æ—Ä–º–∞—Ç—É—î–º–æ –≤—ñ–¥–ø–æ–≤—ñ–¥—å
        response = self.text_formatter.format(response)
        
        return response, validation.is_valid
    
    def _get_fallback_response(self, user_message: str) -> str:
        """
        –ü–æ–≤–µ—Ä—Ç–∞—î —Ä–µ–∑–µ—Ä–≤–Ω—É –≤—ñ–¥–ø–æ–≤—ñ–¥—å –Ω–∞ –æ—Å–Ω–æ–≤—ñ —Ç–∏–ø—É –ø–∏—Ç–∞–Ω–Ω—è
        
        Args:
            user_message: –û—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
            
        Returns:
            str: –†–µ–∑–µ—Ä–≤–Ω–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—å
        """
        user_message_lower = user_message.lower()
        
        # –í–∏–∑–Ω–∞—á–∞—î–º–æ —Ç–∏–ø –ø–∏—Ç–∞–Ω–Ω—è —Ç–∞ –ø–æ–≤–µ—Ä—Ç–∞—î–º–æ –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω—É –≤—ñ–¥–ø–æ–≤—ñ–¥—å
        if any(word in user_message_lower for word in [
            "–ø—Ä–æ–≥—Ä–∞–º—É–≤–∞–Ω–Ω—è", "–ø—Ä–æ–≥—Ä–∞–º—ñ—Å—Ç", "—ñ—Ç", "—ñ–Ω—Ñ–æ—Ä–º–∞—Ç–∏–∫–∞", 
            "–∫–æ–º–ø'—é—Ç–µ—Ä", "121", "f6", "f2", "f3"
        ]):
            return "–í –•–î–£ —î —Ç–∞–∫—ñ —Å–ø–µ—Ü—ñ–∞–ª—å–Ω–æ—Å—Ç—ñ –∑ –ø—Ä–æ–≥—Ä–∞–º—É–≤–∞–Ω–Ω—è —Ç–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ–π–Ω–∏—Ö —Ç–µ—Ö–Ω–æ–ª–æ–≥—ñ–π: –Ü–Ω–∂–µ–Ω–µ—Ä—ñ—è –ø—Ä–æ–≥—Ä–∞–º–Ω–æ–≥–æ –∑–∞–±–µ–∑–ø–µ—á–µ–Ω–Ω—è (F2), –ö–æ–º–ø'—é—Ç–µ—Ä–Ω—ñ –Ω–∞—É–∫–∏ (F3), –Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ–π–Ω—ñ —Å–∏—Å—Ç–µ–º–∏ —Ç–∞ —Ç–µ—Ö–Ω–æ–ª–æ–≥—ñ—ó (F6, –∫–æ–¥ 121). –î–µ—Ç–∞–ª—å–Ω—ñ—à–µ: +380 552 494375 üíª"
        
        elif any(word in user_message_lower for word in [
            "–º–µ–¥–∏—Ü–∏–Ω–∞", "–º–µ–¥–∏—á–Ω—ñ", "–ª—ñ–∫–∞—Ä", "—Ñ–∞—Ä–º–∞—Ü—ñ—è", "—Ä–µ–∞–±—ñ–ª—ñ—Ç–∞—Ü—ñ—è"
        ]):
            return "–í –•–î–£ —î —Ç–∞–∫—ñ —Å–ø–µ—Ü—ñ–∞–ª—å–Ω–æ—Å—Ç—ñ –∑ –æ—Ö–æ—Ä–æ–Ω–∏ –∑–¥–æ—Ä–æ–≤'—è: –§—ñ–∑–∏—á–Ω–∞ —Ç–µ—Ä–∞–ø—ñ—è, –µ—Ä–≥–æ—Ç–µ—Ä–∞–ø—ñ—è (–±–∞–∫–∞–ª–∞–≤—Ä), –°–æ—Ü—ñ–∞–ª—å–Ω–∞ —Ä–æ–±–æ—Ç–∞ —Ç–∞ –∫–æ–Ω—Å—É–ª—å—Ç—É–≤–∞–Ω–Ω—è (–±–∞–∫–∞–ª–∞–≤—Ä), –ú–µ–¥–∏—Ü–∏–Ω–∞ (–º–∞–≥—ñ—Å—Ç—Ä), –§—ñ–∑–∏—á–Ω–∞ —Ä–µ–∞–±—ñ–ª—ñ—Ç–∞—Ü—ñ—è (–º–∞–≥—ñ—Å—Ç—Ä), –§–∞—Ä–º–∞—Ü—ñ—è (–º–∞–≥—ñ—Å—Ç—Ä). –î–µ—Ç–∞–ª—å–Ω—ñ—à–µ: +380 552 494375 üè•"
        
        elif any(word in user_message_lower for word in [
            "–æ—Å–≤—ñ—Ç–∞", "–ø–µ–¥–∞–≥–æ–≥—ñ–∫–∞", "–≤—á–∏—Ç–µ–ª—å", "–¥–æ—à–∫—ñ–ª—å–Ω–∞", "–ø–æ—á–∞—Ç–∫–æ–≤–∞"
        ]):
            return "–í –•–î–£ —î —Ç–∞–∫—ñ —Å–ø–µ—Ü—ñ–∞–ª—å–Ω–æ—Å—Ç—ñ –∑ –æ—Å–≤—ñ—Ç–∏ —Ç–∞ –ø–µ–¥–∞–≥–æ–≥—ñ–∫–∏: –î–æ—à–∫—ñ–ª—å–Ω–∞ –æ—Å–≤—ñ—Ç–∞, –ü–æ—á–∞—Ç–∫–æ–≤–∞ –æ—Å–≤—ñ—Ç–∞, –°–ø–µ—Ü—ñ–∞–ª—å–Ω–∞ –æ—Å–≤—ñ—Ç–∞ (–õ–æ–≥–æ–ø–µ–¥—ñ—è, –û–ª—ñ–≥–æ—Ñ—Ä–µ–Ω–æ–ø–µ–¥–∞–≥–æ–≥—ñ–∫–∞), –°–µ—Ä–µ–¥–Ω—è –æ—Å–≤—ñ—Ç–∞ (—Ä—ñ–∑–Ω—ñ —Å–ø–µ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó), –§—ñ–∑–∏—á–Ω–∞ –∫—É–ª—å—Ç—É—Ä–∞ —ñ —Å–ø–æ—Ä—Ç. –î–µ—Ç–∞–ª—å–Ω—ñ—à–µ: +380 552 494375 üéì"
        
        elif any(word in user_message_lower for word in [
            "–ø—Ä–∞–≤–æ", "—é—Ä–∏—Å—Ç", "—é—Ä–∏—Å–ø—Ä—É–¥–µ–Ω—Ü—ñ—è"
        ]):
            return "–í –•–î–£ —î —Å–ø–µ—Ü—ñ–∞–ª—å–Ω—ñ—Å—Ç—å –ü—Ä–∞–≤–æ (D8) –Ω–∞ —Ä—ñ–≤–Ω—è—Ö –±–∞–∫–∞–ª–∞–≤—Ä–∞ —Ç–∞ –º–∞–≥—ñ—Å—Ç—Ä–∞. –î–µ—Ç–∞–ª—å–Ω—ñ—à–µ: +380 552 494375 ‚öñÔ∏è"
        
        elif any(word in user_message_lower for word in [
            "–µ–∫–æ–Ω–æ–º—ñ–∫–∞", "–±—ñ–∑–Ω–µ—Å", "–º–µ–Ω–µ–¥–∂–º–µ–Ω—Ç", "—Ñ—ñ–Ω–∞–Ω—Å–∏"
        ]):
            return "–í –•–î–£ —î —Ç–∞–∫—ñ —Å–ø–µ—Ü—ñ–∞–ª—å–Ω–æ—Å—Ç—ñ –∑ –±—ñ–∑–Ω–µ—Å—É —Ç–∞ –µ–∫–æ–Ω–æ–º—ñ–∫–∏: –ï–∫–æ–Ω–æ–º—ñ–∫–∞ (–°1.01), –ú–µ–Ω–µ–¥–∂–º–µ–Ω—Ç (D3), –§—ñ–Ω–∞–Ω—Å–∏, –±–∞–Ω–∫—ñ–≤—Å—å–∫–∞ —Å–ø—Ä–∞–≤–∞ —Ç–∞ —Å—Ç—Ä–∞—Ö—É–≤–∞–Ω–Ω—è (D2), –ü—ñ–¥–ø—Ä–∏—î–º–Ω–∏—Ü—Ç–≤–æ —Ç–∞ —Ç–æ—Ä–≥—ñ–≤–ª—è (D7). –î–µ—Ç–∞–ª—å–Ω—ñ—à–µ: +380 552 494375 üíº"
        
        elif any(word in user_message_lower for word in [
            "–ø—Å–∏—Ö–æ–ª–æ–≥—ñ—è", "–ø—Å–∏—Ö–æ–ª–æ–≥"
        ]):
            return "–í –•–î–£ —î —Å–ø–µ—Ü—ñ–∞–ª—å–Ω—ñ—Å—Ç—å –ü—Å–∏—Ö–æ–ª–æ–≥—ñ—è (–°4) –Ω–∞ —Ä—ñ–≤–Ω—è—Ö –±–∞–∫–∞–ª–∞–≤—Ä–∞ —Ç–∞ –º–∞–≥—ñ—Å—Ç—Ä–∞. –î–µ—Ç–∞–ª—å–Ω—ñ—à–µ: +380 552 494375 üß†"
        
        else:
            return "–ù–∞ –∂–∞–ª—å, –Ω–µ –≤–¥–∞–ª–æ—Å—è —Å—Ñ–æ—Ä–º—É–≤–∞—Ç–∏ –∫–æ—Ä–µ–∫—Ç–Ω—É –≤—ñ–¥–ø–æ–≤—ñ–¥—å. –ó–≤–µ—Ä–Ω–∏—Å—è –¥–æ –ø—Ä–∏–π–º–∞–ª—å–Ω–æ—ó –∫–æ–º—ñ—Å—ñ—ó –•–î–£ –∑–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–æ–º +380 552 494375 –¥–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –∞–∫—Ç—É–∞–ª—å–Ω–æ—ó —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó."

