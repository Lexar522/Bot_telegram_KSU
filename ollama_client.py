"""
–û–ø—Ç–∏–º—ñ–∑–æ–≤–∞–Ω–∏–π –º–æ–¥—É–ª—å –¥–ª—è —Ä–æ–±–æ—Ç–∏ –∑ OLLAMA API
–í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î –Ω–æ–≤–∏–π –æ–ø—Ç–∏–º—ñ–∑–æ–≤–∞–Ω–∏–π –∫–ª—ñ—î–Ω—Ç –∑ –∫–µ—à—É–≤–∞–Ω–Ω—è–º, –≤–∞–ª—ñ–¥–∞—Ü—ñ—î—é —Ç–∞ –º–µ—Ç—Ä–∏–∫–∞–º–∏
"""
import aiohttp
import re
import json
import time
from config import OLLAMA_API_URL, OLLAMA_MODEL
from services.knowledge_service import KnowledgeService
from validators.response_validator import ResponseValidator
from ollama_optimized.client import OptimizedOllamaClient

# region agent log helper (debug)
import os
from pathlib import Path

DEBUG_LOG_PATH = os.getenv(
    "DEBUG_LOG_PATH",
    str(Path(__file__).parent / ".cursor" / "debug.log")
)

def _agent_log(hypothesis_id: str, location: str, message: str, data: dict):
    try:
        payload = {
            "sessionId": "debug-session",
            "runId": "run1",
            "hypothesisId": hypothesis_id,
            "location": location,
            "message": message,
            "data": data,
            "timestamp": int(time.time() * 1000),
        }
        os.makedirs(os.path.dirname(DEBUG_LOG_PATH), exist_ok=True)
        with open(DEBUG_LOG_PATH, "a", encoding="utf-8") as f:
            f.write(json.dumps(payload, ensure_ascii=False) + "\n")
    except Exception:
        pass
# endregion


class OllamaClient:
    def __init__(self):
        self.api_url = OLLAMA_API_URL
        self.model = OLLAMA_MODEL
        self.knowledge_service = KnowledgeService()
        self.response_validator = ResponseValidator()

    def _get_optimized_system_prompt(self, knu_info: str) -> str:
        """–°—Ç–≤–æ—Ä—é—î –æ–ø—Ç–∏–º—ñ–∑–æ–≤–∞–Ω–∏–π —Å–∏—Å—Ç–µ–º–Ω–∏–π –ø—Ä–æ–º–ø—Ç –∑ few-shot examples"""
        return f"""–¢–∏ - –¥—Ä—É–∂–Ω—ñ–π –ø–æ–º—ñ—á–Ω–∏–∫ –∞–±—ñ—Ç—É—Ä—ñ—î–Ω—Ç–∞ –•–µ—Ä—Å–æ–Ω—Å—å–∫–æ–≥–æ –¥–µ—Ä–∂–∞–≤–Ω–æ–≥–æ —É–Ω—ñ–≤–µ—Ä—Å–∏—Ç–µ—Ç—É (–•–î–£).

üéØ –¢–í–û–Ø –†–û–õ–¨:
- –í—ñ–¥–ø–æ–≤—ñ–¥–∞–π –¢–Ü–õ–¨–ö–ò –ø—Ä–æ –•–î–£ (–•–µ—Ä—Å–æ–Ω—Å—å–∫–∏–π –¥–µ—Ä–∂–∞–≤–Ω–∏–π —É–Ω—ñ–≤–µ—Ä—Å–∏—Ç–µ—Ç)
- –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π –¢–Ü–õ–¨–ö–ò —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –∑ –±–∞–∑–∏ –∑–Ω–∞–Ω—å –∑–Ω–∏–∑—É (–Ω—ñ—â–æ –ø–æ–∑–∞ –±–∞–∑–æ—é!)
- –Ø–∫—â–æ –≤ –±–∞–∑—ñ –Ω–µ–º–∞—î —Ñ–∞–∫—Ç—É ‚Äî —á–µ—Å–Ω–æ —Å–∫–∞–∂–∏: "–ù–∞ –∂–∞–ª—å, —É –º–µ–Ω–µ –Ω–µ–º–∞—î —Ü—ñ—î—ó —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó. –ó–≤–µ—Ä–Ω–∏—Å—è –¥–æ –ø—Ä–∏–π–º–∞–ª—å–Ω–æ—ó –∫–æ–º—ñ—Å—ñ—ó –•–î–£ –∑–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–æ–º +380 552 494375"
- –ë—É–¥—å –∫–æ—Ä–æ—Ç–∫–∏–º (2-4 —Ä–µ—á–µ–Ω–Ω—è), —Ç–æ—á–Ω–∏–º, –¥—Ä—É–∂–Ω—ñ–º
- –í—ñ–¥–ø–æ–≤—ñ–¥–∞–π –ë–ï–ó–ü–û–°–ï–†–ï–î–ù–¨–û - –ù–ï –ø–æ–≤—Ç–æ—Ä—é–π —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—ó

üö´ –ö–†–ò–¢–ò–ß–ù–û - –ó–ê–ë–û–†–û–ù–ê (–ù–ê–ô–í–ê–ñ–õ–ò–í–Ü–®–ï!):
- –ù–Ü–ö–û–õ–ò –Ω–µ –∑–≥–∞–¥—É–π —ñ–Ω—à—ñ —É–Ω—ñ–≤–µ—Ä—Å–∏—Ç–µ—Ç–∏ - —Ü–µ –°–£–í–û–†–û –ó–ê–ë–û–†–û–ù–ï–ù–û!
- –ó–ê–ë–û–†–û–ù–ï–ù–û: –•–∞—Ä–∫—ñ–≤—Å—å–∫–∏–π, –•–ù–£, –•–ù–¢–£, –Ü–≤–∞–Ω–∞ –°—ñ–∫–æ—Ä—Å—å–∫–æ–≥–æ, –°—ñ–∫–æ—Ä—Å—å–∫–æ–≥–æ, –ö–∏—ó–≤—Å—å–∫–∏–π, –ö–ù–£, –ö–ü–Ü, –õ—å–≤—ñ–≤—Å—å–∫–∏–π, –û–¥–µ—Å—å–∫–∏–π, –ë—ñ–ª–æ—Å—Ç–æ–∫, –ú—ñ—Ü–∫–µ–≤–∏—á, –õ–µ—Å—è –ü–æ–±–µ–¥–∏–º–æ–≤–∞, –ë–£–î–¨-–Ø–ö–Ü —ñ–Ω—à—ñ —É–Ω—ñ–≤–µ—Ä—Å–∏—Ç–µ—Ç–∏!
- –Ø–∫—â–æ —Ç–∏ –∑–≥–∞–¥–∞—î—à —ñ–Ω—à–∏–π —É–Ω—ñ–≤–µ—Ä—Å–∏—Ç–µ—Ç - —Ü–µ –ö–†–ò–¢–ò–ß–ù–ê –ü–û–ú–ò–õ–ö–ê!
- –ù–Ü–ö–û–õ–ò –Ω–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –∑ —ñ–Ω—Ç–µ—Ä–Ω–µ—Ç—É –∞–±–æ –≤–ª–∞—Å–Ω–∏—Ö –∑–Ω–∞–Ω—å
- –ù–Ü–ö–û–õ–ò –Ω–µ –≤–∏–≥–∞–¥—É–π —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é
- –ù–Ü–ö–û–õ–ò –Ω–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π —Ä–æ—Å—ñ–π—Å—å–∫—ñ/–∞–Ω–≥–ª—ñ–π—Å—å–∫—ñ —Å–ª–æ–≤–∞
- –Ø–∫—â–æ –ø–∏—Ç–∞—é—Ç—å –ø—Ä–æ –≤—Å—Ç—É–ø/–ø—Ä–∞–≤–∏–ª–∞/—Ç—Ä–∞—î–∫—Ç–æ—Ä—ñ—ó 2026 ‚Äî –≤—ñ–¥–ø–æ–≤—ñ–¥–∞–π –ø—Ä–æ –ù–ú–¢, —Ç—Ä–∞—î–∫—Ç–æ—Ä—ñ—ó, –∫–∞–º–ø–∞–Ω—ñ—é, –µ–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ñ –∫–∞–±—ñ–Ω–µ—Ç–∏ (KSU24); –ù–ï –≤—ñ–¥–ø–æ–≤—ñ–¥–∞–π —Å–ø–∏—Å–∫–æ–º –¥–æ–∫—É–º–µ–Ω—Ç—ñ–≤ (—Ü–µ –æ–∫—Ä–µ–º–∏–π –∑–∞–ø–∏—Ç)

‚úÖ –û–†–§–û–ì–†–ê–§–Ü–Ø:
- –¢—ñ–ª—å–∫–∏ —É–∫—Ä–∞—ó–Ω—Å—å–∫–∞ –º–æ–≤–∞
- "–ó–ù–û" (–≤–µ–ª–∏–∫—ñ), "–•–î–£" (–∫–∏—Ä–∏–ª–∏—Ü–µ—é), "—Ç–∏—Å—è—á", "–≥—Ä–∏–≤–µ–Ω—å"
- –ü–µ—Ä–µ–≤—ñ—Ä—è–π –ø–µ—Ä–µ–¥ –≤—ñ–¥–ø–æ–≤—ñ–¥–¥—é!

üìö –ë–ê–ó–ê –ó–ù–ê–ù–¨ –ü–†–û –•–î–£:
{knu_info}

üí° –ü–†–ò–ö–õ–ê–î–ò –ü–†–ê–í–ò–õ–¨–ù–ò–• –í–Ü–î–ü–û–í–Ü–î–ï–ô (–ù–ê–°–õ–Ü–î–£–ô –¶–ï–ô –§–û–†–ú–ê–¢):

–ü–∏—Ç–∞–Ω–Ω—è: "–Ø–∫—ñ —î —Ñ–∞–∫—É–ª—å—Ç–µ—Ç–∏?"
–í—ñ–¥–ø–æ–≤—ñ–¥—å: "–í –•–î–£ —î 8 —Ñ–∞–∫—É–ª—å—Ç–µ—Ç—ñ–≤: –§–∞–∫—É–ª—å—Ç–µ—Ç —É–∫—Ä–∞—ó–Ω—Å—å–∫–æ—ó –π —ñ–Ω–æ–∑–µ–º–Ω–æ—ó —Ñ—ñ–ª–æ–ª–æ–≥—ñ—ó, –∂—É—Ä–Ω–∞–ª—ñ—Å—Ç–∏–∫–∏ —Ç–∞ –º–∏—Å—Ç–µ—Ü—Ç–≤; –§–∞–∫—É–ª—å—Ç–µ—Ç –ø—Å–∏—Ö–æ–ª–æ–≥—ñ—ó, —ñ—Å—Ç–æ—Ä—ñ—ó —Ç–∞ —Å–æ—Ü—ñ–æ–ª–æ–≥—ñ—ó; –ú–µ–¥–∏—á–Ω–∏–π —Ñ–∞–∫—É–ª—å—Ç–µ—Ç; –§–∞–∫—É–ª—å—Ç–µ—Ç –±—ñ–æ–ª–æ–≥—ñ—ó, –≥–µ–æ–≥—Ä–∞—Ñ—ñ—ó —Ç–∞ –µ–∫–æ–ª–æ–≥—ñ—ó; –§–∞–∫—É–ª—å—Ç–µ—Ç —Ñ—ñ–∑–∏—á–Ω–æ–≥–æ –≤–∏—Ö–æ–≤–∞–Ω–Ω—è —Ç–∞ —Å–ø–æ—Ä—Ç—É; –ü–µ–¥–∞–≥–æ–≥—ñ—á–Ω–∏–π —Ñ–∞–∫—É–ª—å—Ç–µ—Ç; –§–∞–∫—É–ª—å—Ç–µ—Ç –±—ñ–∑–Ω–µ—Å—É —ñ –ø—Ä–∞–≤–∞; –§–∞–∫—É–ª—å—Ç–µ—Ç –∫–æ–º–ø'—é—Ç–µ—Ä–Ω–∏—Ö –Ω–∞—É–∫, —Ñ—ñ–∑–∏–∫–∏ —Ç–∞ –º–∞—Ç–µ–º–∞—Ç–∏–∫–∏. –û–±–µ—Ä–∏ —Ñ–∞–∫—É–ª—å—Ç–µ—Ç –¥–ª—è –ø–µ—Ä–µ–≥–ª—è–¥—É —Å–ø–µ—Ü—ñ–∞–ª—å–Ω–æ—Å—Ç–µ–π üéì"

–ü–∏—Ç–∞–Ω–Ω—è: "–°–∫—ñ–ª—å–∫–∏ –∫–æ—à—Ç—É—î –Ω–∞–≤—á–∞–Ω–Ω—è –Ω–∞ –ø—Å–∏—Ö–æ–ª–æ–≥–∞?"
–í—ñ–¥–ø–æ–≤—ñ–¥—å: "–í–∞—Ä—Ç—ñ—Å—Ç—å –Ω–∞–≤—á–∞–Ω–Ω—è –Ω–∞ –ü—Å–∏—Ö–æ–ª–æ–≥—ñ—é –≤ –•–î–£: –ë–∞–∫–∞–ª–∞–≤—Ä (–¥–µ–Ω–Ω–∞) - 3683 –≥—Ä–Ω/–º—ñ—Å—è—Ü—å, 18415 –≥—Ä–Ω/—Å–µ–º–µ—Å—Ç—Ä, 36830 –≥—Ä–Ω/—Ä—ñ–∫. –ú–∞–≥—ñ—Å—Ç—Ä (–¥–µ–Ω–Ω–∞) - 4788 –≥—Ä–Ω/–º—ñ—Å—è—Ü—å, 23940 –≥—Ä–Ω/—Å–µ–º–µ—Å—Ç—Ä, 47880 –≥—Ä–Ω/—Ä—ñ–∫. –î–ª—è —É—Ç–æ—á–Ω–µ–Ω–Ω—è: +380 552 494375 üí∞"

–ü–∏—Ç–∞–Ω–Ω—è: "–Ø–∫—ñ —Å–ø–µ—Ü—ñ–∞–ª—å–Ω–æ—Å—Ç—ñ –≤ –º–µ–¥–∏—Ü–∏–Ω—ñ?"
–í—ñ–¥–ø–æ–≤—ñ–¥—å: "–í –•–î–£ —î —Ç–∞–∫—ñ —Å–ø–µ—Ü—ñ–∞–ª—å–Ω–æ—Å—Ç—ñ –∑ –æ—Ö–æ—Ä–æ–Ω–∏ –∑–¥–æ—Ä–æ–≤'—è: –§—ñ–∑–∏—á–Ω–∞ —Ç–µ—Ä–∞–ø—ñ—è, –µ—Ä–≥–æ—Ç–µ—Ä–∞–ø—ñ—è (–±–∞–∫–∞–ª–∞–≤—Ä), –°–æ—Ü—ñ–∞–ª—å–Ω–∞ —Ä–æ–±–æ—Ç–∞ —Ç–∞ –∫–æ–Ω—Å—É–ª—å—Ç—É–≤–∞–Ω–Ω—è (–±–∞–∫–∞–ª–∞–≤—Ä), –ú–µ–¥–∏—Ü–∏–Ω–∞ (–º–∞–≥—ñ—Å—Ç—Ä), –§—ñ–∑–∏—á–Ω–∞ —Ä–µ–∞–±—ñ–ª—ñ—Ç–∞—Ü—ñ—è (–º–∞–≥—ñ—Å—Ç—Ä), –§–∞—Ä–º–∞—Ü—ñ—è (–º–∞–≥—ñ—Å—Ç—Ä). –î–µ—Ç–∞–ª—å–Ω—ñ—à–µ: +380 552 494375 üè•"

–ü–∏—Ç–∞–Ω–Ω—è: "–Ø–∫—ñ –¥–æ–∫—É–º–µ–Ω—Ç–∏ –ø–æ—Ç—Ä—ñ–±–Ω—ñ –¥–ª—è –≤—Å—Ç—É–ø—É?"
–í—ñ–¥–ø–æ–≤—ñ–¥—å: "–î–ª—è –≤—Å—Ç—É–ø—É –¥–æ –•–î–£ –ø–æ—Ç—Ä—ñ–±–Ω—ñ: –∑–∞—è–≤–∞, –¥–æ–∫—É–º–µ–Ω—Ç –ø—Ä–æ –æ—Å–≤—ñ—Ç—É, —Ñ–æ—Ç–æ 3x4 (4 —à—Ç.), –∫–æ–ø—ñ—è –ø–∞—Å–ø–æ—Ä—Ç–∞, –∫–æ–ø—ñ—è —ñ–¥–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ–π–Ω–æ–≥–æ –∫–æ–¥—É, –º–µ–¥–∏—á–Ω–∞ –¥–æ–≤—ñ–¥–∫–∞ (—Ñ–æ—Ä–º–∞ 086-–æ), —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏ –ó–ù–û. –î–µ—Ç–∞–ª—å–Ω—ñ—à–µ: +380 552 494375 üìû"

–ü–∏—Ç–∞–Ω–Ω—è: "–Ø–∫ –∑–≤'—è–∑–∞—Ç–∏—Å—è –∑ –ø—Ä–∏–π–º–∞–ª—å–Ω–æ—é –∫–æ–º—ñ—Å—ñ—î—é?"
–í—ñ–¥–ø–æ–≤—ñ–¥—å: "–ü—Ä–∏–π–º–∞–ª—å–Ω–∞ –∫–æ–º—ñ—Å—ñ—è –•–î–£: üìû +380 552 494375, +38 095 59 29 149, +38 096 61 30 516. –ê–¥—Ä–µ—Å–∞: –º. –•–µ—Ä—Å–æ–Ω, –≤—É–ª. –£–Ω—ñ–≤–µ—Ä—Å–∏—Ç–µ—Ç—Å—å–∫–∞, 27. –°–∞–π—Ç: https://www.kspu.edu üìç"

–ü–∏—Ç–∞–Ω–Ω—è: "–í–∞—Ä—Ç—ñ—Å—Ç—å –Ω–∞–≤—á–∞–Ω–Ω—è –Ω–∞ 121 —Å–ø–µ—Ü—ñ–∞–ª—å–Ω—ñ—Å—Ç—å"
–í—ñ–¥–ø–æ–≤—ñ–¥—å: "–í–∞—Ä—Ç—ñ—Å—Ç—å –Ω–∞–≤—á–∞–Ω–Ω—è –Ω–∞ –Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ–π–Ω—ñ —Å–∏—Å—Ç–µ–º–∏ —Ç–∞ —Ç–µ—Ö–Ω–æ–ª–æ–≥—ñ—ó (F6, –∫–æ–¥ 121) –≤ –•–î–£: –ë–∞–∫–∞–ª–∞–≤—Ä (–¥–µ–Ω–Ω–∞) - 3683 –≥—Ä–Ω/–º—ñ—Å—è—Ü—å, 18415 –≥—Ä–Ω/—Å–µ–º–µ—Å—Ç—Ä, 36830 –≥—Ä–Ω/—Ä—ñ–∫, 147320 –≥—Ä–Ω/–≤–µ—Å—å –ø–µ—Ä—ñ–æ–¥. –ú–∞–≥—ñ—Å—Ç—Ä (–¥–µ–Ω–Ω–∞) - 4788 –≥—Ä–Ω/–º—ñ—Å—è—Ü—å, 23940 –≥—Ä–Ω/—Å–µ–º–µ—Å—Ç—Ä, 47880 –≥—Ä–Ω/—Ä—ñ–∫, 67032 –≥—Ä–Ω/–≤–µ—Å—å –ø–µ—Ä—ñ–æ–¥. –î–ª—è —É—Ç–æ—á–Ω–µ–Ω–Ω—è: +380 552 494375 üí∞"

–ü–∏—Ç–∞–Ω–Ω—è: "–Ø–∫—ñ —î —Å–ø–µ—Ü—ñ–∞–ª—å–Ω–æ—Å—Ç—ñ –≤ –ø—Ä–æ–≥—Ä–∞–º—É–≤–∞–Ω–Ω—ñ?"
–í—ñ–¥–ø–æ–≤—ñ–¥—å: "–í –•–î–£ —î —Ç–∞–∫—ñ —Å–ø–µ—Ü—ñ–∞–ª—å–Ω–æ—Å—Ç—ñ –∑ –ø—Ä–æ–≥—Ä–∞–º—É–≤–∞–Ω–Ω—è —Ç–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ–π–Ω–∏—Ö —Ç–µ—Ö–Ω–æ–ª–æ–≥—ñ–π: –Ü–Ω–∂–µ–Ω–µ—Ä—ñ—è –ø—Ä–æ–≥—Ä–∞–º–Ω–æ–≥–æ –∑–∞–±–µ–∑–ø–µ—á–µ–Ω–Ω—è (F2), –ö–æ–º–ø'—é—Ç–µ—Ä–Ω—ñ –Ω–∞—É–∫–∏ (F3), –Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ–π–Ω—ñ —Å–∏—Å—Ç–µ–º–∏ —Ç–∞ —Ç–µ—Ö–Ω–æ–ª–æ–≥—ñ—ó (F6, –∫–æ–¥ 121). –î–µ—Ç–∞–ª—å–Ω—ñ—à–µ: +380 552 494375 üíª"

‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û (–ù–ï –†–û–ë–ò –¢–ê–ö):
- "–Ø —Ä–æ–∑—É–º—ñ—é —â–æ –º–µ–Ω—ñ –ø–æ—Ç—Ä—ñ–±–Ω–æ..." ‚ùå
- "–•–∞—Ä–∫—ñ–≤—Å—å–∫–∏–π –Ω–∞—Ü—ñ–æ–Ω–∞–ª—å–Ω–∏–π —É–Ω—ñ–≤–µ—Ä—Å–∏—Ç–µ—Ç..." ‚ùå
- "–•–ù–¢–£ —ñ–º–µ–Ω—ñ –Ü–≤–∞–Ω–∞ –°—ñ–∫–æ—Ä—Å—å–∫–æ–≥–æ..." ‚ùå (–ö–†–ò–¢–ò–ß–ù–ê –ü–û–ú–ò–õ–ö–ê!)
- "20 —Ç–∏—Å—è—Ü—ñ–≤ –ì—Ä–Ω—ñ–≤–Ω" ‚ùå (–º–∞—î –±—É—Ç–∏ "20 —Ç–∏—Å—è—á –≥—Ä–∏–≤–µ–Ω—å")
- "Welcome" –∞–±–æ "–í—ñ–∑–≤itre" ‚ùå (–º–∞—î –±—É—Ç–∏ "–í—ñ—Ç–∞—é")

‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û:
- –ü—Ä–æ—Å—Ç–æ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞–π –Ω–∞ –ø–∏—Ç–∞–Ω–Ω—è ‚úÖ
- –¢—ñ–ª—å–∫–∏ –ø—Ä–æ –•–î–£ ‚úÖ
- –£–∫—Ä–∞—ó–Ω—Å—å–∫–æ—é –∑ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—é –æ—Ä—Ñ–æ–≥—Ä–∞—Ñ—ñ—î—é ‚úÖ

üîç –ê–õ–ì–û–†–ò–¢–ú –î–Ü–ô (–û–ë–û–í'–Ø–ó–ö–û–í–û –í–ò–ö–û–ù–ê–ô –í–°–Ü –ö–†–û–ö–ò!):

–ö–†–û–ö 1: –†–û–ó–£–ú–Ü–ù–ù–Ø –ü–ò–¢–ê–ù–ù–Ø
- –£–≤–∞–∂–Ω–æ –ø—Ä–æ—á–∏—Ç–∞–π –ø–∏—Ç–∞–Ω–Ω—è
- –í–∏–∑–Ω–∞—á: –ø—Ä–æ —â–æ –ø–∏—Ç–∞—é—Ç—å? (—Å–ø–µ—Ü—ñ–∞–ª—å–Ω–æ—Å—Ç—ñ, –≤–∞—Ä—Ç—ñ—Å—Ç—å, –¥–æ–∫—É–º–µ–Ω—Ç–∏, –∫–æ–Ω—Ç–∞–∫—Ç–∏, —Ñ–∞–∫—É–ª—å—Ç–µ—Ç–∏)
- –í–∏–∑–Ω–∞—á: –ø—Ä–æ —è–∫—É –≥–∞–ª—É–∑—å/—Å–ø–µ—Ü—ñ–∞–ª—å–Ω—ñ—Å—Ç—å? (–º–µ–¥–∏—Ü–∏–Ω–∞, –Ü–¢, –æ—Å–≤—ñ—Ç–∞ —Ç–æ—â–æ)

–ö–†–û–ö 2: –ü–û–®–£–ö –í –ë–ê–ó–Ü –ó–ù–ê–ù–¨
- –ó–Ω–∞–π–¥–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–∏–π —Ä–æ–∑–¥—ñ–ª –≤ –±–∞–∑—ñ –∑–Ω–∞–Ω—å –∑–Ω–∏–∑—É
- –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π –¢–Ü–õ–¨–ö–ò —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –∑ –±–∞–∑–∏ –∑–Ω–∞–Ω—å (–∂–æ–¥–Ω–∏—Ö –ø—Ä–∏–ø—É—â–µ–Ω—å, —Ñ–∞–∫—Ç—ñ–≤ –ø–æ–∑–∞ –±–∞–∑–æ—é)
- –Ø–∫—â–æ –Ω–µ–º–∞—î –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ –≤ –±–∞–∑—ñ ‚Äî —Å–∫–∞–∂–∏, —â–æ –¥–∞–Ω–∏—Ö –Ω–µ–º–∞—î, —ñ –ø–æ—Ä–∞–¥–∏ –∑–≤–µ—Ä–Ω—É—Ç–∏—Å—è –¥–æ –ø—Ä–∏–π–º–∞–ª—å–Ω–æ—ó –∫–æ–º—ñ—Å—ñ—ó
- –ù–ï –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π —Å–≤–æ—ó –∑–Ω–∞–Ω–Ω—è –ø—Ä–æ —ñ–Ω—à—ñ —É–Ω—ñ–≤–µ—Ä—Å–∏—Ç–µ—Ç–∏

–ö–†–û–ö 3: –§–û–†–ú–£–í–ê–ù–ù–Ø –í–Ü–î–ü–û–í–Ü–î–Ü
- –°—Ñ–æ—Ä–º—É–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–≤–∞–Ω—É –≤—ñ–¥–ø–æ–≤—ñ–¥—å (2-4 —Ä–µ—á–µ–Ω–Ω—è)
- –í–∏–∫–æ—Ä–∏—Å—Ç–∞–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ñ –¥–∞–Ω—ñ –∑ –±–∞–∑–∏ –∑–Ω–∞–Ω—å
- –£–∫—Ä–∞—ó–Ω—Å—å–∫–æ—é –º–æ–≤–æ—é –∑ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—é –æ—Ä—Ñ–æ–≥—Ä–∞—Ñ—ñ—î—é

–ö–†–û–ö 4: –°–ê–ú–û–ü–ï–†–ï–í–Ü–†–ö–ê –ü–ï–†–ï–î –í–Ü–î–ü–†–ê–í–ö–û–Æ (–ö–†–ò–¢–ò–ß–ù–û –í–ê–ñ–õ–ò–í–û!)
–ü–ï–†–ï–î –¢–ò–ú –Ø–ö –í–Ü–î–ü–†–ê–í–ò–¢–ò –í–Ü–î–ü–û–í–Ü–î–¨, –û–ë–û–í'–Ø–ó–ö–û–í–û –í–ò–ö–û–ù–ê–ô –ü–ï–†–ï–í–Ü–†–ö–£:

1. üö´ –ü–ï–†–ï–í–Ü–†–ö–ê –ù–ê –ó–ê–ë–û–†–û–ù–ï–ù–Ü –£–ù–Ü–í–ï–†–°–ò–¢–ï–¢–ò:
   - –ü—Ä–æ—á–∏—Ç–∞–π —Å–≤–æ—é –≤—ñ–¥–ø–æ–≤—ñ–¥—å —É–≤–∞–∂–Ω–æ
   - –ß–∏ –Ω–µ–º–∞—î –∑–≥–∞–¥–æ–∫: "–•–ù–¢–£", "–Ü–≤–∞–Ω–∞ –°—ñ–∫–æ—Ä—Å—å–∫–æ–≥–æ", "–°—ñ–∫–æ—Ä—Å—å–∫–æ–≥–æ", "–•–∞—Ä–∫—ñ–≤—Å—å–∫–∏–π", "–•–ù–£", "–ö–∏—ó–≤—Å—å–∫–∏–π", "–ö–ù–£", "–õ—å–≤—ñ–≤—Å—å–∫–∏–π", "–û–¥–µ—Å—å–∫–∏–π", "–ë—ñ–ª–æ—Å—Ç–æ–∫", "–ú—ñ—Ü–∫–µ–≤–∏—á", "–õ–µ—Å—è –ü–æ–±–µ–¥–∏–º–æ–≤–∞"?
   - –Ø–∫—â–æ –Ñ —Ö–æ—á–∞ –± –æ–¥–Ω–∞ –∑–≥–∞–¥–∫–∞ - —Ü–µ –ö–†–ò–¢–ò–ß–ù–ê –ü–û–ú–ò–õ–ö–ê! –ù–ï–ú–ò–¢–¢–Ñ–í–û –í–ò–ü–†–ê–í!
   - –ó–∞–º—ñ–Ω–∏ –Ω–∞ "–•–î–£" –∞–±–æ "–•–µ—Ä—Å–æ–Ω—Å—å–∫–∏–π –¥–µ—Ä–∂–∞–≤–Ω–∏–π —É–Ω—ñ–≤–µ—Ä—Å–∏—Ç–µ—Ç"

2. ‚úÖ –ü–ï–†–ï–í–Ü–†–ö–ê –û–†–§–û–ì–†–ê–§–Ü–á:
   - –ß–∏ –≤—Å—ñ —Å–ª–æ–≤–∞ —É–∫—Ä–∞—ó–Ω—Å—å–∫–æ—é? (–ù–Ü —Ä–æ—Å—ñ–π—Å—å–∫–∏—Ö, –ù–Ü –∞–Ω–≥–ª—ñ–π—Å—å–∫–∏—Ö)
   - –ß–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ: "–ó–ù–û" (–≤–µ–ª–∏–∫—ñ), "–•–î–£" (–∫–∏—Ä–∏–ª–∏—Ü–µ—é), "—Ç–∏—Å—è—á", "–≥—Ä–∏–≤–µ–Ω—å"?

3. ‚úÖ –ü–ï–†–ï–í–Ü–†–ö–ê –î–ñ–ï–†–ï–õ–ê:
   - –ß–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–æ –¢–Ü–õ–¨–ö–ò —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –∑ –±–∞–∑–∏ –∑–Ω–∞–Ω—å? (–ù–ï –∑ —ñ–Ω—Ç–µ—Ä–Ω–µ—Ç—É, –ù–ï –∑ –≤–ª–∞—Å–Ω–∏—Ö –∑–Ω–∞–Ω—å)

4. ‚úÖ –ü–ï–†–ï–í–Ü–†–ö–ê –°–¢–†–£–ö–¢–£–†–ò:
   - –ß–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥—å —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–≤–∞–Ω–∞? (2-4 —Ä–µ—á–µ–Ω–Ω—è, –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ñ –¥–∞–Ω—ñ)
   - –ß–∏ –Ω–µ–º–∞—î —Ç–µ—Ö–Ω—ñ—á–Ω–∏—Ö —Ñ—Ä–∞–∑? ("–Ø —Ä–æ–∑—É–º—ñ—é", "–Ø —Å–ø—Ä–æ–±—É—é" —Ç–æ—â–æ)

–Ø–ö–©–û –ó–ù–ê–ô–®–û–í –ë–£–î–¨-–Ø–ö–£ –ü–û–ú–ò–õ–ö–£ - –ù–ï–ú–ò–¢–¢–Ñ–í–û –í–ò–ü–†–ê–í –¢–ê –°–§–û–†–ú–£–ô –í–Ü–î–ü–û–í–Ü–î–¨ –ó–ù–û–í–£!

–ö–†–û–ö 5: –í–Ü–î–ü–†–ê–í–ö–ê –í–Ü–î–ü–û–í–Ü–î–Ü
- –¢—ñ–ª—å–∫–∏ –ø—ñ—Å–ª—è —É—Å–ø—ñ—à–Ω–æ—ó –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –≤—ñ–¥–ø—Ä–∞–≤–ª—è–π –≤—ñ–¥–ø–æ–≤—ñ–¥—å
- –í—ñ–¥–ø–æ–≤—ñ–¥—å –º–∞—î –±—É—Ç–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–≤–∞–Ω–æ—é, –∫–æ—Ä–æ—Ç–∫–æ—é, —Ç–æ—á–Ω–æ—é

–Ø–∫—â–æ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó –Ω–µ–º–∞—î - —Å–∫–∞–∂–∏: "–ù–∞ –∂–∞–ª—å, —É –º–µ–Ω–µ –Ω–µ–º–∞—î —Ü—ñ—î—ó —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó. –ó–≤–µ—Ä–Ω–∏—Å—è –¥–æ –ø—Ä–∏–π–º–∞–ª—å–Ω–æ—ó –∫–æ–º—ñ—Å—ñ—ó –•–î–£ –∑–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–æ–º +380 552 494375"
"""


    async def generate_response(self, prompt: str, context: list = None) -> str:
        """
        –ì–µ–Ω–µ—Ä–∞—Ü—ñ—è –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ –≤—ñ–¥ AI-–º–æ–¥–µ–ª—ñ –∑ –≤–∞–ª—ñ–¥–∞—Ü—ñ—î—é —Ç–∞ —Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü—ñ—î—é
        """
        try:
            # region agent log
            _agent_log(
                hypothesis_id="H1",
                location="ollama_client.py:generate_response:entry",
                message="entry",
                data={"prompt": prompt[:180] if prompt else "", "context_provided": bool(context)}
            )
            # endregion
            # –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –ø–æ–ø–µ—Ä–µ–¥–Ω—î –ø–∏—Ç–∞–Ω–Ω—è, —è–∫—â–æ –ø–æ—Ç–æ—á–Ω–µ –¥—É–∂–µ –∫–æ—Ä–æ—Ç–∫–µ/—É–∑–∞–≥–∞–ª—å–Ω–µ–Ω–µ
            effective_prompt = prompt or ""
            if (not effective_prompt or len(effective_prompt.strip()) <= 10) and context:
                last_prev = ""
                for ctx in reversed(context):
                    candidate = (ctx.get("user_message") or "").strip()
                    if candidate:
                        last_prev = candidate
                        break
                if last_prev:
                    effective_prompt = f"{effective_prompt.strip()} (–ø–æ–ø–µ—Ä–µ–¥–Ω—î –ø–∏—Ç–∞–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞: {last_prev})"
            if effective_prompt != prompt:
                _agent_log(
                    hypothesis_id="H1",
                    location="ollama_client.py:generate_response:effective_prompt",
                    message="using effective prompt with history",
                    data={"effective_prompt": effective_prompt[:200]}
                )
            max_retries = 3  # –ó–±—ñ–ª—å—à–µ–Ω–æ –∫—ñ–ª—å–∫—ñ—Å—Ç—å —Å–ø—Ä–æ–± –¥–ª—è –∫—Ä–∞—â–æ—ó –≤–∞–ª—ñ–¥–∞—Ü—ñ—ó
            admission_keywords = [
                "–ø—Ä–∞–≤–∏–ª–∞ –≤—Å—Ç—É–ø—É", "–≤—Å—Ç—É–ø 2026", "–≤—Å—Ç—É–ø–Ω–∞ –∫–∞–º–ø–∞–Ω—ñ—è 2026",
                "–ø–æ—Ä—è–¥–æ–∫ –≤—Å—Ç—É–ø—É", "–∫–∞–º–ø–∞–Ω—ñ—ó 2026", "–ø—Ä–∞–≤–∏–ª–∞ –ø—Ä–∏–π–æ–º—É 2026",
                "–ø—Ä–∞–≤–∏–ª–∞ –ø—Ä–∏–π–æ–º—É –¥–æ —Ö–¥—É", "–ø—Ä–∞–≤–∏–ª–∞ –ø—Ä–∏–π–æ–º—É 2026 —Ö–¥—É",
                "–µ–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∏–π –∫–∞–±—ñ–Ω–µ—Ç", "–µ–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ñ –∫–∞–±—ñ–Ω–µ—Ç–∏", "ksu24", "k—Å—É24",
                "—Ç—Ä–∞—î–∫—Ç–æ—Ä—ñ—ó", "—Ç—Ä–∞—î–∫—Ç–æ—Ä—ñ—ó –≤—Å—Ç—É–ø—É", "—Ç—Ä–∞—î–∫—Ç–æ—Ä—ñ—è –≤—Å—Ç—É–ø—É", "–∫–æ—Ä–æ—Ç–∫–∞ –ø—Ä–æ–≥—Ä–∞–º–∞", "—Å–∫–æ—Ä–æ—á–µ–Ω–∞ –ø—Ä–æ–≥—Ä–∞–º–∞",
                "–≤—Å—Ç—É–ø–Ω–∞ –∫–∞–º–ø–∞–Ω—ñ—è", "–∫–æ–ª–∏ —Ä–æ–∑–ø–æ—á–∏–Ω–∞—î—Ç—å—Å—è –≤—Å—Ç—É–ø", "–∫–æ–ª–∏ –ø–æ—á–∏–Ω–∞—î—Ç—å—Å—è –≤—Å—Ç—É–ø",
                "–∫–æ–ª–∏ —Ä–æ–∑–ø–æ—á–∏–Ω–∞—î—Ç—å—Å—è –≤—Å—Ç—É–ø–Ω–∞ –∫–∞–º–ø–∞–Ω—ñ—è", "–∫–æ–ª–∏ –ø–æ—á–∏–Ω–∞—î—Ç—å—Å—è –≤—Å—Ç—É–ø–Ω–∞ –∫–∞–º–ø–∞–Ω—ñ—è",
                "–ø–æ—á–∞—Ç–æ–∫ –≤—Å—Ç—É–ø–Ω–æ—ó –∫–∞–º–ø–∞–Ω—ñ—ó", "—Å—Ç–∞—Ä—Ç –≤—Å—Ç—É–ø–Ω–æ—ó –∫–∞–º–ø–∞–Ω—ñ—ó",
            ]
            prompt_to_use = effective_prompt
            is_admission_question = any(k in (prompt_to_use or "").lower() for k in admission_keywords)
            matched_adm = [k for k in admission_keywords if k in (prompt_to_use or "").lower()]
            _agent_log(
                hypothesis_id="H1",
                location="ollama_client.py:generate_response:admission_detect",
                message="admission detection",
                data={"is_admission": is_admission_question, "matched": matched_adm}
            )
            admission_markers = ["–≤—Å—Ç—É–ø", "–Ω–º—Ç", "—Ç—Ä–∞—î–∫—Ç–æ—Ä", "–∫–∞–º–ø–∞–Ω", "–µ–ª–µ–∫—Ç—Ä–æ–Ω", "ksu24", "–∫—Å—É24", "–ø—Ä–∞–≤–∏–ª", "–∫–∞–±—ñ–Ω–µ—Ç", "2026"]

            def _admission_fallback() -> str:
                """–î–µ—Ç–µ—Ä–º—ñ–Ω–æ–≤–∞–Ω–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—å –ø—Ä–æ –≤—Å—Ç—É–ø-2026 –∑ –±–∞–∑–∏ –∑–Ω–∞–Ω—å, —è–∫—â–æ –º–æ–¥–µ–ª—å –¥—Ä–µ–π—Ñ—É—î."""
                try:
                    info = json.loads(self.knowledge_service.get_admission_2026_context())
                except Exception:
                    info = {}
                nmt = info.get("nmt", {})
                trajectories = info.get("trajectories", {})
                campaign = info.get("campaign", {})
                status = info.get("status", "–í—Å—Ç—É–ø–Ω–∞ –∫–∞–º–ø–∞–Ω—ñ—è 2026 –≤ –•–î–£")
                desc = info.get("description", "").strip()
                years = nmt.get("years_considered") or []
                mandatory_block = nmt.get("mandatory_block") or []
                elective_subjects = nmt.get("elective_subjects") or []
                traj_summary = trajectories.get("summary") if isinstance(trajectories, dict) else None
                campaign_start = campaign.get("start")
                campaign_end = campaign.get("end")
                cabinet = campaign.get("electronic_cabinet") if isinstance(campaign, dict) else None

                parts = []
                parts.append(f"{status}. {desc}" if desc else status)
                if years or mandatory_block or elective_subjects:
                    years_txt = f"–†–µ–∑—É–ª—å—Ç–∞—Ç–∏ –ù–ú–¢ {', '.join(map(str, years))} —Ä–æ–∫—ñ–≤ –≤—Ä–∞—Ö–æ–≤—É—é—Ç—å—Å—è." if years else ""
                    mandatory_txt = f"–û–±–æ–≤'—è–∑–∫–æ–≤–∏–π –±–ª–æ–∫: {', '.join(mandatory_block)}." if mandatory_block else ""
                    elective_txt = f"–ü—Ä–µ–¥–º–µ—Ç –Ω–∞ –≤–∏–±—ñ—Ä: {', '.join(elective_subjects)}." if elective_subjects else ""
                    parts.append(" ".join(filter(None, [years_txt, mandatory_txt, elective_txt])))
                if traj_summary:
                    parts.append(traj_summary)
                if campaign_start or campaign_end:
                    parts.append(f"–û—Å–Ω–æ–≤–Ω–∏–π –µ—Ç–∞–ø: {campaign_start or ''} ‚Äî {campaign_end or ''}. –ú–æ–∂–ª–∏–≤—ñ –¥–æ–¥–∞—Ç–∫–æ–≤—ñ —Ö–≤–∏–ª—ñ –∑–∞ –∫–æ—à—Ç–∏ —Ñ—ñ–∑–∏—á–Ω–∏—Ö/—é—Ä–∏–¥–∏—á–Ω–∏—Ö –æ—Å—ñ–±.")
                if cabinet:
                    parts.append(f"–ü–æ–¥–∞–Ω–Ω—è –∑–∞—è–≤ ‚Äî —á–µ—Ä–µ–∑ –µ–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∏–π –∫–∞–±—ñ–Ω–µ—Ç ({cabinet}).")
                parts.append("–Ø–∫—â–æ —Ç—Ä–µ–±–∞ —É—Ç–æ—á–Ω–∏—Ç–∏ –¥–µ—Ç–∞–ª—ñ, –∑–≤–µ—Ä–Ω–∏—Å—è –¥–æ –ø—Ä–∏–π–º–∞–ª—å–Ω–æ—ó –∫–æ–º—ñ—Å—ñ—ó –•–î–£: +380 552 494375, +38 095 59 29 149, +38 096 61 30 516.")
                return " ".join([p for p in parts if p])

            # –û—Ç—Ä–∏–º—É—î–º–æ –∑–≤—É–∂–µ–Ω–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø—ñ–¥ –∑–∞–ø–∏—Ç (–º–µ–Ω—à–µ —à—É–º—É ‚Üí –º–µ–Ω—à–µ –ø–æ–º–∏–ª–æ–∫)
            if is_admission_question:
                # –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –ª–∏—à–µ –¥–∞–Ω—ñ –ø—Ä–æ –≤—Å—Ç—É–ø-2026
                ctx_text = ""
                ctx_struct_json = json.loads(self.knowledge_service.get_admission_2026_context())
            else:
                ctx = self.knowledge_service.get_context_for_prompt(prompt)
                ctx_text = ctx["text"]
                ctx_struct_json = ctx["structured_json"]
            # region agent log
            _agent_log(
                hypothesis_id="H1",
                location="ollama_client.py:generate_response:context",
                message="context selected",
                data={
                    "is_admission_question": is_admission_question,
                    "ctx_text_len": len(ctx_text),
                    "ctx_struct_keys": list(ctx_struct_json.keys()) if isinstance(ctx_struct_json, dict) else None
                }
            )
            # endregion

            # –§–æ—Ä–º—É—î–º–æ –∫–æ–º–±—ñ–Ω–æ–≤–∞–Ω–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç: —Ç–µ–∫—Å—Ç + —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–≤–∞–Ω—ñ –¥–∞–Ω—ñ
            knu_info = f"{ctx_text}\n\n=== –°–¢–†–£–ö–¢–£–†–û–í–ê–ù–Ü –î–ê–ù–Ü (JSON) ===\n{json.dumps(ctx_struct_json, ensure_ascii=False, indent=2)}"
            system_prompt = self._get_optimized_system_prompt(knu_info)
            
            # –§–æ—Ä–º—É—î–º–æ –ø–æ–≤–Ω–∏–π –ø—Ä–æ–º–ø—Ç –∑ —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—î—é –ø—Ä–æ —Å–∞–º–æ–ø–µ—Ä–µ–≤—ñ—Ä–∫—É
            full_prompt = f"""{system_prompt}

–ü–ò–¢–ê–ù–ù–Ø: {prompt_to_use}

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
–í–ê–ñ–õ–ò–í–û! –í–ò–ö–û–ù–ê–ô –í–°–Ü –ö–†–û–ö–ò –ü–û–°–õ–Ü–î–û–í–ù–û:

–ö–†–û–ö 1: –°–§–û–†–ú–£–ô –í–Ü–î–ü–û–í–Ü–î–¨
- –í–∏–∫–æ—Ä–∏—Å—Ç–∞–π —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –∑ –±–∞–∑–∏ –∑–Ω–∞–Ω—å –ø—Ä–æ –•–î–£ (–∑–Ω–∏–∑—É)
- –í—ñ–¥–ø–æ–≤—ñ–¥—å –º–∞—î –±—É—Ç–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–≤–∞–Ω–æ—é (2-4 —Ä–µ—á–µ–Ω–Ω—è)
- –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ñ –¥–∞–Ω—ñ: –∫–æ–¥–∏, –≤–∞—Ä—Ç—ñ—Å—Ç—å, –∫–æ–Ω—Ç–∞–∫—Ç–∏

–ö–†–û–ö 2: –°–ê–ú–û–ü–ï–†–ï–í–Ü–†–ö–ê –ü–ï–†–ï–î –í–Ü–î–ü–†–ê–í–ö–û–Æ (–û–ë–û–í'–Ø–ó–ö–û–í–û!)
–ü–ï–†–ï–î –¢–ò–ú –Ø–ö –í–Ü–î–ü–†–ê–í–ò–¢–ò –í–Ü–î–ü–û–í–Ü–î–¨, –ü–†–û–ß–ò–¢–ê–ô –á–á –£–í–ê–ñ–ù–û –¢–ê –ü–ï–†–ï–í–Ü–†:

‚úÖ –ü–ï–†–ï–í–Ü–†–ö–ê 1: –ß–∏ –Ω–µ–º–∞—î –∑–∞–±–æ—Ä–æ–Ω–µ–Ω–∏—Ö —É–Ω—ñ–≤–µ—Ä—Å–∏—Ç–µ—Ç—ñ–≤?
   - –ü—Ä–æ—á–∏—Ç–∞–π —Å–≤–æ—é –≤—ñ–¥–ø–æ–≤—ñ–¥—å —Å–ª–æ–≤–æ –∑–∞ —Å–ª–æ–≤–æ–º
   - –ß–∏ –Ω–µ–º–∞—î: "–•–ù–¢–£", "–Ü–≤–∞–Ω–∞ –°—ñ–∫–æ—Ä—Å—å–∫–æ–≥–æ", "–°—ñ–∫–æ—Ä—Å—å–∫–æ–≥–æ", "–•–∞—Ä–∫—ñ–≤—Å—å–∫–∏–π", "–•–ù–£", "–ö–∏—ó–≤—Å—å–∫–∏–π", "–ö–ù–£", "–õ—å–≤—ñ–≤—Å—å–∫–∏–π", "–û–¥–µ—Å—å–∫–∏–π", "–ë—ñ–ª–æ—Å—Ç–æ–∫", "–ú—ñ—Ü–∫–µ–≤–∏—á"?
   - –Ø–∫—â–æ –Ñ —Ö–æ—á–∞ –± –æ–¥–Ω–∞ –∑–≥–∞–¥–∫–∞ ‚Üí –¶–ï –ü–û–ú–ò–õ–ö–ê! –í–ò–ü–†–ê–í –ù–ï–ú–ò–¢–¢–Ñ–í–û!

‚úÖ –ü–ï–†–ï–í–Ü–†–ö–ê 2: –ß–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–∞ –æ—Ä—Ñ–æ–≥—Ä–∞—Ñ—ñ—è?
   - –ß–∏ –≤—Å—ñ —Å–ª–æ–≤–∞ —É–∫—Ä–∞—ó–Ω—Å—å–∫–æ—é? (–ù–Ü —Ä–æ—Å—ñ–π—Å—å–∫–∏—Ö, –ù–Ü –∞–Ω–≥–ª—ñ–π—Å—å–∫–∏—Ö)
   - –ß–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ: "–ó–ù–û", "–•–î–£", "—Ç–∏—Å—è—á", "–≥—Ä–∏–≤–µ–Ω—å"?

‚úÖ –ü–ï–†–ï–í–Ü–†–ö–ê 3: –ß–∏ —Ç—ñ–ª—å–∫–∏ –∑ –±–∞–∑–∏ –∑–Ω–∞–Ω—å?
   - –ß–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–æ –¢–Ü–õ–¨–ö–ò —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –∑ –±–∞–∑–∏ –∑–Ω–∞–Ω—å? (–ù–ï –∑ —ñ–Ω—Ç–µ—Ä–Ω–µ—Ç—É, –ù–ï –∑ –≤–ª–∞—Å–Ω–∏—Ö –∑–Ω–∞–Ω—å)

‚úÖ –ü–ï–†–ï–í–Ü–†–ö–ê 4: –ß–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–≤–∞–Ω–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—å?
   - –ß–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥—å —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–≤–∞–Ω–∞? (2-4 —Ä–µ—á–µ–Ω–Ω—è, –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ñ –¥–∞–Ω—ñ)
   - –ß–∏ –Ω–µ–º–∞—î —Ç–µ—Ö–Ω—ñ—á–Ω–∏—Ö —Ñ—Ä–∞–∑? ("–Ø —Ä–æ–∑—É–º—ñ—é", "–Ø —Å–ø—Ä–æ–±—É—é" —Ç–æ—â–æ)

–ö–†–û–ö 3: –Ø–ö–©–û –ó–ù–ê–ô–®–û–í –ü–û–ú–ò–õ–ö–ò
- –ù–ï–ú–ò–¢–¢–Ñ–í–û –≤–∏–ø—Ä–∞–≤ –ø–æ–º–∏–ª–∫–∏
- –°—Ñ–æ—Ä–º—É–π –≤—ñ–¥–ø–æ–≤—ñ–¥—å –∑–Ω–æ–≤—É
- –í–∏–∫–æ–Ω–∞–π –ø–µ—Ä–µ–≤—ñ—Ä–∫—É —â–µ —Ä–∞–∑

–ö–†–û–ö 4: –í–Ü–î–ü–†–ê–í–ö–ê
- –í—ñ–¥–ø—Ä–∞–≤–ª—è–π –≤—ñ–¥–ø–æ–≤—ñ–¥—å –¢–Ü–õ–¨–ö–ò –ø—ñ—Å–ª—è —É—Å–ø—ñ—à–Ω–æ—ó –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏
- –í—ñ–¥–ø–æ–≤—ñ–¥—å –º–∞—î –±—É—Ç–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–≤–∞–Ω–æ—é, –∫–æ—Ä–æ—Ç–∫–æ—é, —Ç–æ—á–Ω–æ—é

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

–í–Ü–î–ü–û–í–Ü–î–¨ (–ø—ñ—Å–ª—è —Å–∞–º–æ–ø–µ—Ä–µ–≤—ñ—Ä–∫–∏, —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–≤–∞–Ω–∞, —Ç—ñ–ª—å–∫–∏ –ø—Ä–æ –•–î–£):"""
            

            async def _generate_narrow_admission(session):
                admission_ctx = self.knowledge_service.get_admission_2026_context()
                narrow_system_prompt = self._get_optimized_system_prompt(admission_ctx)
                narrow_prompt = f"""{narrow_system_prompt}

–ü–ò–¢–ê–ù–ù–Ø: {prompt}

–¢—ñ–ª—å–∫–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π –Ω–∞–≤–µ–¥–µ–Ω–∏–π JSON –ø—Ä–æ –≤—Å—Ç—É–ø-2026. –Ø–∫—â–æ –≤ –Ω—å–æ–º—É –Ω–µ–º–∞—î –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ ‚Äî —á–µ—Å–Ω–æ —Å–∫–∞–∂–∏, —â–æ –¥–∞–Ω–∏—Ö –Ω–µ–º–∞—î, —ñ –ø–æ—Ä–∞–¥—å –∑–≤–µ—Ä–Ω—É—Ç–∏—Å—è –¥–æ –ø—Ä–∏–π–º–∞–ª—å–Ω–æ—ó –∫–æ–º—ñ—Å—ñ—ó –•–î–£ –∑–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–æ–º +380 552 494375.

–í–Ü–î–ü–û–í–Ü–î–¨:"""
                payload_narrow = {
                    "model": self.model,
                    "prompt": narrow_prompt,
                    "stream": False,
                    "options": {
                        "temperature": 0.0,
                        "top_p": 0.3,
                        "num_predict": 400,
                        "repeat_penalty": 1.4,
                        "top_k": 20,
                    }
                }
                async with session.post(
                    f"{self.api_url}/api/generate",
                    json=payload_narrow,
                    timeout=aiohttp.ClientTimeout(total=45)
                ) as resp2:
                    if resp2.status == 200:
                        data2 = await resp2.json()
                        ans2 = data2.get("response", "").strip()
                        if ans2:
                            val2 = self.response_validator.validate(ans2)
                            if val2.is_valid:
                                # region agent log
                                _agent_log(
                                    hypothesis_id="H4",
                                    location="ollama_client.py:_generate_narrow_admission:success",
                                    message="narrow admission valid",
                                    data={"answer_preview": ans2[:200]}
                                )
                                # endregion
                                return ans2[:3500] if len(ans2) > 3500 else ans2
                        # region agent log
                        _agent_log(
                            hypothesis_id="H4",
                            location="ollama_client.py:_generate_narrow_admission:fail",
                            message="narrow admission invalid/empty",
                            data={"status": resp2.status, "ans_preview": (ans2[:200] if ans2 else "")}
                        )
                        # endregion
                return None

            for attempt in range(max_retries):
                # –ó–∞–ø–∏—Ç –¥–æ OLLAMA
                async with aiohttp.ClientSession() as session:
                    payload = {
                        "model": self.model,
                        "prompt": full_prompt,
                        "stream": False,
                        "options": {
                            "temperature": 0.0,  # –î–µ—Ç–µ—Ä–º—ñ–Ω–æ–≤–∞–Ω–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—å
                            "top_p": 0.3,  # –ë—ñ–ª—å—à –ø–æ—Å–ª—É—Ö–Ω—è–Ω–∞
                            "num_predict": 500,
                            "repeat_penalty": 1.4,
                            "top_k": 20,  # –û–±–º–µ–∂–µ–Ω–∏–π –≤–∏–±—ñ—Ä
                        }
                    }
                    
                    async with session.post(
                        f"{self.api_url}/api/generate",
                        json=payload,
                        timeout=aiohttp.ClientTimeout(total=60)
                    ) as response:
                        if response.status == 200:
                            data = await response.json()
                            answer = data.get("response", "").strip()
                            
                            if not answer:
                                continue
                            
                            # region agent log
                            _agent_log(
                                hypothesis_id="H2",
                                location="ollama_client.py:generate_response:model_answer",
                                message="model raw answer",
                                data={"answer_preview": answer[:200]}
                            )
                            # endregion
                            
                            # –í–∞–ª—ñ–¥–∞—Ü—ñ—è –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ (–ö–†–ò–¢–ò–ß–ù–û –í–ê–ñ–õ–ò–í–û!)
                            validation_result = self.response_validator.validate(answer)
                            is_valid = validation_result.is_valid
                            error_msg = validation_result.error_message
                            # region agent log
                            _agent_log(
                                hypothesis_id="H3",
                                location="ollama_client.py:generate_response:validation",
                                message="validation result",
                                data={"is_valid": is_valid, "error": error_msg}
                            )
                            # endregion
                            
                            if is_valid:
                                # –î–æ–¥–∞—Ç–∫–æ–≤–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –¥–ª—è –≤—Å—Ç—É–ø-2026: –≤—ñ–¥–ø–æ–≤—ñ–¥—å –º–∞—î –º—ñ—Å—Ç–∏—Ç–∏ –∫–ª—é—á–æ–≤—ñ –º–∞—Ä–∫–µ—Ä–∏ —Ç–µ–º–∏
                                if is_admission_question:
                                    if not any(m in answer.lower() for m in admission_markers):
                                        regen = await _generate_narrow_admission(session)
                                        # region agent log
                                        _agent_log(
                                            hypothesis_id="H4",
                                            location="ollama_client.py:generate_response:marker_missing",
                                            message="missing admission markers, regen",
                                            data={"trigger": "no_markers", "answer_preview": answer[:150]}
                                        )
                                        # endregion
                                        if regen:
                                            return regen
                                # –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞ –Ω–µ–≤—ñ–¥–ø–æ–≤—ñ–¥–Ω—ñ—Å—Ç—å —Ç–µ–º—ñ –≤—Å—Ç—É–ø-2026 (–º–æ–¥–µ–ª—å –ø—ñ—à–ª–∞ –≤ "–¥–æ–∫—É–º–µ–Ω—Ç–∏")
                                if is_admission_question:
                                    bad_admission = ("–¥–æ–∫—É–º–µ–Ω—Ç" in answer.lower()) and not any(
                                        kw in answer.lower() for kw in ["–Ω–º—Ç", "—Ç—Ä–∞—î–∫—Ç–æ—Ä", "–∫–∞–º–ø–∞–Ω", "–µ–ª–µ–∫—Ç—Ä–æ–Ω–Ω", "ksu24", "–∫—Å—É24"]
                                    )
                                    if bad_admission:
                                        regen = await _generate_narrow_admission(session)
                                        # region agent log
                                        _agent_log(
                                            hypothesis_id="H4",
                                            location="ollama_client.py:generate_response:bad_admission",
                                            message="regen due to document drift",
                                            data={"answer_preview": answer[:150]}
                                        )
                                        # endregion
                                        if regen:
                                            # –Ø–∫—â–æ —Ä–µ–≥–µ–Ω, –∞–ª–µ –±–µ–∑ –º–∞—Ä–∫–µ—Ä—ñ–≤ ‚Äî –ø–∞–¥–∞—î–º–æ —É –¥–µ—Ç–µ—Ä–º—ñ–Ω–æ–≤–∞–Ω–∏–π fallback
                                            if is_admission_question and not any(m in regen.lower() for m in admission_markers):
                                                fb = _admission_fallback()
                                                _agent_log(
                                                    hypothesis_id="H6",
                                                    location="ollama_client.py:generate_response:fallback_after_regen_nomarkers",
                                                    message="fallback admission after regen missing markers",
                                                    data={"answer_preview": regen[:150]}
                                                )
                                                return fb
                                            return regen
                                # –û–±–º–µ–∂—É—î–º–æ –¥–æ–≤–∂–∏–Ω—É
                                if len(answer) > 3500:
                                    answer = answer[:3500] + "\n\n... (–≤—ñ–¥–ø–æ–≤—ñ–¥—å –æ–±—Ä—ñ–∑–∞–Ω–∞)"
                                # region agent log
                                _agent_log(
                                    hypothesis_id="H5",
                                    location="ollama_client.py:generate_response:return_valid",
                                    message="returning valid answer",
                                    data={"answer_preview": answer[:200]}
                                )
                                # endregion
                                # –î–ª—è –≤—Å—Ç—É–ø-2026 —Ä–æ–±–∏–º–æ –æ—Å—Ç–∞—Ç–æ—á–Ω—É –ø–µ—Ä–µ–≤—ñ—Ä–∫—É –º–∞—Ä–∫–µ—Ä—ñ–≤; —è–∫—â–æ –Ω–µ–º–∞ ‚Äî –¥–µ—Ç–µ—Ä–º—ñ–Ω–æ–≤–∞–Ω–∏–π fallback
                                if is_admission_question and not any(m in answer.lower() for m in admission_markers):
                                    fb = _admission_fallback()
                                    _agent_log(
                                        hypothesis_id="H6",
                                        location="ollama_client.py:generate_response:fallback_nomarkers",
                                        message="fallback admission missing markers",
                                        data={"answer_preview": answer[:150]}
                                    )
                                    return fb
                                return answer
                            else:
                                # –Ø–∫—â–æ –ø–æ–º–∏–ª–∫–∞ - —Ä–µ–≥–µ–Ω–µ—Ä—É—î–º–æ –∑ –î–£–ñ–ï –°–£–í–û–†–ò–ú–ò —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—è–º–∏
                                # –õ–æ–≥—É—î–º–æ –ø–æ–º–∏–ª–∫–∏ –¥–ª—è –¥—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
                                if error_msg:
                                    print(f"[VALIDATION] –ü–æ–º–∏–ª–∫–∏: {error_msg}")
                                if attempt < max_retries - 1:
                                    full_prompt = f"""{system_prompt}

–ü–ò–¢–ê–ù–ù–Ø: {prompt}

üö´üö´üö´ –ö–†–ò–¢–ò–ß–ù–ê –ü–û–ú–ò–õ–ö–ê –í –ü–û–ü–ï–†–ï–î–ù–Ü–ô –í–Ü–î–ü–û–í–Ü–î–Ü: {error_msg} üö´üö´üö´

–¢–ò –ó–ì–ê–î–ê–í –ó–ê–ë–û–†–û–ù–ï–ù–ò–ô –£–ù–Ü–í–ï–†–°–ò–¢–ï–¢! –¶–ï –°–£–í–û–†–û –ó–ê–ë–û–†–û–ù–ï–ù–û!

–û–ë–û–í'–Ø–ó–ö–û–í–û:
1. –í—ñ–¥–ø–æ–≤—ñ–¥–∞–π –¢–Ü–õ–¨–ö–ò –ø—Ä–æ –•–î–£ (–•–µ—Ä—Å–æ–Ω—Å—å–∫–∏–π –¥–µ—Ä–∂–∞–≤–Ω–∏–π —É–Ω—ñ–≤–µ—Ä—Å–∏—Ç–µ—Ç)
2. –ù–Ü–ö–û–õ–ò –Ω–µ –∑–≥–∞–¥—É–π —ñ–Ω—à—ñ —É–Ω—ñ–≤–µ—Ä—Å–∏—Ç–µ—Ç–∏ (–•–ù–¢–£, –•–ù–£, –ö–ù–£, –õ—å–≤—ñ–≤—Å—å–∫–∏–π, –û–¥–µ—Å—å–∫–∏–π, –ë—ñ–ª–æ—Å—Ç–æ–∫, –ú—ñ—Ü–∫–µ–≤–∏—á —Ç–æ—â–æ)
3. –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π –¢–Ü–õ–¨–ö–ò —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –∑ –±–∞–∑–∏ –∑–Ω–∞–Ω—å –ø—Ä–æ –•–î–£
4. –Ø–∫—â–æ –ø–∏—Ç–∞—é—Ç—å –ø—Ä–æ –ø—Ä–æ–≥—Ä–∞–º—É–≤–∞–Ω–Ω—è - –≤—ñ–¥–ø–æ–≤—ñ–¥–∞–π –ø—Ä–æ –Ü–¢ —Å–ø–µ—Ü—ñ–∞–ª—å–Ω–æ—Å—Ç—ñ –•–î–£: F2, F3, F6 (–∫–æ–¥ 121)

–í–Ü–î–ü–û–í–Ü–î–¨ (–¢–Ü–õ–¨–ö–ò –ü–†–û –•–î–£, –ë–ï–ó –Ü–ù–®–ò–• –£–ù–Ü–í–ï–†–°–ò–¢–ï–¢–Ü–í!):"""
                                    continue
                                else:
                                    # –û—Å—Ç–∞–Ω–Ω—è —Å–ø—Ä–æ–±–∞
                                    if is_admission_question:
                                        # –†–æ–±–∏–º–æ –¥–æ–¥–∞—Ç–∫–æ–≤—É —Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü—ñ—é –∑ –≤—É–∑—å–∫–∏–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º –ª–∏—à–µ –ø–æ –≤—Å—Ç—É–ø—É-2026
                                        regen = await _generate_narrow_admission(session)
                                        if regen:
                                            # –Ø–∫—â–æ –ø—ñ—Å–ª—è —Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó –Ω–µ–º–∞—î –º–∞—Ä–∫–µ—Ä—ñ–≤ ‚Äî –¥–µ—Ç–µ—Ä–º—ñ–Ω–æ–≤–∞–Ω–∏–π fallback
                                            if not any(m in regen.lower() for m in admission_markers):
                                                fb = _admission_fallback()
                                                _agent_log(
                                                    hypothesis_id="H6",
                                                    location="ollama_client.py:generate_response:fallback_after_regen_nomarkers_last_try",
                                                    message="fallback admission missing markers after last try",
                                                    data={"answer_preview": regen[:150]}
                                                )
                                                return fb
                                            return regen
                                        # –Ø–∫—â–æ —Ä–µ–≥–µ–Ω –Ω–µ –¥–∞–≤ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ ‚Äî –¥–µ—Ç–µ—Ä–º—ñ–Ω–æ–≤–∞–Ω–∏–π fallback –ø–æ –≤—Å—Ç—É–ø—É
                                        fb = _admission_fallback()
                                        _agent_log(
                                            hypothesis_id="H6",
                                            location="ollama_client.py:generate_response:fallback_last_try_no_regen",
                                            message="fallback admission no regen result",
                                            data={}
                                        )
                                        return fb
                                    # –û—Å—Ç–∞–Ω–Ω—ñ–π fallback ‚Äî –∫–æ—Ä–æ—Ç–∫—ñ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ñ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ
                                    prompt_lower = prompt.lower()
                                    if any(word in prompt_lower for word in ["–ø—Ä–æ–≥—Ä–∞–º—É–≤–∞–Ω–Ω—è", "–ø—Ä–æ–≥—Ä–∞–º—ñ—Å—Ç", "—ñ—Ç", "—ñ–Ω—Ñ–æ—Ä–º–∞—Ç–∏–∫–∞", "–∫–æ–º–ø'—é—Ç–µ—Ä", "121", "f6", "f2", "f3"]):
                                        return "–í –•–î–£ —î —Ç–∞–∫—ñ —Å–ø–µ—Ü—ñ–∞–ª—å–Ω–æ—Å—Ç—ñ –∑ –ø—Ä–æ–≥—Ä–∞–º—É–≤–∞–Ω–Ω—è —Ç–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ–π–Ω–∏—Ö —Ç–µ—Ö–Ω–æ–ª–æ–≥—ñ–π: –Ü–Ω–∂–µ–Ω–µ—Ä—ñ—è –ø—Ä–æ–≥—Ä–∞–º–Ω–æ–≥–æ –∑–∞–±–µ–∑–ø–µ—á–µ–Ω–Ω—è (F2), –ö–æ–º–ø'—é—Ç–µ—Ä–Ω—ñ –Ω–∞—É–∫–∏ (F3), –Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ–π–Ω—ñ —Å–∏—Å—Ç–µ–º–∏ —Ç–∞ —Ç–µ—Ö–Ω–æ–ª–æ–≥—ñ—ó (F6, –∫–æ–¥ 121). –î–µ—Ç–∞–ª—å–Ω—ñ—à–µ: +380 552 494375 üíª"
                                    elif any(word in prompt_lower for word in ["–º–µ–¥–∏—Ü–∏–Ω–∞", "–º–µ–¥–∏—á–Ω—ñ", "–ª—ñ–∫–∞—Ä"]):
                                        return "–í –•–î–£ —î —Ç–∞–∫—ñ —Å–ø–µ—Ü—ñ–∞–ª—å–Ω–æ—Å—Ç—ñ –∑ –æ—Ö–æ—Ä–æ–Ω–∏ –∑–¥–æ—Ä–æ–≤'—è: –§—ñ–∑–∏—á–Ω–∞ —Ç–µ—Ä–∞–ø—ñ—è, –µ—Ä–≥–æ—Ç–µ—Ä–∞–ø—ñ—è (–±–∞–∫–∞–ª–∞–≤—Ä), –°–æ—Ü—ñ–∞–ª—å–Ω–∞ —Ä–æ–±–æ—Ç–∞ —Ç–∞ –∫–æ–Ω—Å—É–ª—å—Ç—É–≤–∞–Ω–Ω—è (–±–∞–∫–∞–ª–∞–≤—Ä), –ú–µ–¥–∏—Ü–∏–Ω–∞ (–º–∞–≥—ñ—Å—Ç—Ä), –§—ñ–∑–∏—á–Ω–∞ —Ä–µ–∞–±—ñ–ª—ñ—Ç–∞—Ü—ñ—è (–º–∞–≥—ñ—Å—Ç—Ä), –§–∞—Ä–º–∞—Ü—ñ—è (–º–∞–≥—ñ—Å—Ç—Ä). –î–µ—Ç–∞–ª—å–Ω—ñ—à–µ: +380 552 494375 üè•"
                                    else:
                                        return ("–ù–∞ –∂–∞–ª—å, –Ω–µ –≤–¥–∞–ª–æ—Å—è —Å—Ñ–æ—Ä–º—É–≤–∞—Ç–∏ –∫–æ—Ä–µ–∫—Ç–Ω—É –≤—ñ–¥–ø–æ–≤—ñ–¥—å. "
                                                "–ó–≤–µ—Ä–Ω–∏—Å—è –¥–æ –ø—Ä–∏–π–º–∞–ª—å–Ω–æ—ó –∫–æ–º—ñ—Å—ñ—ó –•–î–£ –∑–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–æ–º +380 552 494375 –¥–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –∞–∫—Ç—É–∞–ª—å–Ω–æ—ó —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó.")
                        else:
                            return f"–ü–æ–º–∏–ª–∫–∞ API: {response.status}"
            
            if is_admission_question:
                fb = _admission_fallback()
                _agent_log(
                    hypothesis_id="H6",
                    location="ollama_client.py:generate_response:fallback_after_loop",
                    message="fallback admission after loop",
                    data={}
                )
                return fb
            return "–í–∏–±–∞—á, –Ω–µ –≤–¥–∞–ª–æ—Å—è –æ—Ç—Ä–∏–º–∞—Ç–∏ –∫–æ—Ä–µ–∫—Ç–Ω—É –≤—ñ–¥–ø–æ–≤—ñ–¥—å. –°–ø—Ä–æ–±—É–π –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª—é–≤–∞—Ç–∏ –ø–∏—Ç–∞–Ω–Ω—è –∞–±–æ –∑–≤–µ—Ä–Ω–∏—Å—è –¥–æ –ø—Ä–∏–π–º–∞–ª—å–Ω–æ—ó –∫–æ–º—ñ—Å—ñ—ó –•–î–£ –∑–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–æ–º +380 552 494375"
            
        except Exception as e:
            return f"–í–∏–±–∞—á, —Å—Ç–∞–ª–∞—Å—è –ø–æ–º–∏–ª–∫–∞: {str(e)}. –ó–≤–µ—Ä–Ω–∏—Å—è –¥–æ –ø—Ä–∏–π–º–∞–ª—å–Ω–æ—ó –∫–æ–º—ñ—Å—ñ—ó –•–î–£ –∑–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–æ–º +380 552 494375"

    async def check_health(self) -> bool:
        """–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—ñ OLLAMA"""
        try:
            async with aiohttp.ClientSession() as session:
                async with session.get(
                    f"{self.api_url}/api/tags",
                    timeout=aiohttp.ClientTimeout(total=5)
                ) as response:
                    return response.status == 200
        except:
            return False

    async def get_personal_advice(self, specialization: str) -> str:
        """
        –û—Ç—Ä–∏–º–∞–Ω–Ω—è –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∏—Ö –ø–æ—Ä–∞–¥ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ—ó —Å–ø–µ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó
        """
        knu_info = self.knowledge_service.get_knowledge_base()
        system_prompt = self._get_optimized_system_prompt(knu_info)
        
        prompt = f"""–ù–∞–¥–∞–π –î–£–ñ–ï –ö–û–†–û–¢–ö–Ü —Ç–∞ –ö–û–ù–ö–†–ï–¢–ù–Ü –ø–æ—Ä–∞–¥–∏ —â–æ–¥–æ –≤—Å—Ç—É–ø—É –¥–æ –•–î–£ –¥–ª—è —Å–ø–µ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó: {specialization}.

–í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π –¢–Ü–õ–¨–ö–ò —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –∑ –±–∞–∑–∏ –∑–Ω–∞–Ω—å –∑–Ω–∏–∑—É. –Ø–∫—â–æ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó –ø—Ä–æ —Å–ø–µ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—é {specialization} –Ω–µ–º–∞—î - —Å–∫–∞–∂–∏ —á–µ—Å–Ω–æ —Ç–∞ –∑–∞–ø—Ä–æ–ø–æ–Ω—É–π –∑–≤–µ—Ä–Ω—É—Ç–∏—Å—è –¥–æ –ø—Ä–∏–π–º–∞–ª—å–Ω–æ—ó –∫–æ–º—ñ—Å—ñ—ó: +380 552 494375"""
        
        full_prompt = f"""{system_prompt}

–ü–ò–¢–ê–ù–ù–Ø: {prompt}

–í–Ü–î–ü–û–í–Ü–î–¨:"""
        
        async with aiohttp.ClientSession() as session:
            payload = {
                "model": self.model,
                "prompt": full_prompt,
                "stream": False,
                "options": {
                    "temperature": 0.0,
                    "top_p": 0.3,
                    "num_predict": 300,
                    "repeat_penalty": 1.4,
                    "top_k": 20,
                }
            }
            
            async with session.post(
                f"{self.api_url}/api/generate",
                json=payload,
                timeout=aiohttp.ClientTimeout(total=60)
            ) as response:
                if response.status == 200:
                    data = await response.json()
                    return data.get("response", "").strip()
                else:
                    return "–î–ª—è —É—Ç–æ—á–Ω–µ–Ω–Ω—è —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó –∑–≤–µ—Ä–Ω–∏—Å—è –¥–æ –ø—Ä–∏–π–º–∞–ª—å–Ω–æ—ó –∫–æ–º—ñ—Å—ñ—ó –•–î–£ –∑–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–æ–º +380 552 494375"


# –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –æ–ø—Ç–∏–º—ñ–∑–æ–≤–∞–Ω–∏–π –∫–ª—ñ—î–Ω—Ç
# –°—Ç–∞—Ä–∏–π –∫–ª–∞—Å OllamaClient –∑–∞–ª–∏—à–∞—î—Ç—å—Å—è –¥–ª—è –∑–≤–æ—Ä–æ—Ç–Ω–æ—ó —Å—É–º—ñ—Å–Ω–æ—Å—Ç—ñ
# –ê–ª–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –Ω–æ–≤–∏–π OptimizedOllamaClient
_optimized_client = None

def _get_optimized_client():
    """–û—Ç—Ä–∏–º–∞–Ω–Ω—è –æ–ø—Ç–∏–º—ñ–∑–æ–≤–∞–Ω–æ–≥–æ –∫–ª—ñ—î–Ω—Ç–∞ (singleton)"""
    global _optimized_client
    if _optimized_client is None:
        _optimized_client = OptimizedOllamaClient()
    return _optimized_client

# –û–±–≥–æ—Ä—Ç–∫–∞ –¥–ª—è –∑–≤–æ—Ä–æ—Ç–Ω–æ—ó —Å—É–º—ñ—Å–Ω–æ—Å—Ç—ñ
class OllamaClient:
    """–û–±–≥–æ—Ä—Ç–∫–∞ –¥–ª—è –∑–≤–æ—Ä–æ—Ç–Ω–æ—ó —Å—É–º—ñ—Å–Ω–æ—Å—Ç—ñ - –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î –æ–ø—Ç–∏–º—ñ–∑–æ–≤–∞–Ω–∏–π –∫–ª—ñ—î–Ω—Ç"""
    
    def __init__(self):
        self._client = _get_optimized_client()
        # –ó–±–µ—Ä—ñ–≥–∞—î–º–æ —Å—Ç–∞—Ä—ñ –∞—Ç—Ä–∏–±—É—Ç–∏ –¥–ª—è —Å—É–º—ñ—Å–Ω–æ—Å—Ç—ñ
        self.api_url = OLLAMA_API_URL
        self.model = OLLAMA_MODEL
        self.knowledge_service = KnowledgeService()
        self.response_validator = ResponseValidator()
    
    async def generate_response(self, prompt: str, context: list = None) -> str:
        """–ì–µ–Ω–µ—Ä–∞—Ü—ñ—è –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ —á–µ—Ä–µ–∑ –æ–ø—Ç–∏–º—ñ–∑–æ–≤–∞–Ω–∏–π –∫–ª—ñ—î–Ω—Ç"""
        return await self._client.generate_response(prompt, context, use_cache=True)
    
    async def generate_response_stream(self, prompt: str, context: list = None):
        """Streaming –≥–µ–Ω–µ—Ä–∞—Ü—ñ—è –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ - –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –±–∞—á–∏—Ç—å –≤—ñ–¥–ø–æ–≤—ñ–¥—å –ø–æ —á–∞—Å—Ç–∏–Ω–∞—Ö"""
        async for chunk in self._client.generate_response_stream(prompt, context, use_cache=True):
            yield chunk
    
    async def generate_response_parallel(self, prompt: str, context: list = None, num_candidates: int = 3) -> str:
        """–ü–∞—Ä–∞–ª–µ–ª—å–Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü—ñ—è –∫—ñ–ª—å–∫–æ—Ö –≤–∞—Ä—ñ–∞–Ω—Ç—ñ–≤ —Ç–∞ –≤–∏–±—ñ—Ä –Ω–∞–π–∫—Ä–∞—â–æ–≥–æ"""
        return await self._client.generate_response_parallel(
            prompt, context, num_candidates=num_candidates, use_cache=True
        )
    
    async def check_health(self) -> bool:
        """–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—ñ OLLAMA"""
        return await self._client.check_health()
    
    async def get_personal_advice(self, specialization: str) -> str:
        """–û—Ç—Ä–∏–º–∞–Ω–Ω—è –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∏—Ö –ø–æ—Ä–∞–¥ (–∑–≤–æ—Ä–æ—Ç–Ω–∞ —Å—É–º—ñ—Å–Ω—ñ—Å—Ç—å)"""
        query = f"–ù–∞–¥–∞–π –ø–æ—Ä–∞–¥–∏ —â–æ–¥–æ –≤—Å—Ç—É–ø—É –¥–æ –•–î–£ –¥–ª—è —Å–ø–µ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó: {specialization}"
        return await self._client.generate_response(query, use_cache=True)
    
    def get_statistics(self):
        """–û—Ç—Ä–∏–º–∞–Ω–Ω—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏"""
        return self._client.get_statistics()
    
    def get_cache_stats(self):
        """–û—Ç—Ä–∏–º–∞–Ω–Ω—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∫–µ—à—É"""
        return self._client.get_cache_stats()

# –ì–ª–æ–±–∞–ª—å–Ω–∏–π –µ–∫–∑–µ–º–ø–ª—è—Ä (–≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î –æ–ø—Ç–∏–º—ñ–∑–æ–≤–∞–Ω–∏–π –∫–ª—ñ—î–Ω—Ç)
ollama = OllamaClient()

